<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="cccs7">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/02/12/redis/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2023/02/12/Redis/index.html">
<meta property="og:site_name" content="cccs7&#39;s blog">
<meta property="og:description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/redefine-og.webp">
<meta property="article:published_time" content="2023-02-12T09:30:22.000Z">
<meta property="article:modified_time" content="2024-09-13T03:07:59.000Z">
<meta property="article:author" content="cccs7 - csq020611@gmail.com">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="中间件">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="NoSQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/redefine-og.webp">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            Redis | cccs7&#39;s blog
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
        <link href="" rel="stylesheet">
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":"enable","family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":{"enable":true,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"cccs7's blog","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"11.4.1"}},"version":"2.8.2","navbar":{"auto_hide":"enable","color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Github":"https://github.com/EvanNotFound/hexo-theme-redefine","Blog":"https://ohevan.com"}}},"search":{"enable":"enable","preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                cccs7&#39;s blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    ABOUT
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a href="/about">
                                                    ME
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://github.com/EvanNotFound/hexo-theme-redefine">
                                                    GITHUB
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://ohevan.com">
                                                    BLOG
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-About"
                        >
                            <span>
                                ABOUT
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-About">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/about">ME</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://github.com/EvanNotFound/hexo-theme-redefine">GITHUB</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://ohevan.com">BLOG</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">53</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">75</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">71</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Redis</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/redefine-avatar.svg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">cccs7</span>
					
					<span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv5</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-02-12 17:30:22</span>
        <span class="mobile">2023-02-12 17:30:22</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-09-13 11:07:59</span>
            <span class="mobile">2024-09-13 11:07:59</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Java/">Java</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/Java/Redis/">Redis</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/">Redis</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/NoSQL/">NoSQL</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/NoSQL/Redis/">Redis</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Java/">Java</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Redis/">Redis</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/NoSQL/">NoSQL</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<p>#Redis</p>
<p>版本： Redis 6</p>
<br>

<h2 id="Redis-介绍"><a href="#Redis-介绍" class="headerlink" title="Redis 介绍"></a>Redis 介绍</h2><p>Redis (REmote Dictionary Server) 远程字典服务器 是完全开源的，使用 ANSIC 语言编写遵守 BSD 协议，是一个高性能的 Key - Value 数据库，提供了丰富的数据结构，如 String、Hash、List、SortedSet 等等。数据是存在内存中的，同时 Redis 支持事务、持久化、LUA 脚本、发布&#x2F;订阅、缓存淘汰、流技术等多种功能特性提供了 主从模式、Redis Sentinel 和 Redis Cluster 集群架构方案</p>
<h3 id="主流功能与应用"><a href="#主流功能与应用" class="headerlink" title="主流功能与应用"></a>主流功能与应用</h3><hr>
<ul>
<li><p><strong><font color='red'>分布式缓存，挡在 MySQL 数据库之前的带刀侍卫</font></strong></p>
<ul>
<li>与 传统关系型数据库 （MySQL）相比，Redis 是 key - value 数据库（NoSQL 的一种），MySQL 是关系型数据库。</li>
<li>Redis 操作主要在 内存，而 MySQL 主要存储在 <strong><font color='red'>磁盘</font></strong></li>
<li>Redis 在某一些场景使用中明显要优于 MySQL，比如计数器、排行榜等方面</li>
<li>Redis 通常用于一些特定的场景，需要与 MySQL 一起配合使用</li>
<li><strong><font color='red'>两者并不是相互替换和竞争关系，而是共用和配合使用</font></strong></li>
</ul>
</li>
<li><p>内存存储和持久化（RDB + AOF）</p>
<p>redis 支持异步将内存中的数据写到硬盘上，同时不影响继续服务</p>
</li>
<li><p>高可用架构搭配</p>
<ul>
<li>单机</li>
<li>主从</li>
<li>哨兵</li>
<li>集群</li>
</ul>
</li>
<li><p>缓存穿透、击穿、雪崩</p>
</li>
<li><p>分布式锁</p>
</li>
<li><p>队列</p>
<p>Redis  提供 list 和 set 操作，这使得 Redis 能作为一个很好的消息队列平台来使用。</p>
<p>我们常通过 Redis 的队列功能做购买限制。比如到节假日或推广期间，进行一些活动</p>
<p>对用户购买行为进行限制，限制今天只能购买几次商品或者一段时间只能购买一次。</p>
</li>
<li><p>排行版 + 点赞</p>
<ul>
<li>在互联网应用中，有各种各样的排行榜，如 电商销量排行榜。Redis 提供的 zset 数据类型能够快速实现这些复杂的排行榜</li>
<li>比如 小说网站对小说进行排名，根据排名，将排名靠前的小说推荐给用户</li>
</ul>
</li>
<li><p>…</p>
</li>
</ul>
<h3 id="总体功能概述"><a href="#总体功能概述" class="headerlink" title="总体功能概述"></a>总体功能概述</h3><hr>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230302233213537.png"
                      alt="image-20230302233213537" style="zoom: 50%;" 
                >

<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><hr>
<ul>
<li>性能极高 - Redis 能读的速度是 110000 次&#x2F;秒，写的速度是 81000 次&#x2F;秒</li>
<li>Redis 数据类型丰富，不仅仅支持简单的 key- value  类型的数据，同时还支持 list、set、zset、hash 等数据结构的存储</li>
<li>Redis  支持数据的持久化，可以将内存中的数据保持在 磁盘中，重启的时候可以再次加载进行使用</li>
<li>Redis 支持数据的备份，即 master - slave 模式的数据备份</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><hr>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230302233700886.png"
                      alt="image-20230302233700886" style="zoom:50%;" 
                >

<p><strong><font color='red'>Redis 是一种 key - value  类型的缓存数据库</font></strong></p>
<h3 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h3><hr>
<p>Redis 源码地址 ： <a class="link"   target="_blank" rel="noopener" href="https://github.com/redis/redis" >https://github.com/redis/redis<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>Redis 在线测试 ： <a class="link"   target="_blank" rel="noopener" href="https://try.redis.io/" >https://try.redis.io/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><strong><font color='red'>Redis 命令参考</font> ：<a class="link"   target="_blank" rel="noopener" href="http://doc.redisfans.com/" >http://doc.redisfans.com/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></strong></p>
<p>Redis 命令查询 ： <a class="link"   target="_blank" rel="noopener" href="http://redis.cn/commands.html" >http://redis.cn/commands.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="Redis-使用"><a href="#Redis-使用" class="headerlink" title="Redis 使用"></a>Redis 使用</h2><h3 id="Redis-的-10-大数据类型"><a href="#Redis-的-10-大数据类型" class="headerlink" title="Redis 的 10 大数据类型"></a>Redis 的 10 大数据类型</h3><hr>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230304105255396.png"
                      alt="image-20230304105255396" style="zoom:33%;" 
                >



<p><strong>这里说的数据类型是 value的数据类型，key 的数据类型都是字符串</strong></p>
<h4 id="redis-字符串-（String-）"><a href="#redis-字符串-（String-）" class="headerlink" title="redis 字符串 （String ）"></a>redis 字符串 （String ）</h4><p>String  是 redis 最基本的数据类型，一个 key 对应 一个 value</p>
<br>

<p>String 类型 是 <strong><font color='red'>二进制安全的</font></strong> ,意思是 redis 的 string 可以包含任何数据，比如 jpg 图片 或者序列化对象</p>
<p>String 类型是 Redis 最基本的数据类型，一个 redis 字符串 value 最多可以是  512 M</p>
<h4 id="redis-列表（List）"><a href="#redis-列表（List）" class="headerlink" title="redis 列表（List）"></a>redis 列表（List）</h4><p>Redis 列表是简单的字符串列表，<strong>按照插入顺序排序</strong>。你可以添加一个元素到列表的 <strong><font color='cornflowerblue'>头部（左边）或者尾部（右边）</font></strong></p>
<p>它的底层实际是一个  <strong><font color='red'>双端链表</font></strong>，最多可以包含 2 ^ 32 - 1 个 元素（4294967295 ，每个列表超过 40 亿个元素）</p>
<h4 id="redis-哈希表（Hash）"><a href="#redis-哈希表（Hash）" class="headerlink" title="redis 哈希表（Hash）"></a>redis 哈希表（Hash）</h4><p>Redis Hash 是一个String 类型的field （字段） 和 value （值） 的映射表， hash 特别适合用于存储对象</p>
<p>Redis 中每个 hash可以存储 2^32 - 1 键值对（40 多亿）</p>
<h4 id="redis-集合-（Set）"><a href="#redis-集合-（Set）" class="headerlink" title="redis 集合 （Set）"></a>redis 集合 （Set）</h4><p>Redis 的 set 是String 类型的  <strong><font color='red'>无序集合</font></strong>。集合成员是唯一的，这就意味着 集合中不能出现重复的 数据，集合对象的编码可以是 intest 或者 Hashtable</p>
<p>Redis 中 set 集合是通过 哈希表实现的，所以添加、删除、查找的复杂度 都是  O(1)</p>
<p>集合中最大的成员是 2^32-1 （每个集合可以存储 40多亿个成员）</p>
<h4 id="redis-有序集合-（ZSet-）"><a href="#redis-有序集合-（ZSet-）" class="headerlink" title="redis 有序集合 （ZSet ）"></a>redis 有序集合 （ZSet ）</h4><p>zset （sorted set：有序集合）</p>
<p>Redis zset 和 set 一样也是 String 类型元素的集合，且不允许有重复的成员</p>
<p><strong><font color='red'>不同的是每个元素都会关联一个 double 类型的分数</font></strong>，redis 正是通过 分数来为集合中的成员进行按照从小到大的排序</p>
<p><strong><font color='red'>zset 的成员是唯一的，但分数（score）却可以重复</font></strong></p>
<p><strong><font color='red'>zset 集合是通过 哈希表实现的，所以 添加、删除、查找的复杂度都是O(1)，集合中的最大成员数是  2 ^ 32 -1 个 </font></strong></p>
<h4 id="redis-地理空间（GEO）"><a href="#redis-地理空间（GEO）" class="headerlink" title="redis 地理空间（GEO）"></a>redis 地理空间（GEO）</h4><p>Redis GEO 主要用于存储地理位置信息，并对存储的信息进行操作，包括</p>
<ul>
<li>添加地理位置的坐标</li>
<li>获取地理位置的坐标</li>
<li>计算两个位置之间的距离</li>
<li>根据用户给定的经纬度坐标来获取指定范围内的地理位置集合</li>
</ul>
<h4 id="redis-基数统计（HyperLogLog）"><a href="#redis-基数统计（HyperLogLog）" class="headerlink" title="redis 基数统计（HyperLogLog）"></a>redis 基数统计（HyperLogLog）</h4><p>HyperLogLog 是用来做 <strong><font color='red'>基数统计</font></strong> 的算法，HyperLogLog 的优点是，在输入元素的数量或者体积特别大时，计算基数所需的空间总是固定且是非常小的</p>
<p>在 redis 中，每个 HyperLogLog 键只需要花费 12 KB内存，就可以计算接近 2 ^ 64 个不同元素的基数。这和计算基数时，元素越多  耗费内存越多的集合就形成了 鲜明的对比</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素</p>
<h4 id="redis-位图（bitmap）"><a href="#redis-位图（bitmap）" class="headerlink" title="redis 位图（bitmap）"></a>redis 位图（bitmap）</h4><p>Bit arrays （orsimply bitmaps） 我们可以称之为 位图</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230304112630133.png"
                      alt="image-20230304112630133" style="zoom:50%;" 
                >

<p>一个字节（一个 byte） &#x3D; 8 位</p>
<blockquote>
<p>上图由 许许多多的小格子组成，每一个格子里面只能放 1 或者 0，用它来判断 Y&#x2F;N 状态</p>
<p>换句话说，每一个小格子就是一个 bit</p>
</blockquote>
<br>

<p><strong>由 1 和 0 状态表现的二进制位的 bit 数组</strong></p>
<h4 id="redis-位域（bitfield）"><a href="#redis-位域（bitfield）" class="headerlink" title="redis 位域（bitfield）"></a>redis 位域（bitfield）</h4><p>通过 bitfield 命令可以一次性操作多个 <strong><font color='red'>比特位域（指的是连续的多个比特位）</font></strong>，它会执行一系列操作并返回一个响应数组，这个数组中的元素对应参数列表中的相应操作的执行结果</p>
<br>

<blockquote>
<p>换句话说，就是通过 <code>bitfield </code> 命令，我们可以一次性对多个比特位域进行操作</p>
</blockquote>
<h4 id="redis-流（Stream）"><a href="#redis-流（Stream）" class="headerlink" title="redis 流（Stream）"></a>redis 流（Stream）</h4><p>redis stream 是 Redis 5.0 版本新增加的数据结构</p>
<p>redis Stream 主要用于 消息队列（MQ，Message Queue），redis 本身是有一个 Redis发布订阅（pub&#x2F;sub） 来实现 消息队列的功能，但是有个缺点就是 消息无法持久化，如果出现网络断开、redis 宕机等，消息就会丢失</p>
<p>简单来说，发布订阅（pub&#x2F;sub）可以分发消息，但无法记录历史消息</p>
<p>而 Redis Stream 提供了 消息的持久化 和 主备复制功能，可以让任何客户端访问任何时刻的数据，并且记住每一个客户端的访问位置，还能保证消息不丢失</p>
<h3 id="Redis-键（key）"><a href="#Redis-键（key）" class="headerlink" title="Redis 键（key）"></a>Redis 键（key）</h3><hr>
<h4 id="常用"><a href="#常用" class="headerlink" title="常用"></a>常用</h4><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230304114107289.png"
                      alt="image-20230304114107289" style="zoom: 50%;" 
                >



<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><ul>
<li><code>keys *</code> : 查看当前库所有的 key</li>
<li><code>exists key</code> : 判断某个 key 是否存在</li>
<li><code>type key</code> : 查看你的 key 是什么类型</li>
<li><code>del key</code> : 删除指定的 key 数据</li>
<li><code>unlink key</code> : 非阻塞删除，仅仅将 keys 从 keyspace 中 删除，真正的删除在后续异步中操作</li>
<li><code>ttl key </code> :  查看还有多少秒过期， - 1 代表永不过期，- 2 表示已过期</li>
<li><code>expire key 秒钟</code> ： 为给定的 key 设置 过期时间</li>
<li><code>move key dbindex 【0-15】</code> ： 将当前数据库的 key 移动到给定的数据库 db 中 </li>
<li><code>select dbindex</code> : 切换数据库【0-15】，默认为0</li>
<li><code>dbsize </code>: 查看当前数据库 key 的 数量</li>
<li><code>flushdb </code>  : 清空当前库</li>
<li><code>flushall</code> : 通杀 全部库</li>
</ul>
<h3 id="数据类型命令及落地运用"><a href="#数据类型命令及落地运用" class="headerlink" title="数据类型命令及落地运用"></a>数据类型命令及落地运用</h3><hr>
<p><strong><font color='red'>命令不区分大小写，而 key 是区分大小写的</font></strong></p>
<br>

<blockquote>
<p>帮助命令</p>
<ul>
<li>help @String</li>
<li>help @list</li>
<li>help @hash</li>
<li>……</li>
</ul>
</blockquote>
<h4 id="Redis-字符串-（String）"><a href="#Redis-字符串-（String）" class="headerlink" title="Redis 字符串 （String）"></a>Redis 字符串 （String）</h4><h5 id="常用-1"><a href="#常用-1" class="headerlink" title="常用"></a>常用</h5><table>
<thead>
<tr>
<th>1</th>
<th><code>SET key value</code></th>
<th>设置指定 key 的值</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td><code>GET key </code></td>
<td>获取指定 key 的值</td>
</tr>
<tr>
<td>3</td>
<td><code>GETRRANGE key start end</code></td>
<td>返回 key 中 字符串的子字符</td>
</tr>
<tr>
<td>4</td>
<td><code>GETBIT key  offset </code></td>
<td>对 key 所存储的字符串值，获取指定偏移量上的位 （bit）</td>
</tr>
<tr>
<td>5</td>
<td><code>GETSET key value </code></td>
<td>将给定 key  的值设为 value，并返回 key  的 旧值（old value）</td>
</tr>
<tr>
<td>6</td>
<td><code>MGET key1[key2...]</code></td>
<td>获取所有（一个或多个） 给定 key 的值</td>
</tr>
<tr>
<td>7</td>
<td><code>SETBIT key offset value</code></td>
<td>对 key 所存储的字符串值，设置或清除指定偏移量上 的位（bit）</td>
</tr>
<tr>
<td>8</td>
<td><code>SETEX key seconds value</code></td>
<td>将值 value 关联到 key ，并将 key  的过期时间设为 seconds（以秒为单位）</td>
</tr>
<tr>
<td>9</td>
<td><code>SETNX key value</code></td>
<td>只有在 key 不存在时设置 key  的 值</td>
</tr>
<tr>
<td>10</td>
<td><code>SETRANGE key offset value</code></td>
<td>用 value 参数 覆写给定 key 所存储的字符串值。从偏移量 offset 开始</td>
</tr>
<tr>
<td>11</td>
<td><code>STRLEN key</code></td>
<td>返回 key 所存储的字符串值的长度</td>
</tr>
<tr>
<td>12</td>
<td><code>MSET key value [key value ...]</code></td>
<td>同时设置一个 或 多个 key - value 对</td>
</tr>
<tr>
<td>13</td>
<td><code>MSETNX key value[key value ...]</code></td>
<td>同时设置一个或多个 key - value 对，当且仅当 所有给定的 key 都不存在</td>
</tr>
<tr>
<td>14</td>
<td><code>PSETEX key milloseconds value</code></td>
<td>这个命令和 SETEX 相似，但他以 毫秒为单位 设置 key 的 存活时间，而不是像 SETEX 那样 以秒为单位</td>
</tr>
<tr>
<td>15</td>
<td><code>INCR key</code></td>
<td>将 key 中 存储的 数字值 赠一</td>
</tr>
<tr>
<td>16</td>
<td><code>INCRBY key increment</code></td>
<td>将 key 所存储的 值加上给定的增量值</td>
</tr>
<tr>
<td>17</td>
<td><code>INCRBYFLOAT key increment</code></td>
<td>将 key 存储的值 加上给定的 浮点数增量值</td>
</tr>
<tr>
<td>18</td>
<td><code>DECR key</code></td>
<td>将 key 中储存的值减去给定的 减量值</td>
</tr>
<tr>
<td>19</td>
<td><code>DECRBY key decrement</code></td>
<td>key 所存储的值减去给定的减量值</td>
</tr>
<tr>
<td>20</td>
<td><code>APPEND key value</code></td>
<td>如果key 已经存在并且是一个字符串，APPEND 命令将 value 追加到 key 原来 的值的末尾</td>
</tr>
</tbody></table>
<h6 id="SET-命令"><a href="#SET-命令" class="headerlink" title="SET 命令"></a>SET 命令</h6><p><code>SET</code> 命令有 <code>EX </code>、<code>PX</code>、 <code>NX</code>、<code>XX</code> 以及 <code>KEEPTTL</code> 五个可选参数，其中 <code>KEEPTTL</code> 为 6.0 版本添加的可选参数，其他为 2.6.12 版本添加的可选参数</p>
<ul>
<li><code>EX seconds</code> : 以秒为单位  设置过期时间</li>
<li><code>PX milliseconds</code> ： 以毫秒为单位设置过期时间</li>
<li><code>EXAT timestamp</code> : 设置以秒为单位的 UNIX 时间戳所对应的时间为 过期时间</li>
<li><code>NX</code> : 键不存在的时候设置键值</li>
<li><code>XX</code> : 键存在的时候设置键值</li>
<li><code>KEPPTTL</code> : 保留设置前指定键的生存时间</li>
<li><code>GET</code> : 返回指定键原本的值，若键不存在时返回 <code>nil</code></li>
</ul>
<br>

<p><code>SET</code> 命令 使用 <code>EX</code>、<code>PX</code>、<code>NX</code> 参数，其效果等同于 <code>SETNX</code>、<code>SETEX </code>、<code>PSETEX</code> 命令。根据官方文档的描述，未来版本中 <code>SETNX </code>、<code>PSETEX</code>、<code>SETEX</code> 命令可能会被淘汰</p>
<p><code>EXAT</code>、<code>PXAT</code> 以及 <code>GET</code> 为 Redis 在 6.2 新增的 可选参数</p>
<br>

<p><strong>返回值</strong></p>
<p>设置成功 则返回OK，返回 nil 为 未执行 <code>SET</code> 命令，如不满足 <code>NX</code>、<code>XX</code> 条件等</p>
<p>若使用 <code>GET </code> 参数，则 返回 该键原来的值，或在键不存在的时候 返回 <code>nil</code></p>
<br>

<p>如何获得 设置指定的 key 过期的 Unix 时间，单位为秒</p>
<p><code>Long.toString(System.currentTimeMillis()/1000L).sout</code> </p>
<h5 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h5><h6 id="最常用"><a href="#最常用" class="headerlink" title="最常用"></a>最常用</h6><ul>
<li><code>set key value</code><ul>
<li><code>keepttl</code></li>
</ul>
</li>
</ul>
<h6 id="同时设置-获取多个-键值"><a href="#同时设置-获取多个-键值" class="headerlink" title="同时设置&#x2F;获取多个 键值"></a>同时设置&#x2F;获取多个 键值</h6><ul>
<li><p><code>MSET key value[key value ...]</code></p>
<p>同时设置一个或多个 key-value键值对</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306224401060.png"
                      alt="image-20230306224401060" style="zoom:50%;" 
                >
</li>
<li><p><code>MGET key[key ...]</code></p>
<p>获取所有（一个或多个）给定 key 的 值</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306224503423.png"
                      alt="image-20230306224503423" style="zoom:50%;" 
                >
</li>
<li><p><code>mset/mget/msetnx</code></p>
<p>同时设置 一个 或多个 key-value 对，<strong>当且仅当所有给定的 key 都不存在</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306224806449.png"
                      alt="image-20230306224806449" style="zoom:50%;" 
                ></li>
</ul>
<h6 id="获得指定区间范围内的值"><a href="#获得指定区间范围内的值" class="headerlink" title="获得指定区间范围内的值"></a>获得指定区间范围内的值</h6><p><code>getrange</code></p>
<p>获得指定区间范围内的值，类似 between…and 的关系，<strong>从0 对 -1 表示全部</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306225248021.png"
                      alt="image-20230306225248021" style="zoom:50%;" 
                >

<br>

<p><code>setrange</code></p>
<p>设置指定区间内范围的值，格式是 setrange key值 具体值</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306225339265.png"
                      alt="image-20230306225339265" style="zoom:50%;" 
                >



<h6 id="数值增减"><a href="#数值增减" class="headerlink" title="数值增减"></a>数值增减</h6><ul>
<li><strong>一定要是数字才可以增减</strong></li>
<li>递增数字<ul>
<li><code>INCR key</code></li>
</ul>
</li>
<li>增加指定整数<ul>
<li><code>INCRBY key increment</code></li>
</ul>
</li>
<li>递减数值<ul>
<li><code>DECR key</code></li>
</ul>
</li>
<li>减少指定的整数<ul>
<li><code>DECRBY key decrement</code></li>
</ul>
</li>
</ul>
<h6 id="获取字符串的长度和内容追加"><a href="#获取字符串的长度和内容追加" class="headerlink" title="获取字符串的长度和内容追加"></a>获取字符串的长度和内容追加</h6><ul>
<li><code>STRLEN key</code></li>
<li><code>APPEND key value</code></li>
</ul>
<h6 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h6><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306225707441.png"
                      alt="image-20230306225707441" style="zoom:67%;" 
                >

<ul>
<li>EX ： key 在多少秒后过期</li>
<li>PX ：key 在多少毫秒之后过期</li>
<li>NX ：当 key 不存在的时候，才创建 key,效果等同于丢setnx</li>
<li>XX : 当 key 存在的时候，覆盖 key</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306225829951.png"
                      alt="image-20230306225829951" style="zoom:50%;" 
                >



<h6 id="getset"><a href="#getset" class="headerlink" title="getset"></a>getset</h6><p>将给定的 key 的值设为 value，并返回 key 的旧值（old value）</p>
<p>简单一句话，<strong>先 get ，然后立即 set</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230306230033934.png"
                      alt="image-20230306230033934" style="zoom:50%;" 
                >



<h5 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h5><p>抖音无限点赞某个视频或者商品，点一下加一次</p>
<br>

<p>是否 喜欢的文章</p>
<blockquote>
<p>阅读数： 只要点击了 star，直接可以使用 incr key 命令增加一个数字1，完成记录数字</p>
</blockquote>
<h4 id="Redis列表（List）"><a href="#Redis列表（List）" class="headerlink" title="Redis列表（List）"></a>Redis列表（List）</h4><h5 id="常用-2"><a href="#常用-2" class="headerlink" title="常用"></a>常用</h5><table>
<thead>
<tr>
<th>1</th>
<th>BLPOP key 1 [key2] timeout</th>
<th>移除并获取列表的第一个元素，如果列表没有元素会阻塞列表直到等待超时或发现可弹出的元素为止</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>BRPOP key1 [key2] timeout</td>
<td>移除并获取列表的最后一个元素，如果没有元素会阻塞列表直到等待超时或发现可弹出元素为止</td>
</tr>
<tr>
<td>3</td>
<td>BRPOPLPUSH source destination timeout</td>
<td>从列表中弹出一个值，将弹出的元素插入到另外一个列表并返回他;如果列表中没有元素会阻塞列表直到等待超时 或发现可以弹出的元素为止</td>
</tr>
<tr>
<td>4</td>
<td>LINDEX key index</td>
<td>通过索引获取列表中的元素</td>
</tr>
<tr>
<td>5</td>
<td>LINSERT key BEFORE|AFTER pivot value</td>
<td>在列表的元素前或者后 插入元素</td>
</tr>
<tr>
<td>6</td>
<td>LLEN key</td>
<td>获取列表长度</td>
</tr>
<tr>
<td>7</td>
<td>LPOP key</td>
<td>移除并获取列表中的第一个元素</td>
</tr>
<tr>
<td>8</td>
<td>LPUSH key value [value2]</td>
<td>将一个或多个值插入到列表头部</td>
</tr>
<tr>
<td>9</td>
<td>LPUSHX key value</td>
<td>将一个或多个值插入到已存在的 列表头部</td>
</tr>
<tr>
<td>10</td>
<td>LRANGE key start end</td>
<td>获取扩表指定范围内的元素</td>
</tr>
<tr>
<td>11</td>
<td>LREM key count value</td>
<td>移除列表元素</td>
</tr>
<tr>
<td>12</td>
<td>LSET key index value</td>
<td>通过索引设置列表元素的值</td>
</tr>
<tr>
<td>13</td>
<td>LTRIM key start stop</td>
<td>对一个列表进行修剪（trim），就是说，让列表只保留指定区间的元素，不在指定区间之内的元素都将被删除</td>
</tr>
<tr>
<td>14</td>
<td>LPOP key</td>
<td>移除并获取列表最后一个元素</td>
</tr>
<tr>
<td>15</td>
<td>RPOPLPUSH source destination</td>
<td>移除列表的最后一个元素，并将该元素添加到另一个列表并返回</td>
</tr>
<tr>
<td>16</td>
<td>RPUSH key value[value2]</td>
<td>在列表添加一个或多个值</td>
</tr>
<tr>
<td>17</td>
<td>RPUSHX key value</td>
<td>为已存在的列表添加值</td>
</tr>
</tbody></table>
<h5 id="简单说明"><a href="#简单说明" class="headerlink" title="简单说明"></a>简单说明</h5><p>一个双端列表的结构，容量是 2^32 - 1 各元素，大概 40 多亿，主要功能有 push&#x2F;pop 等，一般用在 栈、队列、消息队列 等场景</p>
<p>left、right 都可以插入添加</p>
<p>如果 键不存在，创建新的链表</p>
<p>如果 键已存在，新增内容</p>
<p>如果 值全移除，对应的 键也就消失了</p>
<br>

<blockquote>
<p>它的底层实际是个  <strong>双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差</strong></p>
</blockquote>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230307142705891.png"
                      alt="image-20230307142705891" style="zoom:50%;" 
                >



<h5 id="案例-2"><a href="#案例-2" class="headerlink" title="案例"></a>案例</h5><ul>
<li><p><code>lpush / rpush /lrange</code></p>
</li>
<li><p><code>lpop / rpop</code></p>
</li>
<li><p><code>lindex </code></p>
<ul>
<li><code>lindex key index</code></li>
<li>按照 索引下标 获得元素（从上到下）</li>
</ul>
</li>
<li><p><code>llen</code></p>
<ul>
<li>获取 列表中的元素的个数</li>
</ul>
</li>
<li><p><code>lrem key</code></p>
<ul>
<li>数字 N , 给定值 v1  解释（删除 N 个值等于 v1 的元素）</li>
</ul>
</li>
<li><p><code>rpoplpush</code></p>
<ul>
<li>源列表 目的列表</li>
<li>移除列表的最后一个元素，并将该元素添加到另一个列表中并返回</li>
</ul>
</li>
<li><h2 id="lset-key-index-value"><a href="#lset-key-index-value" class="headerlink" title="lset key index value"></a><code>lset key index value</code></h2><ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308141338454.png"
                      alt="image-20230308141338454" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p><code>linsert key before/after 已有值 插入的新值</code></p>
<ul>
<li>在 list 某个已有值的前后再添加具体值</li>
</ul>
</li>
</ul>
<h4 id="Redis哈希（Hash）"><a href="#Redis哈希（Hash）" class="headerlink" title="Redis哈希（Hash）"></a>Redis哈希（Hash）</h4><h5 id="常用-3"><a href="#常用-3" class="headerlink" title="常用"></a>常用</h5><table>
<thead>
<tr>
<th>1</th>
<th>HDEL key field2[field2]</th>
<th>删除一个或多个哈希表字段</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>HEXIXTS key field</td>
<td>查看哈希表 key 中，指定的字段是否存在</td>
</tr>
<tr>
<td>3</td>
<td>HGET key field</td>
<td>获取存储在哈希表中指定字段的值</td>
</tr>
<tr>
<td>4</td>
<td>HGETALL key</td>
<td>获取在 哈希表中指定 key 的所有字段和值</td>
</tr>
<tr>
<td>5</td>
<td>HINCRBY key field increment</td>
<td>为哈希表 key 中的指定字段的数值加上增量 increment</td>
</tr>
<tr>
<td>6</td>
<td>HINCRBYFLOAT key field increment</td>
<td>为哈希表 key 中的指定字段的数值加上增量 increment</td>
</tr>
<tr>
<td>7</td>
<td>HKEYS key</td>
<td>获取所有哈希表中的字段</td>
</tr>
<tr>
<td>8</td>
<td>HLEN key</td>
<td>获取哈希表中的字段的数量</td>
</tr>
<tr>
<td>9</td>
<td>HMGET key field1 [field2]</td>
<td>获取所有给定字段的值</td>
</tr>
<tr>
<td>10</td>
<td>HMSET key field1 value1[field2 value2]</td>
<td>同时将多个 field-value （域-值）对设置到哈希表中去</td>
</tr>
<tr>
<td>11</td>
<td>HSET key field value</td>
<td>将哈希表 key 中的字段 field 的值设为 value</td>
</tr>
<tr>
<td>12</td>
<td>HSETNX key field value</td>
<td>只有在字段 field 不存在的时候，设置哈希表字段的值</td>
</tr>
<tr>
<td>13</td>
<td>HVALX key</td>
<td>获取哈希表中的所有值</td>
</tr>
<tr>
<td>14</td>
<td><code>HSCAN key cursor[MATCH pattern][COUNT count]</code></td>
<td>迭代哈希表中的键值对</td>
</tr>
</tbody></table>
<br>

<blockquote>
<p><strong>KV 模式不变，但 v 是一个键值对</strong></p>
<p><strong>Map&lt;String,Map&lt;Object,Object&gt;&gt;</strong></p>
</blockquote>
<h5 id="案例-3"><a href="#案例-3" class="headerlink" title="案例"></a>案例</h5><ul>
<li><code>hset/hget/hmset/hmget/hgetall/hdel</code><ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308143612996.png"
                      alt="image-20230308143612996" style="zoom:50%;" 
                ></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308143720534.png"
                      alt="image-20230308143720534" style="zoom:50%;" 
                ></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308143815260.png"
                      alt="image-20230308143815260" style="zoom:50%;" 
                ></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308143910892.png"
                      alt="image-20230308143910892" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><code>hlen key</code><ul>
<li>获取某个 key 内的全部数量</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308144157562.png"
                      alt="image-20230308144157562" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><code>hexists key</code><ul>
<li>在 key 里面的某个值的key</li>
</ul>
</li>
<li><code>hkeys/hvals</code><ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308144519547.png"
                      alt="image-20230308144519547" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><code>hsetnx </code><ul>
<li>不存在赋值，存在了无效</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308144815501.png"
                      alt="image-20230308144815501" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
<h5 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h5><p>JD 购物车早期设计，目前不再采用，当前中小厂可用</p>
<h4 id="Redis集合（Set）"><a href="#Redis集合（Set）" class="headerlink" title="Redis集合（Set）"></a>Redis集合（Set）</h4><h5 id="常用-4"><a href="#常用-4" class="headerlink" title="常用"></a>常用</h5><table>
<thead>
<tr>
<th>1</th>
<th>sadd key member1 [member2]</th>
<th>向集合中添加一个或多个成员</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>scard key</td>
<td>获取集合的成员数</td>
</tr>
<tr>
<td>3</td>
<td>sdiff key1 [key2]</td>
<td>返回给定所有集合的差集</td>
</tr>
<tr>
<td>4</td>
<td>sdiffstore destination key1[key2]</td>
<td>返回给定所有集合的差集 并储存在 destination 中</td>
</tr>
<tr>
<td>5</td>
<td>sinter key1[key2]</td>
<td>返回给定所有集合的交集</td>
</tr>
<tr>
<td>6</td>
<td>sinterstore destination key1[key2]</td>
<td>返回给定所有集合的交集并储存在 destination中</td>
</tr>
<tr>
<td>7</td>
<td>sismember key member</td>
<td>判断 member 元素 是否是集合 key 的成员</td>
</tr>
<tr>
<td>8</td>
<td>smembers key</td>
<td>返回集合中 的所有成员</td>
</tr>
<tr>
<td>9</td>
<td>smove source destination member</td>
<td>将 member  成员从  source 集合移动到 destination 集合</td>
</tr>
<tr>
<td>10</td>
<td>spop key</td>
<td>移除并返回集合中的一个随机元素</td>
</tr>
<tr>
<td>11</td>
<td>srandmember key [count]</td>
<td>返回集合中一个或多个随机元素</td>
</tr>
<tr>
<td>12</td>
<td>srem key member1 [member2]</td>
<td>移除集合中一个或多个成员</td>
</tr>
<tr>
<td>13</td>
<td>sunion key1 [key2]</td>
<td>返回所有给定集合的并集</td>
</tr>
<tr>
<td>14</td>
<td>sunionstore destination key1[key2]</td>
<td>所有 给定集合的并集存储在 destination 集合中</td>
</tr>
<tr>
<td>15</td>
<td>sscan key cursor [MATCH pattern] [COUNT conut]</td>
<td>迭代集合中的元素</td>
</tr>
</tbody></table>
<br>

<blockquote>
<p> <strong>单值多 value，且无重复</strong></p>
</blockquote>
<h5 id="案例-4"><a href="#案例-4" class="headerlink" title="案例"></a>案例</h5><ul>
<li><code>sadd key member[member...]</code><ul>
<li>添加元素    </li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308204308162.png"
                      alt="image-20230308204308162" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><code>smembers key</code><ul>
<li>遍历集合中的所有元素</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308204428789.png"
                      alt="image-20230308204428789" style="zoom:67%;" 
                ></li>
</ul>
</li>
<li><code>sismember key member</code><ul>
<li>判断元素是否集合中</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308205517261.png"
                      alt="image-20230308205517261"
                ></li>
</ul>
</li>
<li><code>srem key member [member...]</code><ul>
<li>删除元素</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308204638709.png"
                      alt="image-20230308204638709" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><code>scard key</code><ul>
<li>获取集合里面的元素个数</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308204855632.png"
                      alt="image-20230308204855632" style="zoom: 67%;" 
                ></li>
</ul>
</li>
<li><code>srandmember key[数字]</code><ul>
<li>从集合中 随机展现设置的数字个数，元素不删除</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308205249094.png"
                      alt="image-20230308205249094" style="zoom:67%;" 
                ></li>
</ul>
</li>
<li><code>spop key[数字]</code><ul>
<li>从集合中随机弹出一个元素，出一个删一个</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308205429379.png"
                      alt="image-20230308205429379" style="zoom:67%;" 
                ></li>
</ul>
</li>
<li><code>smove key1 key2 在 key1 已经存在的值 </code><ul>
<li>将 key1 里的值赋给 key2</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308210227997.png"
                      alt="image-20230308210227997" style="zoom:67%;" 
                ></li>
</ul>
</li>
<li>集合运算<ul>
<li>A、B<ul>
<li>A <ul>
<li>abc12</li>
</ul>
</li>
<li>B<ul>
<li>123ax</li>
</ul>
</li>
</ul>
</li>
<li>集合的差集运算 A - B<ul>
<li>属于 A，但不属于 B 的元素构成的集合</li>
<li><code>sdiff key [key...]</code></li>
</ul>
</li>
<li>集合的 并集运算<ul>
<li>属于 A 或者 属于 B 的元素合并后的 集合</li>
<li><code>sunion key1 [key2]</code></li>
</ul>
</li>
<li>集合的 交集运算 <ul>
<li>属于 A 同时也 属于 B  的共同拥有的元素构成的集合</li>
<li><code>sinter key [key2]</code></li>
<li><code>sintercard numkeys key[key... ][Limit limit]</code><ul>
<li>redis 新命令</li>
<li>他不返回结果集，而只返回结果的基数。返回由所有给定集合的交集的基数</li>
</ul>
</li>
</ul>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308211817758.png"
                      alt="image-20230308211817758" style="zoom: 67%;" 
                ></li>
</ul>
</li>
</ul>
<h5 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h5><ul>
<li>微信抽奖小程序<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308211952925.png"
                      alt="image-20230308211952925" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li>微信朋友圈 查看共同点赞好友<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308212016419.png"
                      alt="image-20230308212016419" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li>QQ 内推 可能认识的人</li>
</ul>
<h4 id="Redis-有序集合Zset-sorted-set"><a href="#Redis-有序集合Zset-sorted-set" class="headerlink" title="Redis 有序集合Zset (sorted set)"></a>Redis 有序集合Zset (sorted set)</h4><h5 id="常用-5"><a href="#常用-5" class="headerlink" title="常用"></a>常用</h5><p>在 set 基础上，每个 val 值前加一个 score 分数值</p>
<p>之前 set  是 k1  v1  v2  v3</p>
<p>现在 zset 是 k1 score1 v1 score2 v2</p>
<br>

<table>
<thead>
<tr>
<th>1</th>
<th>zadd key score1 member1[score2 member2]</th>
<th>向 有序集合添加一个或多个成员，或者 更新 已存在成员的分数</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>zcard key</td>
<td>获取有序集合的成员数</td>
</tr>
<tr>
<td>3</td>
<td>zcount key min max</td>
<td>计算在有序集合中 指定区间分数的成员数</td>
</tr>
<tr>
<td>4</td>
<td>zincrby key increment member</td>
<td>有序集合中对指定成员的分数加上 增量 increment</td>
</tr>
<tr>
<td>5</td>
<td>zinterstore destiantion numkeys key [key1]</td>
<td>计算给定的一个或多个有序集的交集并将结果存储在新的有序集合 key 中</td>
</tr>
<tr>
<td>6</td>
<td>zlexcount key min max</td>
<td>在有序集合中计算指定字典区间内成员的数量</td>
</tr>
<tr>
<td>7</td>
<td>zrange key start stop [WITHSCORES]</td>
<td>通过 索引区间返回有序集合成指定区间的成员</td>
</tr>
<tr>
<td>8</td>
<td>zrangebylex ley min max[LIMIT  offset count]</td>
<td>通过字典区间返回有序集合的成员</td>
</tr>
<tr>
<td>9</td>
<td><code>zrangebyscore key min max [WITHSCORES][LIMIT]</code></td>
<td>通过分数返回有序集合指定区间内的成员</td>
</tr>
<tr>
<td>10</td>
<td>zrank key member</td>
<td>返回有序集合中指定成员的索引</td>
</tr>
<tr>
<td>11</td>
<td>zrem key member [member…]</td>
<td>移除有序集合中的一个或多个成员</td>
</tr>
<tr>
<td>12</td>
<td>zremrangebylex key min max</td>
<td>移除有序集合中给定的字典区间的所有成员</td>
</tr>
<tr>
<td>13</td>
<td>zremrangebyrank key start stop</td>
<td>移除有序集合中给定的排名区间内的所有成员</td>
</tr>
<tr>
<td>14</td>
<td>zremrangebyscore key min max</td>
<td>移除有序集合中给定的分数区间的所有成员</td>
</tr>
<tr>
<td>15</td>
<td>zrevrange key start stop [WITHSCORES]</td>
<td>返回有序集合中指定区间的成员，通过索引，分数从高到低</td>
</tr>
<tr>
<td>16</td>
<td>zrevrangebyscore key max min [WITHSCORES]</td>
<td>返回有序集合中 指定分数区间内的成员，分数从高到低</td>
</tr>
<tr>
<td>17</td>
<td>zrevrank key member</td>
<td>返回有序集合中指定成员的排名，有序集合成员按分数递减（从大到小）排序</td>
</tr>
<tr>
<td>18</td>
<td>zscore key member</td>
<td>返回有序集合中，成员的分数值</td>
</tr>
<tr>
<td>19</td>
<td>zunionstore destiantion numkeys key [key2]</td>
<td>计算给定的一个或多个有序集的并集，并存储在 新的 key 中</td>
</tr>
<tr>
<td>20</td>
<td>zscan key cursor [MATCH pattern] [COUNT count]</td>
<td>迭代有序集合中的元素（包括元素成员和元素值）</td>
</tr>
</tbody></table>
<h5 id="案例-5"><a href="#案例-5" class="headerlink" title="案例"></a>案例</h5><p><strong>向 有序集合中加入一个元素和该元素的分数</strong></p>
<ul>
<li><p><code>zadd key score member[score member...]</code></p>
<ul>
<li>添加元素</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308220302832.png"
                      alt="image-20230308220302832" style="zoom:67%;" 
                ></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308220344820.png"
                      alt="image-20230308220344820" style="zoom:67%;" 
                ></li>
</ul>
</li>
<li><p><code>zrange key start stop[WITHSCORES]</code></p>
<ul>
<li>按照元素分数大小从小到大排序。按照索引 从 start 到 stop 之间的所有元素</li>
</ul>
</li>
<li><p><code>zrevrange key start stop [WITHSCORES]</code></p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308220649883.png"
                      alt="image-20230308220649883" style="zoom:67%;" 
                ></li>
</ul>
</li>
<li><p><code>zscore key member</code></p>
<ul>
<li>获取元素的分数</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="C:\Users\CSQ-PC\AppData\Roaming\Typora\typora-user-images\image-20230308220816200.png"
                      alt="image-20230308220816200"
                ></li>
</ul>
</li>
<li><p><code>zcard key</code></p>
<ul>
<li>获取集合中元素的数量</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230308223347560.png"
                      alt="image-20230308223347560"
                ></li>
</ul>
</li>
<li><p><code>zrem key 某 score 下对应的 value 值，作用</code></p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309102305684.png"
                      alt="image-20230309102305684" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p><code>zincrby key increment member</code></p>
<ul>
<li>增加某个元素的分数</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309102718285.png"
                      alt="image-20230309102718285" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p><code>zcount key min max</code></p>
<ul>
<li>获得指定分数范围内的元素个数</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309102846804.png"
                      alt="image-20230309102846804" style="zoom:80%;" 
                ></li>
</ul>
</li>
<li><p><code>zmpop</code></p>
<ul>
<li>从键名列表中的第一个非空排序列表中弹出一个或多个元素，他们是成员分数对</li>
</ul>
</li>
<li><p><code>zrank key values</code></p>
<ul>
<li>作用是 获得下标值</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309103641322.png"
                      alt="image-20230309103641322" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p><code>zrevrank key values 值</code></p>
<ul>
<li>作用是 逆序获得下标值</li>
</ul>
</li>
</ul>
<h5 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h5><p>根据商品销售对商品进行排序显示</p>
<h4 id="Redis位图（bitmap）"><a href="#Redis位图（bitmap）" class="headerlink" title="Redis位图（bitmap）"></a>Redis位图（bitmap）</h4><p><strong>由  0 1  表现的 二进制位的 bit 数组</strong></p>
<br>

<p>需求</p>
<ul>
<li>用户是否登陆过 Y、N ，比如京东每日签到</li>
<li>电影、广告是否被点击过</li>
<li>钉钉打卡上班。签到统计</li>
</ul>
<br>

<p><strong>是什么</strong></p>
<blockquote>
</blockquote>
<br>

<p><strong>用处</strong></p>
<p>用于状态统计</p>
<p>Y、N ，类似 AtomicBoolean</p>
<h5 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h5><table>
<thead>
<tr>
<th>setbit key offset val</th>
<th>给指定的 key 的 第 offset 个赋值 val</th>
<th>O(1)</th>
</tr>
</thead>
<tbody><tr>
<td>getbit key offset</td>
<td>获得指定 key  的第 offset 位</td>
<td>O(1)</td>
</tr>
<tr>
<td>bitcount key start end</td>
<td>返回指定 key 中 从 [start,end ] 中 1 的数量</td>
<td>O(n)</td>
</tr>
<tr>
<td>bitop operation destkey key</td>
<td>对不同的二进制存储数据进行 位运算（AND、OR、NOT、XOR）</td>
<td>O(n)</td>
</tr>
</tbody></table>
<br>

<ul>
<li><p>​	<code>setbit</code></p>
</li>
<li><p><code>setbit key offset value</code>   -  offset 偏移量，只能为 0、1</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309110948405.png"
                      alt="image-20230309110948405" style="zoom:67%;" 
                ></li>
<li>bitmap 的偏移量是从 0 开始计算的</li>
</ul>
</li>
<li><p><code>getbit </code></p>
<ul>
<li><code>getbit key offset</code></li>
</ul>
</li>
<li><p><code>strlen</code></p>
<ul>
<li>不是字符串长度。而是占据几个字节，超过 8 位后自己按照8 位一组 <strong>一 byte</strong>  再扩容</li>
</ul>
</li>
<li><p><code>bitcount</code></p>
<ul>
<li>全部建包含多少个1</li>
</ul>
</li>
<li><p><code>bitop</code></p>
</li>
</ul>
<h5 id="应用场景-4"><a href="#应用场景-4" class="headerlink" title="应用场景"></a>应用场景</h5><ul>
<li>一年 365 天，全年天天登陆占多少字节</li>
<li>按照 年</li>
</ul>
<h4 id="Redis基数统计（HyperLogLog）"><a href="#Redis基数统计（HyperLogLog）" class="headerlink" title="Redis基数统计（HyperLogLog）"></a>Redis基数统计（HyperLogLog）</h4><h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><ul>
<li>统计某个网站的uv，统计某个文章的 uv</li>
<li>什么是 uv<ul>
<li>unique visitor  -  独立访客，一般理解为 客户端ip</li>
<li>需要去重考虑</li>
</ul>
</li>
<li>用户搜索网站关键词的数量</li>
<li>统计用户每天搜索不同词条的个数</li>
</ul>
<h5 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h5><ul>
<li>去重统计功能的基数估计算法  - 就是 HyperLoglog</li>
<li>基数<ul>
<li>是一种数据集，去重复后的真实个数</li>
<li>案例 - case<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309140726948.png"
                      alt="image-20230309140726948" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
</li>
<li>基数统计<ul>
<li>用于统计一个集合中不重复的元素个数，就是对集合进行去重复操作后剩余的元素的计算</li>
</ul>
</li>
</ul>
<br>

<blockquote>
<p>一句话，<strong>去重脱水后的真实数据</strong></p>
</blockquote>
<h5 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h5><table>
<thead>
<tr>
<th>1</th>
<th>pfadd key element[element… ]</th>
<th>添加指定元素到 HyperLogLog 中</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>pfcount key [key…]</td>
<td>返回给定 Hyperloglog 的基数估算值</td>
</tr>
<tr>
<td>3</td>
<td>pfmerge destkey sourcekey[sourcekey…]</td>
<td>将多个 HyperLoglog 合并成一个 HyperLogLog</td>
</tr>
</tbody></table>
<h5 id="应用场景-5"><a href="#应用场景-5" class="headerlink" title="应用场景"></a>应用场景</h5><p>天猫网站首页 亿级 uv 的redis 统计方案</p>
<h4 id="Redis地理空间（GEO）"><a href="#Redis地理空间（GEO）" class="headerlink" title="Redis地理空间（GEO）"></a>Redis地理空间（GEO）</h4><p>移动互联网时代LBS应用越来越多，交友软件中附近的小姐姐、外卖软件中附近的美食店铺、高德地图附近的核酸检查点等等，那这种附近各种形形色色的XXX地址位置选择是如何实现的？</p>
<p>地球上的地理位置是使用二维的经纬度表示，经度范围 (-180, 180]，纬度范围 (-90, 90]，只要我们确定一个点的经纬度就可以名取得他在地球的位置。</p>
<p>例如滴滴打车，最直观的操作就是实时记录更新各个车的位置，</p>
<p>然后当我们要找车时，在数据库中查找距离我们(坐标x0,y0)附近r公里范围内部的车辆</p>
<p>使用如下SQL即可：</p>
<p><code>select taxi from position where x0-r &lt; x &lt; x0 + r and y0-r &lt; y &lt; y0+r</code></p>
<p>但是这样会有什么问题呢？</p>
<p>1.查询性能问题，如果并发高，数据量大这种查询是要搞垮数据库的</p>
<p>2.这个查询的是一个矩形访问，而不是以我为中心r公里为半径的圆形访问。</p>
<p>3.精准度的问题，我们知道地球不是平面坐标系，而是一个圆球，这种矩形计算在长距离计算时会有很大误差</p>
<h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>核心 思想就是将球体转换为平面，区块转换为一点</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309202150455.png"
                      alt="image-20230309202150455" style="zoom:50%;" 
                >

<br>

<p>主要分三步</p>
<ul>
<li>将三维的地球变为二维的坐标</li>
<li>在将二维的坐标转换为 一维的点块</li>
<li>最后将 一维的点块转换为二进制再通过 base32 编码</li>
</ul>
<br>

<blockquote>
<p>redis 在 3.2 版本之后，增加了地理位置的处理</p>
</blockquote>
<h5 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h5><ul>
<li><p><code>geoadd 多个经度（longitude）、维度（latitude）、位置名称（member） 添加到指定的 key 中</code></p>
<ul>
<li>geoadd 用于存储指定的地理空间位置，可以将一个或多个经度（longitude）、维度（latitude）、位置名称（member） 添加到指定的 key 中</li>
<li>语法格式 ： <code>geoadd key longitude latitude member [longitude latitude member ...]</code><ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309204025147.png"
                      alt="image-20230309204025147"
                ></li>
</ul>
</li>
<li>乱码问题<ul>
<li><code>redis-cli --raw</code><ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309210846102.png"
                      alt="image-20230309210846102"
                ></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>geopos 从键里面返回所有给定位置元素的位置（经度和维度）</code></p>
<ul>
<li><code>geopos </code> 用于从给定的 key 里返回所有指定名称（member） 的位置（经度、维度），不存在的返回 nil </li>
<li>语法格式 <ul>
<li><code>geopos key member [member ...]</code></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309211548874.png"
                      alt="image-20230309211548874"
                ></li>
</ul>
</li>
</ul>
</li>
<li><p><code>geodist 返回两个给定位置之间的距离</code></p>
<ul>
<li>geodist 用于 返回两个给定位置之间的距离</li>
<li>geodist 语法格式<ul>
<li><code>geodist key member1 member2 [m|km|ft|mi]</code><ul>
<li>后面参数是 距离单位<ul>
<li>m : 米</li>
<li>km : 千米</li>
<li>ft ： 英尺</li>
<li>mi : 英里</li>
</ul>
</li>
</ul>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309212359777.png"
                      alt="image-20230309212359777"
                ></li>
</ul>
</li>
</ul>
</li>
<li><p><code>georadius 以给定的经纬度为中心，返回与中心的距离不超过给定最大距离的所有位置元素</code></p>
<ul>
<li>georadius 以给定的经纬度为中心，返回键包含的位置元素当中，与中心的距离不超过给定的最大距离的所有位置元素</li>
<li><code>GEORADIUS city 116.418017 39.914402 10 km withdist withcoord count 10 withhash desc</code></li>
<li><code>GEORADIUS city 116.418017 39.914402 10 km withdist withcoord withhash count 10 desc</code><ul>
<li>withdist : 在返回位置元素的同时，将位置元素与中心之间的距离也一并返回，距离的单位和用户给定的范围单位保持一致</li>
<li>withcoord : 将位置元素的经度和维度也一并返回</li>
<li>withhash ： 以 52 位有符号整数的形式，返回位置元素经过原始 geohash 编码的有序集合分值。这个选项主要用于底层应用或者调试，实际中作用并不大</li>
<li>count ： 限定返回的记录数</li>
</ul>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309213207870.png"
                      alt="image-20230309213207870"
                ></li>
</ul>
</li>
<li><p><code>georadiusbymember 跟georadius 类似</code></p>
<ul>
<li>找出位于指定 范围内的元素，中心点是由给定的位置元素决定</li>
</ul>
</li>
<li><p><code>geohash 返回一个或多个位置元素的 Geohash 表示</code></p>
<ul>
<li>Redis GEO 使用 geohash 来保存地理位置的坐标</li>
<li>geohash 用于获取一个或多个位置的元素 的 geohash 值</li>
<li>geohash 的 语法格式<ul>
<li><code>geohash key member [member...]</code></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309212041610.png"
                      alt="image-20230309212041610" style="zoom: 67%;" 
                ></li>
</ul>
</li>
</ul>
</li>
</ul>
<br>

<p><strong><font color='red'>如何获得某个位置的经纬度？</font></strong></p>
<p><a class="link"   target="_blank" rel="noopener" href="http://api.map.baidu.com/lbsapi/getpoint/" >http://api.map.baidu.com/lbsapi/getpoint/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h4 id="Redis流（Stream）"><a href="#Redis流（Stream）" class="headerlink" title="Redis流（Stream）"></a>Redis流（Stream）</h4><h5 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么"></a>是什么</h5><p>redis 5.0 之前的痛点</p>
<ul>
<li><p>Redis 消息队列 的两种方案</p>
<ul>
<li><p>List 实现消息队列</p>
<ul>
<li><p>按照插入顺序排序，你可以添加一个元素到列表的头部（左边）或者尾部（右边）。 </p>
<p>所以常用来做异步队列使用，将需要延后处理的任务结构体序列化成字符串塞进 Redis 的列表，另一个线程从这个列表中轮询数据进行处理。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309213659075.png"
                      alt="image-20230309213659075"
                ></p>
</li>
<li><p>List 的实现方式其实就是点对点的模式</p>
</li>
</ul>
</li>
<li><p>（Pub&#x2F;sub）</p>
<ul>
<li><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309213958521.png"
                      alt="image-20230309213958521"
                ></p>
<p>Redis 发布订阅（pub&#x2F;sub） 有个缺点就是消息无法持久化，如果出现 网络断开、Redis 宕机等，消息就会被丢弃，而且也没有 ack 机制来保证数据的可靠性，假设一个消费者都没有，那么消息就会被丢弃了</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br>

<p>Redis 5.0 版本新增了一个更强大的 数据结构 – Stream</p>
<br>

<blockquote>
<p>一句话， <strong><font color='red'>redis 版的 MQ消息中间件 + 阻塞队列</font></strong></p>
</blockquote>
<h5 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h5><p>实现 消息队列，他支持消息的持久化、支持自动生成全局唯一 ID、支持 ack 确认消息的模式、支持消费组模式等，让消息更加的稳定和可靠</p>
<h5 id="底层结构和原理说明"><a href="#底层结构和原理说明" class="headerlink" title="底层结构和原理说明"></a>底层结构和原理说明</h5><p>Stream 结构</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309214654127.png"
                      alt="image-20230309214654127"
                ></p>
<br>

<blockquote>
<p>一个消息链表，将所有加入的消息都串起来，每个消息都有唯一一个的 ID 和对应的内容</p>
</blockquote>
<br>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309214754029.png"
                      alt="image-20230309214754029"
                ></p>
<h5 id="基本命令理论"><a href="#基本命令理论" class="headerlink" title="基本命令理论"></a>基本命令理论</h5><h6 id="队列相关指令"><a href="#队列相关指令" class="headerlink" title="队列相关指令"></a>队列相关指令</h6><table>
<thead>
<tr>
<th>1</th>
<th>xadd</th>
<th>添加消息到队列末尾</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>xtrim</td>
<td>限制 Stream 的长度，如果已经超长 会进行截取</td>
</tr>
<tr>
<td>3</td>
<td>xdel</td>
<td>删除消息</td>
</tr>
<tr>
<td>4</td>
<td>xlen</td>
<td>获取 stream 中的消息长度</td>
</tr>
<tr>
<td>5</td>
<td>xrange</td>
<td>获取消息列表（可以指定范围），忽略删除的消息</td>
</tr>
<tr>
<td>6</td>
<td>xrevrange</td>
<td>和 xranger 相比，区别在于 反向获取，ID 从大到小</td>
</tr>
<tr>
<td>7</td>
<td>xread</td>
<td>获取消息（阻塞&#x2F;非阻塞），返回大于指定ID 的消息</td>
</tr>
</tbody></table>
<h6 id="消费组相关指令"><a href="#消费组相关指令" class="headerlink" title="消费组相关指令"></a>消费组相关指令</h6><table>
<thead>
<tr>
<th>1</th>
<th>xgroup create</th>
<th>创建消费组</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>xreadgroup group</td>
<td>读取 消费组中的消息</td>
</tr>
<tr>
<td>3</td>
<td>xack</td>
<td>ack 消息，消息被标记为 “已处理”</td>
</tr>
<tr>
<td>4</td>
<td>xgroup setid</td>
<td>设置消费组最后递送消息的 id</td>
</tr>
<tr>
<td>5</td>
<td>xgroup delconsumer</td>
<td>删除消费组</td>
</tr>
<tr>
<td>6</td>
<td>xpending</td>
<td>打印待处理消息的详细信息</td>
</tr>
<tr>
<td>7</td>
<td>xclaim</td>
<td>转移消息的归属权（长期未被处理&#x2F;无法处理的消息，转交为其他消费组进行处理）</td>
</tr>
<tr>
<td>8</td>
<td>xinfo</td>
<td>打印 stream &#x2F; consumer &#x2F;group 的详细消息</td>
</tr>
<tr>
<td>9</td>
<td>xinfo groups</td>
<td>打印消费者组的详细消息</td>
</tr>
<tr>
<td>10</td>
<td>xinfo stream</td>
<td>打印 stream 的详细消息</td>
</tr>
</tbody></table>
<h6 id="4-个特殊符号"><a href="#4-个特殊符号" class="headerlink" title="4 个特殊符号"></a>4 个特殊符号</h6><ul>
<li><code>- + </code> : 最小和最大可能出现的 ID</li>
<li><code>$</code> : ￥ 只表示消费新的消息，当前流量中最大的ID，可用于将来要到来的 消息</li>
<li><code>&gt;</code> : 用于 xreadgroup 命令，表示迄今为止还没有发送给组中使用者的消息，会更新消费组的最后 ID </li>
<li><code>*</code> : 用于 xadd 命令，让系统自动生成 id</li>
</ul>
<h5 id="Redis-流-实例演示"><a href="#Redis-流-实例演示" class="headerlink" title="Redis 流 实例演示"></a>Redis 流 实例演示</h5><h6 id="队列相关指令-1"><a href="#队列相关指令-1" class="headerlink" title="队列相关指令"></a>队列相关指令</h6><ul>
<li><p><code>xadd </code></p>
<ul>
<li><p>添加消息到队列末尾</p>
</li>
<li><p>xadd 用于向 stream 队列中添加消息，如果指定的消息不存在，则该命令执行时会新建一个 Steam 队列</p>
</li>
<li><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309221059508.png"
                      alt="image-20230309221059508"
                ></p>
<ul>
<li><p><code>*</code> 号 表示服务器自动生成 MessageID（类似于MySQL中的 auto_increment） ，后面顺序跟着一堆业务 key&#x2F;value</p>
</li>
<li><p>信息条目指的是序列号，在相同的毫秒下序列号从0开始递增，序列号是64位长度，理论上在同一毫秒内生成的数据量无法到达这个级别，因此不用担心序列号会不够用。millisecondsTime指的是Redis节点服务器的本地时间，如果存在当前的毫秒时间戳比以前已经存在的数据的时间戳小的话（本地时间钟后跳），那么系统将会采用以前相同的毫秒创建新的ID，也即redis 在增加信息条目时会检查当前 id 与上一条目的 id， 自动纠正错误的情况，一定要保证后面的 id 比前面大，一个流中信息条目的ID必须是单调增的，这是流的基础。</p>
</li>
<li><p>客户端显示传入规则:</p>
<p>Redis对于ID有强制要求，格式必须是时间戳-自增Id这样的方式，且后续ID不能小于前一个ID</p>
</li>
<li><p>Stream的消息内容，也就是图中的Message Content它的结构类似Hash结构，以key-value的形式存在。</p>
</li>
</ul>
</li>
<li><p>消息 ID 必须比上个 ID 大</p>
</li>
<li><p>默认用 <code>*</code> 号 表示自动生成规则</p>
</li>
</ul>
</li>
<li><p><code>xrange</code></p>
<ul>
<li>用于获取消息列表（可以指定范围），忽略删除的内容</li>
<li>start ： 表示开始值， - 表示最小值</li>
<li>end : 表示结束值， + 表示最大值</li>
<li>count ： 表示最多获取多少个值</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309221514454.png"
                      alt="image-20230309221514454" style="zoom: 33%;" 
                ></li>
</ul>
</li>
<li><p><code>xrevrange</code> </p>
<ul>
<li>与 xrange 的区别在于，获取消息列表的方向是相反的 ，end 在前，start 在后</li>
</ul>
</li>
<li><p><code>xdel</code></p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309221625500.png"
                      alt="image-20230309221625500" style="zoom: 33%;" 
                ></li>
</ul>
</li>
<li><p><code>xlen</code></p>
<ul>
<li>用于获取 stream 队列消息的长度</li>
</ul>
</li>
<li><p><code>xtrim</code></p>
<ul>
<li>用于对 stream 长度进行截取，如 超长会被截取</li>
<li>MAXLEN <ul>
<li>允许的最大长度，对流进行修剪限制长度</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309221820721.png"
                      alt="image-20230309221820721" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li>MINID<ul>
<li>允许的最小 id,从 某个值开始比该 id 值小的将会被抛弃</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309221918376.png"
                      alt="image-20230309221918376" style="zoom:33%;" 
                ></li>
</ul>
</li>
</ul>
</li>
<li><p><code>xread</code></p>
<ul>
<li><p>用于 获取消息（阻塞&#x2F;非阻塞） ，只会返回大于指定 ID 的消息</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309222042352.png"
                      alt="image-20230309222042352" style="zoom: 33%;" 
                ></li>
<li>COUNT ： 最多读取多少条消息</li>
<li>BLOCK ： 是否 已阻塞的方式读取消息默认不阻塞，如果 millseconds 设置 为 0 ，表示永远阻塞</li>
</ul>
</li>
<li><p>非阻塞</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309222228782.png"
                      alt="image-20230309222228782"
                ></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309222258355.png"
                      alt="image-20230309222258355" style="zoom: 33%;" 
                ></li>
</ul>
</li>
<li><p>阻塞</p>
<ul>
<li>redis-cli  连接第二个 客户端</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309222343107.png"
                      alt="image-20230309222343107"
                ></li>
</ul>
</li>
<li><p>小总结（类似 Java 的 阻塞队列）</p>
<ul>
<li><p>Stream 的基础方法，使用 xadd 存入消息和 xread 循环阻塞读取消息的方式可以实现 简易版的 消息队列 ，交互过程如下</p>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309222458593.png"
                      alt="image-20230309222458593" style="zoom:50%;" 
                >

<p>对比 List 结构</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309222516902.png"
                      alt="image-20230309222516902" style="zoom: 33%;" 
                ></li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="消费者相关指令"><a href="#消费者相关指令" class="headerlink" title="消费者相关指令"></a>消费者相关指令</h6><p>&#x2F;&#x2F;TODO</p>
<h4 id="Redis-位域（bitfield）"><a href="#Redis-位域（bitfield）" class="headerlink" title="Redis 位域（bitfield）"></a>Redis 位域（bitfield）</h4><h5 id="是什么-2"><a href="#是什么-2" class="headerlink" title="是什么"></a>是什么</h5><p>官网 ： <a class="link"   target="_blank" rel="noopener" href="https://redis.com.cn/commands/bitfield.html" >https://redis.com.cn/commands/bitfield.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h5 id="能干嘛-1"><a href="#能干嘛-1" class="headerlink" title="能干嘛"></a>能干嘛</h5><ul>
<li>位域修改</li>
<li>溢出控制</li>
</ul>
<br>

<blockquote>
<p>将一个 Redis 字符串看做是 <strong><font color='red'>一个有二进制位组成的数组</font></strong>，并能对 变长位宽和任意没有字节对齐的指定整型位域进行寻址和修改</p>
</blockquote>
<h5 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230309223404208.png"
                      alt="image-20230309223404208" style="zoom: 33%;" 
                >

<p><code>BITFIELD key [GET type offset] [SET type offset value] [INCRBY type offset increment] [OVERFLOW WRAP|SAT|FAIL]</code></p>
<h3 id="Redis-持久化（RDB-AOF）"><a href="#Redis-持久化（RDB-AOF）" class="headerlink" title="Redis 持久化（RDB + AOF）"></a>Redis 持久化（RDB + AOF）</h3><hr>
<h4 id="总体介绍"><a href="#总体介绍" class="headerlink" title="总体介绍"></a>总体介绍</h4><p>redis 如何将数据写入硬盘</p>
<br>

<p>持久化是指将数据写入持久存储，例如 SSD（固态硬盘）。Redis 提供了 一系列持久化选项，这些包括：</p>
<ul>
<li>RDB （Redis Database 【redis 数据库】）：Redis 持久化以指定的时间间隔执行 数据集 的快照</li>
<li>AOF （Append Only file ） : AOF 持久化记录 服务器收到的每一个  写  操作。然后可以在 服务器启动时再次重放这些操作，重建原始数据集。使用与Redis 协议本身相同的格式记录命令</li>
<li>无持久化 ：可以完全禁用持久性，这有时在 缓存时使用</li>
<li>RDB + AOF ： 可以在 同一个案例下同时使用 RDB + AOF</li>
</ul>
<br>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310151651119.png"
                      alt="image-20230310151651119"
                ></p>
<h4 id="RDB-Redis-DataBase"><a href="#RDB-Redis-DataBase" class="headerlink" title="RDB (Redis DataBase)"></a>RDB (Redis DataBase)</h4><p>RDB 持久性以指定的时间间隔执行数据集的时间点快照</p>
<h5 id="能干嘛-2"><a href="#能干嘛-2" class="headerlink" title="能干嘛"></a>能干嘛</h5><ul>
<li>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的 snapshot 内存快照，它恢复时再将磁盘快照文件直接读回 内存中</li>
<li>redis 的数据都在内存中，保存备份时他执行的是 <strong>全量快照</strong>，也就是说，把内存中的所有数据都记录到 磁盘中，一锅端</li>
<li>rdb  保存的是 dump.rdb 文件</li>
</ul>
<h5 id="案例演示"><a href="#案例演示" class="headerlink" title="案例演示"></a>案例演示</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310105325930.png"
                      alt="image-20230310105325930" style="zoom:33%;" 
                >

<p>RDB 保存到磁盘的文件 叫 dump.rdb</p>
<br>

<p><strong>自动触发</strong></p>
<p>redis 6.0.16 以下</p>
<p>在 redis.conf 配置文件中的 snapshot 下配置 save 参数，来触发 redis 的 rdb 持久化条件，比如 <code>save m n </code> ： 表示 m 秒内 数据集存在 n 次修改时，自动触发 bgsave</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310152748384.png"
                      alt="image-20230310152748384"
                > </p>
<p>Redis 6.2  以及 redis 7.0.0</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310171018738.png"
                      alt="image-20230310171018738" style="zoom:50%;" 
                >



<h6 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h6><ul>
<li>自动触发<ul>
<li>redis 7版本 ，按照 redis.conf 里配置的 save <seconds> <changes><ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310171309483.png"
                      alt="image-20230310171309483" style="zoom:50%;" 
                ></li>
<li>修改 dump 文件保存路径<ul>
<li>默认<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310171505245.png"
                      alt="image-20230310171505245" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li>自定义修改的路径且可以进行 redis里用 config get dir 获取目录<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310171801493.png"
                      alt="image-20230310171801493" style="zoom:50%;" 
                ></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310172126770.png"
                      alt="image-20230310172126770" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li>修改 dump 文件名称<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310172237300.png"
                      alt="image-20230310172237300" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li>触发备份<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310172344836.png"
                      alt="image-20230310172344836" style="zoom: 33%;" 
                ></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310172404148.png"
                      alt="image-20230310172404148" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li>如何恢复<ul>
<li>将备份文件（dump.rdb） 移动到 redis 安装目录并启动服务即可</li>
<li>备份成功后故意用 flushdb 清空 redis,看是否可以恢复数据<ul>
<li>执行 flushall&#x2F;flushdb 命令也会产生 dump.rdb 文件。但里面是空的。无意义</li>
</ul>
</li>
<li>物理恢复，一定服务和备份 <strong>分机隔离</strong><ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310173458197.png"
                      alt="image-20230310173458197"
                ></li>
<li>备注 ： 不可以把 备份文件 dump.rdb 和生产 redis 服务器放在同一台机器，必须分开各自存储，以防生产机物理损坏后备份文件也挂了</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br>

<p><strong>手动触发</strong></p>
<ul>
<li><p>save 和 bgsave</p>
<ul>
<li><p>redis 提供了两个命令来生成 rdb 文件，分别是 save 和 bgsave</p>
</li>
<li><p>save</p>
<ul>
<li><p>在主程序中执行 <strong><font color='red'>会阻塞</font></strong> 当前 redis 服务器，直到持久化工作完成</p>
<p>执行 save 命令期间，redis 不能处理 其他命令，<strong><font color='red'>线上禁止使用</font></strong></p>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310174335493.png"
                      alt="image-20230310174335493" style="zoom: 50%;" 
                >
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310174355231.png"
                      alt="image-20230310174355231" style="zoom:67%;" 
                ></li>
</ul>
</li>
<li><p>bgsave （默认）</p>
<ul>
<li><p>redis 会在后台异步进行 快照操作， <strong><font color='red'>不阻塞</font></strong> 快照同时还可以快速响应客户端的请求，该触发方式会 fork 一个子进程，由子进程复制持久化过程</p>
</li>
<li><p>fork 是什么</p>
<ul>
<li><p>在 Linux 程序中，fork（）会产生 一个父进程完全相同的子进程，但子进程在此后多会 exec 系统调用，出于效率考虑，尽量避免膨胀</p>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310174957853.png"
                      alt="image-20230310174957853" style="zoom:67%;" 
                >

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310175023057.png"
                      alt="image-20230310175023057"
                ></p>
</li>
</ul>
</li>
<li><p>LASTSAVE </p>
<ul>
<li>可以 通过 lastsave 命令获取最后一次成功执行快照的时间</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="优势-1"><a href="#优势-1" class="headerlink" title="优势"></a>优势</h5><h6 id="官网说明"><a href="#官网说明" class="headerlink" title="官网说明"></a>官网说明</h6><ul>
<li>rdb 是 redis 数据 的一个非常紧凑的单文件时间点表示，RDB 文件非常是和备份，例如，您可能希望在 最近的 24小时内 每一个小时归档一次 RDB 文件，并在 30 天内每天保存一个 RDB 快照。这使您可以在发生灾难时轻松的恢复不同版本的数据集</li>
<li>RDB 非常适合灾难恢复，他是一个可以传输到远程数据中心 或 Amazon S3 （可能已加密）的压缩文件</li>
<li>RDB 最大限度地提高 了 Redis 的性能，因为 redis 父进程为了持久化而需要做的唯一工作就是派生一个将完成所有其余工作的子进程。父进程永远不会执行磁盘 I&#x2F;O 或类似的操作</li>
<li>与AOF相比，RDB 允许使用 大数据集更快的重启</li>
<li>在副本上，RDB支持 <strong>重启和故障转移后的部分重新同步</strong></li>
</ul>
<h6 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h6><ul>
<li>适合大规模的数据恢复</li>
<li>按照业务定时备份</li>
<li>对数据完整性和一致性要求不高</li>
<li>RDB 文件 在内存中的加载速度要比 AOF快得多</li>
</ul>
<h5 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h5><h6 id="官网说明-1"><a href="#官网说明-1" class="headerlink" title="官网说明"></a>官网说明</h6><ul>
<li>如果您需要在Redis停止工作时（例如断电后）将数据丢失的可能性降到最低，那么RDB并不好。您可以配置生成RDB的不同保存点（例如，在对数据集至少5分钟和100次写入之后，您可以有多个保存点）。但是，您通常会每五分钟或更长时间创建一次RDB快照，因此，如果Redis由于任何原因在没有正确关闭的情况下停止工作，您应该准备好丢失最新分钟的数据。</li>
<li>RDB需要经常fork0以便使用子进程在磁盘上持久化。如果数据集很大，fork()可能会很耗时，并且如果数据集很大并且CPU性能不是很好，可能会导致Redis停止为客户端服务几毫秒甚至一秒钟。AOF也需要fork()但频率较低，您可以调整要重写日志的频率，而不需要对持久性进行任何权衡。</li>
</ul>
<h6 id="小总结-1"><a href="#小总结-1" class="headerlink" title="小总结"></a>小总结</h6><ul>
<li>在一定间隔时间做一次备份，所以 如果redis 意外 down 掉的话，就会丢失从当前至最近一次快照期间的数据， <strong><font color='red'>快照之间的数据会丢失</font></strong></li>
<li>内存数据的全量同步，如果数据量太大会导致 I&#x2F;O 严重影响服务器的性能</li>
<li>RDB 依赖 主进程的 fork ，在更大的数据集中，这可能会导致服务器请求的瞬间延迟。fork 的时候内存中的数据被克隆了一份，大致 2 倍的膨胀性，需要考虑</li>
</ul>
<h5 id="如何-检查修复-dump-rdb-文件"><a href="#如何-检查修复-dump-rdb-文件" class="headerlink" title="如何 检查修复 dump.rdb 文件"></a>如何 检查修复 dump.rdb 文件</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310181547571.png"
                      alt="image-20230310181547571" style="zoom: 50%;" 
                >



<h5 id="那些情况会触发-rdb-快照"><a href="#那些情况会触发-rdb-快照" class="headerlink" title="那些情况会触发 rdb 快照"></a>那些情况会触发 rdb 快照</h5><ul>
<li>配置文件中默认的 快照配置</li>
<li>手动 save&#x2F;bgsave 命令</li>
<li>执行 flushdb&#x2F;flushall 命令也会产生 dump.rdb 文件，但里面是空的 ，无意义</li>
<li>执行 shutdown 且没有设置开启 AOF 持久化</li>
<li>主从复制时，主节点自动触发</li>
</ul>
<h5 id="如何禁用快照"><a href="#如何禁用快照" class="headerlink" title="如何禁用快照"></a>如何禁用快照</h5><ul>
<li>动态所有停止 rdb 保存规则的方法 <code>redis-cli config set save &quot;&quot;</code></li>
<li>快照禁用<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310181954382.png"
                      alt="image-20230310181954382" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
<h5 id="rdb-优化配置项详解"><a href="#rdb-优化配置项详解" class="headerlink" title="rdb 优化配置项详解"></a>rdb 优化配置项详解</h5><p>配置文件 snapshotting 模块</p>
<ul>
<li><code>save &lt;seconds&gt; &lt;changes&gt;</code></li>
<li><code>dbfilename</code></li>
<li><code>dir</code></li>
<li><code>stop-writes-on-bgsave-error</code><ul>
<li>默认 yes </li>
<li>如果配置为 no,表示你不在乎数据不一致或者有其他的手段发现和控制这种不一致，那么在快照写入失败时，也能保证 redis 继续接受新的写请求</li>
</ul>
</li>
<li><code>rdbcompression</code><ul>
<li>默认 yes</li>
<li>对于存储到硬盘中的快照，可以设置是否进行压缩存储。如果是的话，redis 会采用 LZF 算法进行压缩，如果你不想消耗 cpu 来进行压缩的话，可以设置关闭此功能</li>
</ul>
</li>
<li><code>rdbchecksum</code><ul>
<li>默认 yes</li>
<li>在 存储快照后，还可以让 redis 使用  CRC64 算法来进行数据校验，但是这样做会增加大约10 %  的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能</li>
</ul>
</li>
<li><code>rdb-del-sync-files</code><ul>
<li>在没有持久性的前提下删除复制中使用的 RDB文件启用，默认情况下为 no,此选项是禁用的</li>
</ul>
</li>
</ul>
<h5 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310182755358.png"
                      alt="image-20230310182755358" style="zoom:67%;" 
                >



<h4 id="AOF（Append-only-file）"><a href="#AOF（Append-only-file）" class="headerlink" title="AOF（Append only file）"></a>AOF（Append only file）</h4><h5 id="是什么-3"><a href="#是什么-3" class="headerlink" title="是什么"></a>是什么</h5><ul>
<li><strong><font color='red'>以日志的形式来吉林每个写操作</font></strong>，将 redis 执行过的所有写命令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis 启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</li>
<li>默认情况下，redis 是没有开启 AOF 的，开启AOF 功能需要设置配置 <code>appendonly yes</code></li>
</ul>
<br>

<blockquote>
<p><strong><font color='red'>AOF 保存的是 appendonly.aof 文件</font></strong> </p>
</blockquote>
<h5 id="AOF-持久化-工作流程"><a href="#AOF-持久化-工作流程" class="headerlink" title="AOF 持久化 工作流程"></a>AOF 持久化 工作流程</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310201153659.png"
                      alt="image-20230310201153659" style="zoom: 33%;" 
                >

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310201213908.png"
                      alt="image-20230310201213908"
                ></p>
<h5 id="AOF-缓冲区的三种写回策略"><a href="#AOF-缓冲区的三种写回策略" class="headerlink" title="AOF 缓冲区的三种写回策略"></a>AOF 缓冲区的三种写回策略</h5><h6 id="三种写策略"><a href="#三种写策略" class="headerlink" title="三种写策略"></a>三种写策略</h6><ul>
<li>Always<ul>
<li>同步写回，每个写命令执行完立刻将日志写回磁盘</li>
</ul>
</li>
<li>everysec<ul>
<li>每秒写回，每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区中，每隔 1 s 把缓冲区中的内容写入磁盘</li>
</ul>
</li>
<li>no<ul>
<li>操作系统控制的写回，每个写命令执行完，只是先把日志写到 AOF 文件的内容缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</li>
</ul>
</li>
</ul>
<br>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310201704195.png"
                      alt="image-20230310201704195" style="zoom: 33%;" 
                >



<h5 id="案例演示和说明"><a href="#案例演示和说明" class="headerlink" title="案例演示和说明"></a>案例演示和说明</h5><h6 id="配置文件说明（6-7）"><a href="#配置文件说明（6-7）" class="headerlink" title="配置文件说明（6 + 7）"></a>配置文件说明（6 + 7）</h6><p>如何开启 AOF</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310202127540.png"
                      alt="image-20230310202127540" style="zoom: 33%;" 
                >

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310202328514.png"
                      alt="image-20230310202328514"
                ></p>
<br>

<p>使用 默认写回策略，每秒钟</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310202445944.png"
                      alt="image-20230310202445944" style="zoom:50%;" 
                >

<br>

<p>aof 文件 - 保存路径</p>
<p>redis 6</p>
<ul>
<li>AOF 保存文件的位置和 RDB 保存文件的位置一样，都是通过 redis.conf 配置文件的 dir 配置</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310203049588.png"
                      alt="image-20230310203049588" style="zoom:67%;" 
                ></li>
</ul>
<br>

<p>redis 7</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310203116779.png"
                      alt="image-20230310203116779"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310203128686.png"
                      alt="image-20230310203128686"
                ></p>
<br>

<p>aof 文件 - 保存名称</p>
<p>redis 6</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310203301762.png"
                      alt="image-20230310203301762" style="zoom:50%;" 
                >

<p>有且只有一个</p>
<br>

<p>redis 7.0 MultiPart AOF 的设计</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310203405224.png"
                      alt="image-20230310203405224" style="zoom: 50%;" 
                >

<p>从Redis 7.0.0开始，当调度AOF重写时，Redis父进程打开一个新的增量AOF文件继续写入。子进程执行重写逻辑并生成新的基础AOF。Redis会使用一个临时清单文件来跟踪新生成的基础文件和增量文件。当它们准备就绪后，Redis将执行原子替换操作，使这个临时清单文件生效。为了避免AOF重写反复失败重试时创建很多增量文件的问题，Redis引入了AOF重写限制机制，保证失败的AOF重写重试的速度越来越慢。</p>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310204052313.png"
                      alt="image-20230310204052313" style="zoom:50%;" 
                >

<ul>
<li>base 基本文件</li>
<li>incr 增量文件</li>
<li>manifest 清单文件</li>
</ul>
</li>
<li><p>Redis 7.0 config 中对应的配置项</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310204214424.png"
                      alt="image-20230310204214424" style="zoom: 50%;" 
                ></li>
</ul>
</li>
</ul>
<h6 id="正常恢复"><a href="#正常恢复" class="headerlink" title="正常恢复"></a>正常恢复</h6><ul>
<li>启动 ： 设置 yes  修改默认的 <code>appendonly no </code> ，改为 yes</li>
<li>写操作继续，生成 AOF 文件到指定目录</li>
<li>恢复1 ： 重启 redis 然后重新加载，结果 OK</li>
<li>恢复2 <ul>
<li>写入数据进 redis，然后 flushdb + shutdown 服务器</li>
<li>新生成了  dump 和 aof</li>
<li>备份新生成 的 aof.bak，然后删除 dump&#x2F;aof 再看恢复<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310204747742.png"
                      alt="image-20230310204747742" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li>重启 redis 然后 重新加载试试?</li>
<li>停止服务器，拿出我们的备份修改后再重新启动服务器看看<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310204820165.png"
                      alt="image-20230310204820165" style="zoom: 33%;" 
                ></li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="异常恢复"><a href="#异常恢复" class="headerlink" title="异常恢复"></a>异常恢复</h6><ul>
<li>故意乱写正常的 AOF 文件，模拟网络闪断文件写 error </li>
<li>重启 redis 之后就会进入 AOF 文件的载入，发现启动都不行</li>
<li>异常修复命令 ： <code>redis-check-aof --fix </code> 进行修复</li>
<li>重新 OK</li>
</ul>
<h5 id="优势-2"><a href="#优势-2" class="headerlink" title="优势"></a>优势</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310205614892.png"
                      alt="image-20230310205614892" style="zoom:50%;" 
                >

<ul>
<li>使用AOF Redis更加持久：您可以有不同的fsync策略：根本不fsync、每秒fsync、每次查询时fsync。使用每秒fsync的默认策略，写入性能仍然很棒。fsync是使用后台线程执行的，当没有fsync正在进行时，主线程将努力执行写入，因此您只能丢失一秒钟的写入。</li>
<li>AOF 日志是一个仅附加日志，因此不会出现寻道问题，也不会在断电时出现损坏问题。即使由于某种原因（磁盘已满或其他原因）日志以写一半的命令结尾，redis-check-aof工具也能够轻松修复它。</li>
<li>当AOF变得太大时，Redis能够在后台自动重写AOF。重写是完全安全的，因为当Redis继续附加到旧文件时，会使用创建当前数据集所需的最少操作集生成一个全新的文件，一旦第二个文件准备就绪，Redis就会切换两者并开始附加到新的那一个。</li>
<li>AOF以易于理解和解析的格式依次包含所有操作的日志。您甚至可以轻松导出AOF文件。例如，即使您不小心使用该FLUSHALL命令刷新了所有内容，只要在此期间没有执行日志重写，您仍然可以通过停止服务器、删除最新命令并重新启动Redis来保存您的数据集，</li>
</ul>
<h5 id="劣势-1"><a href="#劣势-1" class="headerlink" title="劣势"></a>劣势</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230310210113921.png"
                      alt="image-20230310210113921" style="zoom: 50%;" 
                >

<ul>
<li>相同数据集的数据而言，aof文件要远大于 rdb 文件，恢复速度慢于 rdb</li>
<li>aof 运行效率要慢于 rdb,每秒的同步策略效率较好，不同步效率和 rdb 相同</li>
</ul>
<h5 id="AOF-重写机制"><a href="#AOF-重写机制" class="headerlink" title="AOF 重写机制"></a>AOF 重写机制</h5><p>由于 AOF 持久化是 redis 不断 将写命令记录到 AOF 文件中，随着 redis 不断的进行，AOF的文件会越来越大，文件越大，占用服务器内存越大以及 AOF 恢复 要求的时间也就越长</p>
<br>

<p>为了解决这个问题， <strong>redis 新增了重写机制</strong>，当 aof 文件的大小超过所设定的峰值时，redis 就会自动 启动 aof 文件的内容压缩，只保留可以恢复数据集的最小指令集</p>
<p>或者</p>
<p>可以 <strong>手动使用命令 <code>bgrewritedaof</code> 来重写</strong></p>
<br>

<blockquote>
<p>一句话 ： <strong>启动 aof 文件的内容压缩，只保留可以恢复数据集的最小指令集</strong></p>
</blockquote>
<h6 id="触发机制"><a href="#触发机制" class="headerlink" title="触发机制"></a>触发机制</h6><p>官网默认配置</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311113446953.png"
                      alt="image-20230311113446953" style="zoom: 33%;" 
                >

<p>注意 ： <strong>同时满足，且的关系</strong>  才会触发</p>
<ul>
<li>1 根据 上次重写 后的 aof 大小，判断当前 aof 大小是不是增长了 1 倍</li>
<li>2  重写时满足的文件大小</li>
</ul>
<br>

<p><strong>自动触发</strong></p>
<p>满足配置文件中的选项后，redis 会记录 上次重写时 的 aof 的大小，默认配置是 当aof 文件大小是上次 rewrite 后大小的一倍且文件大于 64 M 时</p>
<br>

<p><strong>手动触发</strong></p>
<p>客户端向服务器发送 <code>bgrewriteaof</code> 命令</p>
<h6 id="案例说明"><a href="#案例说明" class="headerlink" title="案例说明"></a>案例说明</h6><ul>
<li><p>需求说明</p>
<ul>
<li><p>启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集。</p>
<br>

<p>举个例子：比如有个key</p>
<p>一开始你setk1v1</p>
<p>然后改成setk1v2</p>
<p>最后改成setk1V3</p>
<p>如果不重写，那么这3条语句都在aof文件中，内容占空间不说启动的时候都要执行一遍，共计3条命令；</p>
<p>但是，我们实际效果只需要setk1V3这一条，所以，</p>
<p>开启重写后，只需要保存setk1v3就可以了只需要保留最后一次修改值，相当于给aof文件瘦身减肥，性能更好。</p>
<br>

<p>AOF重写不仅降低了文件的占用空间，同时更小的AOF也可以更快地被Redis加载。</p>
</li>
</ul>
</li>
<li><p>需求验证</p>
<ul>
<li>启动 aof 文件的内容压缩，只保留可以恢复数据的最小指令集</li>
</ul>
</li>
<li><p>步骤</p>
<ul>
<li><p>前期配置准备</p>
<ul>
<li><p>开启 aof</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311114131465.png"
                      alt="image-20230311114131465" style="zoom:33%;" 
                >
</li>
<li><p>重写 峰值修改为  1K</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311114205231.png"
                      alt="image-20230311114205231" style="zoom:33%;" 
                >
</li>
<li><p>关闭混合，设置为  no</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311114348093.png"
                      alt="image-20230311114348093" style="zoom:33%;" 
                >
</li>
<li><p>删除 之前的 全部 的aof 和 rdb，排除干扰项</p>
</li>
</ul>
</li>
<li><p>自动触发案例</p>
<ul>
<li><p>完成上述正确配置，重启 redis 服务器，执行 set k1 v1 ，查看 aof  文件是否正常</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311114557100.png"
                      alt="image-20230311114557100" style="zoom: 33%;" 
                >
</li>
<li><p>查看 三大配置文件</p>
<ul>
<li><p>配置项</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311114659669.png"
                      alt="image-20230311114659669" style="zoom:33%;" 
                >
</li>
<li><p>本次操作</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311114833549.png"
                      alt="image-20230311114833549" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li><p>k1 不停暴涨</p>
</li>
<li><p>触发重写</p>
</li>
</ul>
</li>
<li><p>手动触发案例</p>
<ul>
<li>客户端向服务器端发送 bgrewriteaof 命令</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311115314565.png"
                      alt="image-20230311115314565" style="zoom: 33%;" 
                ></li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="重写原理"><a href="#重写原理" class="headerlink" title="重写原理"></a>重写原理</h6><ol>
<li>在重写开始前，redis会创建一个“重写子进程”，这个子进程会读取现有的AOF文件，并将其包含的指令进行分析压缩并写入到一个临时文件中。</li>
<li>与此同时，主进程会将新接收到的写指令一边累积到内存缓冲区中，一边继续写入到原有的AOF文件中，这样做是保证原有的AOF文件的可用性避免在重写过程中出现意外。</li>
<li>当“重写子进程”完成重写工作后，它会给父进程发一个信号，父进程收到信号后就会将内存中缓存的写指令追加到新AOF文件中</li>
<li>当追加结束后，redis就会用新AOF文件来代替旧AOF文件，之后再有新的写指令，就都会追加到新的AOF文件中</li>
<li>重写aof文件的操作，并没有读取旧的aof文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的aof文件，这点和快照有点类似</li>
</ol>
<h5 id="AOF-优化配置项详解"><a href="#AOF-优化配置项详解" class="headerlink" title="AOF 优化配置项详解"></a>AOF 优化配置项详解</h5><p>配置文件 APPEND ONLY MODE  模块</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311115731747.png"
                      alt="image-20230311115731747" style="zoom:50%;" 
                >



<h5 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311115758363.png"
                      alt="image-20230311115758363" style="zoom:50%;" 
                >



<h4 id="RDB-AOF-混合持久化"><a href="#RDB-AOF-混合持久化" class="headerlink" title="RDB-AOF 混合持久化"></a>RDB-AOF 混合持久化</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311120335538.png"
                      alt="image-20230311120335538"
                ></p>
<h5 id="rdb-vs-aof"><a href="#rdb-vs-aof" class="headerlink" title="rdb vs aof"></a>rdb vs aof</h5><h6 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h6><ul>
<li>可否共存</li>
<li>如果共存听谁的</li>
</ul>
<h6 id="官网文档"><a href="#官网文档" class="headerlink" title="官网文档"></a>官网文档</h6><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311120518129.png"
                      alt="image-20230311120518129" style="zoom:33%;" 
                >



<h6 id="数据回恢复顺序-和-加载流程"><a href="#数据回恢复顺序-和-加载流程" class="headerlink" title="数据回恢复顺序 和  加载流程"></a>数据回恢复顺序 和  加载流程</h6><p><strong>在同时开启 rdb 和 aof 的时候，重启只会加载 aof 文件，不会加载 rdb 文件</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311120716237.png"
                      alt="image-20230311120716237" style="zoom:33%;" 
                >



<h5 id="怎么选"><a href="#怎么选" class="headerlink" title="怎么选"></a>怎么选</h5><ul>
<li>rdb 持久化方式能够在指定的时间的时间间隔能够对你的数据进行快照存储</li>
<li>aof 持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，aof 命令以redis 协议追加保存每次写的操作到文件末尾</li>
</ul>
<h5 id="同时开启两种持久化方式"><a href="#同时开启两种持久化方式" class="headerlink" title="同时开启两种持久化方式"></a>同时开启两种持久化方式</h5><ul>
<li>在这种情况下， **当redis 重启的时候会优先载入 aof 文件来恢复原始的数据，**因为在通常情况下，aof 文科， 保存的数据要比 rdb 文件保存的数据要完整</li>
<li>rdb 的数据不实时，同时使用两者时，服务器重启也只会找 aof 文件，<strong>那要不要 只使用 aof 呢，建议不要</strong>，因为 rdb 更适合用于备份数据库（aof 在不断变化，不好备份），留着 rdb 作为一个万一的手段</li>
</ul>
<h5 id="推荐方式"><a href="#推荐方式" class="headerlink" title="推荐方式"></a>推荐方式</h5><h6 id="rdb-aof-混合模式"><a href="#rdb-aof-混合模式" class="headerlink" title="rdb + aof 混合模式"></a>rdb + aof 混合模式</h6><p>结合了 rdb 和 aof 的优点，既能快速加载又能避免丢失过多的数据</p>
<h6 id="开启混合方式设置"><a href="#开启混合方式设置" class="headerlink" title="开启混合方式设置"></a>开启混合方式设置</h6><p>设置 <code>aof-use-rdb-preamble</code> 的值为 yes yes 表示开启，设置no 表示禁用</p>
<h6 id="rdb-aof-的混合模式-结论"><a href="#rdb-aof-的混合模式-结论" class="headerlink" title="rdb + aof 的混合模式 结论"></a>rdb + aof 的混合模式 结论</h6><p><strong><font color='cornflowerblue'>rdb 镜像做全量持久化，aof 做增量持久化</font></strong></p>
<p>先使用 rdb 进行快照存储，然后使用 aof 持久化所有的写操作，当重写策略满足或手动触发重写的时候， <strong><font color='red'>将最新的数据存储为新的 rdb 记录</font></strong>。这样的话，重启服务器的时候，会从rdb + aof  两部分恢复数据，既保证了数据完整性，又保证了恢复数据的性能，简单来说， <strong>混合持久化方式产生的文件一部分是 rdb 格式，一部分是 aof 格式</strong>  —— &gt; <strong><font color='red'>aof  包括了 rdb 头部 + aof 混写</font></strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311122600508.png"
                      alt="image-20230311122600508" style="zoom:33%;" 
                >



<h5 id="纯缓存模式"><a href="#纯缓存模式" class="headerlink" title="纯缓存模式"></a>纯缓存模式</h5><h6 id="同时关闭rdb-aof"><a href="#同时关闭rdb-aof" class="headerlink" title="同时关闭rdb + aof"></a>同时关闭rdb + aof</h6><ul>
<li><code>save &quot;&quot;</code> <ul>
<li>禁用 rdb</li>
<li>禁用 rdb 持久化模式下，我们仍然可以使用命令 save，bgsave 生成 rdb 文件</li>
</ul>
</li>
<li><code>appendonly no</code> <ul>
<li>禁用 aof</li>
<li>禁用 aof 持久化模式下，我们仍然可以 使用 命令 byrewriteaof  生成 aof 文件</li>
</ul>
</li>
</ul>
<h3 id="Redis-事务（transactional）"><a href="#Redis-事务（transactional）" class="headerlink" title="Redis 事务（transactional）"></a>Redis 事务（transactional）</h3><hr>
<p>Redis Transactions allow the execution of a group of commands in a single step, they are centered around the commands <a target="_blank" rel="noopener" href="https://redis.io/commands/multi"><code>MULTI</code></a>, <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a>, <a target="_blank" rel="noopener" href="https://redis.io/commands/discard"><code>DISCARD</code></a> and <a target="_blank" rel="noopener" href="https://redis.io/commands/watch"><code>WATCH</code></a>. Redis Transactions make two important guarantees:</p>
<ul>
<li>All the commands in a transaction are serialized and executed sequentially. A request sent by another client will never be served <strong>in the middle</strong> of the execution of a Redis Transaction. This guarantees that the commands are executed as a single isolated operation.</li>
<li>The <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> command triggers the execution of all the commands in the transaction, so if a client loses the connection to the server in the context of a transaction before calling the <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> command none of the operations are performed, instead if the <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> command is called, all the operations are performed. When using the <a class="link"   target="_blank" rel="noopener" href="https://redis.io/topics/persistence#append-only-file" >append-only file<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> Redis makes sure to use a single write(2) syscall to write the transaction on disk. However if the Redis server crashes or is killed by the system administrator in some hard way it is possible that only a partial number of operations are registered. Redis will detect this condition at restart, and will exit with an error. Using the <code>redis-check-aof</code> tool it is possible to fix the append only file that will remove the partial transaction so that the server can start again.</li>
</ul>
<p>Starting with version 2.2, Redis allows for an extra guarantee to the above two, in the form of optimistic locking in a way very similar to a check-and-set (CAS) operation. This is documented <a class="link"   target="_blank" rel="noopener" href="https://redis.io/docs/manual/transactions/#cas" >later<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> on this page.</p>
<br>

<p>redis 事务允许在单个步骤中执行一组命令，他们以 命令 <code>MULTI、EXEC、DISCARD 和 WATCH</code> 为中心。Redis 事务有两个重要的保证 ：  </p>
<ul>
<li>事务中 的所有命令都被序列化并按顺序执行。另一个客户端发送的请求永远不会在 redis 事务<strong>执行过程中</strong> 得到处理。这保证了命令作为单个独立操作执行 </li>
<li>该 <code>exec</code> 命令触发 事务中所有命令的执行，因此如果客户端在调用命令之前在事务上下文中失去与服务器的连接，则不会 exec 执行任何操作，相反，如果 exec 调用命令，则所有操作执行。使用  append-only file 文件时，redis 确保 单个 write（2） 系统调用将事务写入磁盘。但是，如果 redis 服务器崩溃或被系统管理员以某种方式杀死，则可能只注册了部分操作。Redis 会在重启时 检测到这种情况，并会报错退出。这用 <code>redis-check-aof</code> 工具可以 修复将删除部分事务的 append-only file ，以便服务器可以重新启动</li>
</ul>
<br>

<blockquote>
<p> 从 2.2 开始，redis 允许对上述两者 提供额外保证，其形式为 乐观锁，其方式与检查和设置（CAS） 操作 非常相似</p>
</blockquote>
<br>

<p>可以一次执行多个命令，本质是一组命令的集合。一个事务中的所有命令都会序列化， <strong><font color='red'>按顺序地串行化执行</font>而不会被其他命令插入，不许加塞</strong></p>
<h4 id="能干嘛-3"><a href="#能干嘛-3" class="headerlink" title="能干嘛"></a>能干嘛</h4><p>一个队列中，一次性、顺序性、排他性的执行一系列命令</p>
<h4 id="Redis-事务-Vs-数据库事务"><a href="#Redis-事务-Vs-数据库事务" class="headerlink" title="Redis 事务 Vs 数据库事务"></a>Redis 事务 Vs 数据库事务</h4><ol>
<li><p>单独的隔离操作</p>
<p>redis的 事务仅仅是保证事务里的操作会被连续独占的执行，redis 命令执行是 单线程架构，在执行完事务内所有指令前是不可能再去同时执行其他客户端的请求的 </p>
</li>
<li><p>没有隔离级别的概念</p>
<p>因为 事务提交前任何执行都不会被实际执行，也就不存在  “事务内的查询要看到事务里的更新，在事务外查询不能看到”  这种问题了</p>
</li>
<li><p>不保证原子性</p>
<p>redis的事务 <strong>不保证原子性</strong>，也就是不保证所有的指令同时失败或同时成功，只有决定是否开始执行全部指令的能力，没有执行到一半进行回滚的能力</p>
</li>
<li><p>排他性</p>
<p>redis 会保证一个事务内的命令依次执行，而不会被其他命令插入</p>
</li>
</ol>
<h4 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h4><table>
<thead>
<tr>
<th>1</th>
<th>discard</th>
<th>取消事务，放弃执行事务块内的所有命令</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>exec</td>
<td>执行所有事务块内的命令</td>
</tr>
<tr>
<td>3</td>
<td>multi</td>
<td>标记一个事务块的开始</td>
</tr>
<tr>
<td>4</td>
<td>unwatch</td>
<td>取消 watch 命令对所有 key 的监视</td>
</tr>
<tr>
<td>5</td>
<td>watch key [key…]</td>
<td>监视一个或多个key ,如果在事务执行之前这个或这些 key 被其他命令所改动，那么事务将会被打断</td>
</tr>
</tbody></table>
<br>

<ul>
<li><p>正常执行</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311134915817.png"
                      alt="image-20230311134915817" style="zoom:33%;" 
                >

<ul>
<li>MULTI</li>
<li>EXEC</li>
</ul>
</li>
<li><p>放弃事务</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311135003940.png"
                      alt="image-20230311135003940" style="zoom:33%;" 
                >

<ul>
<li>MULTI</li>
<li>DISCARD</li>
</ul>
</li>
<li><p>全体连坐</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311135057916.png"
                      alt="image-20230311135057916" style="zoom:33%;" 
                >

<ul>
<li>During a transaction it is possible to encounter two kind of command errors:</li>
<li><strong>A command may fail to be queued, so there may be an error before <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> is called. For instance the command may be syntactically wrong (wrong number of arguments, wrong command name, …), or there may be some critical condition like an out of memory condition (if the server is configured to have a memory limit using the <code>maxmemory</code> directive).</strong><ul>
<li><strong>命令可能无法排队，因此在 <code>exec</code> 之前可能会出现错误。 例如，该命令可能是句法上错误的（参数的数量错误，命令名称错误，…），或者可能存在某些关键条件（例如，如果服务器配置为使用<code> maxmemory</code>指令）。</strong></li>
</ul>
</li>
<li>A command may fail <em>after</em> <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> is called, for instance since we performed an operation against a key with the wrong value (like calling a list operation against a string value).</li>
</ul>
</li>
<li><p>冤头债主</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311135416687.png"
                      alt="image-20230311135416687" style="zoom:33%;" 
                >

<ul>
<li><p>Errors happening <em>after</em> <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> instead are not handled in a special way: all the other commands will be executed even if some command fails during the transaction.</p>
<p>This is more clear on the protocol level. In the following example one command will fail when executed even if the syntax is right:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to localhost.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">MULTI</span><br><span class="line">+OK</span><br><span class="line">SET a abc</span><br><span class="line">+QUEUED</span><br><span class="line">LPOP a</span><br><span class="line">+QUEUED</span><br><span class="line">EXEC</span><br><span class="line">*2</span><br><span class="line">+OK</span><br><span class="line">-ERR Operation against a key holding the wrong kind of value</span><br></pre></td></tr></table></figure></div>

<p><a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> returned two-element <a class="link"   target="_blank" rel="noopener" href="https://redis.io/topics/protocol#bulk-string-reply" >bulk string reply<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> where one is an <code>OK</code> code and the other an <code>-ERR</code> reply. It’s up to the client library to find a sensible way to provide the error to the user.</p>
<p><strong>It’s important to note that <font color='red'>even when a command fails, all the other commands in the queue are processed</font> – Redis will <em>not</em> stop the processing of commands.</strong></p>
</li>
<li><p>补充 ： Redis does not support rollbacks of transactions since supporting rollbacks would have a significant impact on the simplicity and performance of Redis.</p>
<ul>
<li>redis <strong>不提供事务回滚</strong>的功能，开发者必须在事务执行出错后，<strong>自行</strong>恢复数据库状态</li>
</ul>
</li>
<li><p>注意与传统数据库事务的区别，不一定要么一起成功，要么一起失败</p>
</li>
</ul>
</li>
<li><p>WATCH 监控</p>
</li>
<li><p>redis 使用 watch 来提供乐观锁，类似于 CAS（check-and-set）</p>
<ul>
<li><p>悲观锁（Pessimistic Lock）</p>
<p>顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 block 直到 它拿到 锁</p>
</li>
<li><p>乐观锁（Optimistic Lock）</p>
<p>顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会被 修改，<strong>所以不上锁</strong>，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据</p>
<ul>
<li><p>乐观锁策略 ：</p>
<p><strong><font color='red'>提交版本必须大于 记录当前版本才能执行更新</font></strong></p>
</li>
</ul>
</li>
<li><p>CAS （check-and-set）</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/watch"><code>WATCH</code></a> is used to provide a check-and-set (CAS) behavior to Redis transactions.</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/watch"><code>WATCH</code></a>ed keys are monitored in order to detect changes against them. If at least one watched key is modified before the <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> command, the whole transaction aborts, and <a target="_blank" rel="noopener" href="https://redis.io/commands/exec"><code>EXEC</code></a> returns a <a class="link"   target="_blank" rel="noopener" href="https://redis.io/topics/protocol#nil-reply" >Null reply<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> to notify that the transaction failed.</p>
<ul>
<li><p>[<code>watch</code>]  用于为REDIS交易提供检查和核算行为。</p>
<p>[<code>watch</code>]  ED键进行监视以检测针对它们的更改。 如果在[<code>exec</code>]  命令之前修改了至少一个 <strong>watched</strong> 键，则整个事务中止和 return a Null ，以通知交易是否失败。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>watch</p>
</li>
</ul>
<pre><code>- 初始化 k1 和 balance 两个key,先监控 再开启 multi，保证 两个 key 变动在同一个事务内

- 有加塞篡改

  - watch 命令 是一种 乐观锁的实现，redis 在修改的时候 ，会检测数据是否被更改，如果更改了，则执行失败，第一个窗口 蓝框 step5 返回结果为 nil ，也就是相当于失败

    &lt;img src=&quot;https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311141641622.png&quot; alt=&quot;image-20230311141641622&quot; style=&quot;zoom: 33%;&quot; /&gt;

    详细见 上 CAS 说明

- unwatch

  &lt;img src=&quot;https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311142103904.png&quot; alt=&quot;image-20230311142103904&quot; style=&quot;zoom:33%;&quot; /&gt;

- 小结

  - 一旦执行了 exec 之前加的 监控锁 都会被取消掉了
  - 当客户端连接丢失的时候（比如退出连接），所有东西都会被取消监控
</code></pre>
<h4 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h4><ul>
<li>开启 ： 以 <code>MULTI </code> 开启一个事务</li>
<li>入队 ： 将多个命令入队到 事务中，接到这些命令并不会立即执行，而是放到等待执行的 事务队列 里面</li>
<li>执行 ： 由  <code>exec</code> 命令触发命令</li>
</ul>
<h3 id="Redis-管道（pipelining）"><a href="#Redis-管道（pipelining）" class="headerlink" title="Redis 管道（pipelining）"></a>Redis 管道（pipelining）</h3><hr>
<p>面试题</p>
<ul>
<li><p>如何优化频繁命令往返造成的性能瓶颈</p>
</li>
<li><p>问题由来</p>
<ul>
<li><p>Redis 是基于 <strong>客户端-服务端模型</strong> 以及请求&#x2F;响应协议的 TCP 服务。一个请求会遵循以下步骤</p>
<ul>
<li><p>客户端向服务器端发送命令分四步（发送命令 -&gt; 命令排队 -&gt; 命令执行 -&gt; 返回结果），并监听 Socket 返回，通常以阻塞模式等待服务端响应</p>
</li>
<li><p>服务端处理命令，并将借个车返回给客户端</p>
</li>
<li><p><font color='red'>上述 两步 称为 ：</font> <strong><font color='red'>Round Trip Time （简称 RTT，数据包往返于两端之间的时间）</font></strong></p>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311143439653.png"
                      alt="image-20230311143439653" style="zoom:33%;" 
                >


</li>
<li><p>如果同时需要执行大量的命令，那么就要等待上一条命令应答后再执行，这中间不仅仅多了RTT（Round Time Trip），而且还频繁调用系统IO，发送网络请求，同时需要redis调用多次read()和write()系统方法，系统方法会将数据从用户态转移到内核态，这样就会对进程上下文有比较大的影响了，性能不太好</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="是什么-4"><a href="#是什么-4" class="headerlink" title="是什么"></a>是什么</h4><h5 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h5><p>引出 <strong>管道</strong> 这个概念</p>
<p>管道（pipeline） 可以一次性发送多条命令给服务器端，服务器端一次处理完毕后， <strong>通过一条响应一次性将结果返回，通过减少客户端与 redis 的通信次数来实现降低往返延时时间</strong>。 pipeline 实现的原理是 队列，先进先出 特性就保证了 数据的顺序性</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311143804152.png"
                      alt="image-20230311143804152" style="zoom:33%;" 
                >

<br>

<p>Redis pipelining is a technique for improving performance by issuing multiple commands at once without waiting for the response to each individual command. Pipelining is supported by most Redis clients. </p>
<p>REDIS管道是一种通过立即发出多个命令而无需等待每个单独命令的响应来提高性能的技术。 pipeline 被很多 redis client 所支持。</p>
<br>

<p>pipeline 是为了解决 RTT 往返时，仅仅是将命令打包一次性发送，对整个 redis 的执行不造成 其他的影响</p>
<br>

<blockquote>
<p> <strong><font color='red'>批处理命令变种优化措施</font></strong>，类似 redis 的原生批命令（mget、mset）</p>
</blockquote>
<h5 id="案例演示-1"><a href="#案例演示-1" class="headerlink" title="案例演示"></a>案例演示</h5><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311144334770.png"
                      alt="image-20230311144334770"
                ></p>
<h5 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h5><h6 id="pipeline-与原生批命令对比"><a href="#pipeline-与原生批命令对比" class="headerlink" title="pipeline 与原生批命令对比"></a>pipeline 与原生批命令对比</h6><ul>
<li>原生批命令是 原子性的（mget、mset）,<strong>pipelining 是非原子性的</strong></li>
<li>原生批命令一次只能执行一种命令，pipelining 支持批量执行不同的命令</li>
<li>原生批命令是服务端实现，而 pipelining 需要服务器端与客户端共同完成</li>
</ul>
<h6 id="pipelining-与-事务-对比"><a href="#pipelining-与-事务-对比" class="headerlink" title="pipelining 与 事务 对比"></a>pipelining 与 事务 对比</h6><ul>
<li>事务具有原子性，管道不具有原子性</li>
<li>管道一次性将多条命令发送给服务器，事务是一条一条的发，事务只有在接收到 exec 命令才会执行，管道不会</li>
<li>执行事务时 会阻塞其他命令的执行，而执行管道中的命令时不会</li>
</ul>
<h6 id="使用-pipelining-的注意事项"><a href="#使用-pipelining-的注意事项" class="headerlink" title="使用 pipelining 的注意事项"></a>使用 pipelining 的注意事项</h6><ul>
<li>pipelining 缓冲的执行只是会依次执行，不保证原子性，如果执行中执行发生异常，将会继续执行后续的命令</li>
<li>使用 pipelining 组装的命令个数不能太多，不然数据量过大，客户端阻塞阻塞的时间可能过久，同时服务器端此时也被迫回复一个队列答复，占用很多内存</li>
</ul>
<h3 id="Redis-发布-订阅（pub-sub）"><a href="#Redis-发布-订阅（pub-sub）" class="headerlink" title="Redis 发布&#x2F;订阅（pub&#x2F;sub）"></a>Redis 发布&#x2F;订阅（pub&#x2F;sub）</h3><hr>
<p>学习定位 : 了解即可</p>
<h4 id="是什么-5"><a href="#是什么-5" class="headerlink" title="是什么"></a>是什么</h4><h5 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h5><p>是一种消息通信模式： 发送者（PUBLISH)发送消息，订阅者（SUBSCRIBE)接收消息，可以实现进程间的消息传递</p>
<h5 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h5><p><a target="_blank" rel="noopener" href="https://redis.io/commands/subscribe"><code>SUBSCRIBE</code></a>, <a target="_blank" rel="noopener" href="https://redis.io/commands/unsubscribe"><code>UNSUBSCRIBE</code></a> and <a target="_blank" rel="noopener" href="https://redis.io/commands/publish"><code>PUBLISH</code></a> implement the <a class="link"   target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Publish/subscribe" >Publish&#x2F;Subscribe messaging paradigm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> where (citing Wikipedia) senders (publishers) are not programmed to send their messages to specific receivers (subscribers). Rather, published messages are characterized into channels, without knowledge of what (if any) subscribers there may be. Subscribers express interest in one or more channels, and only receive messages that are of interest, without knowledge of what (if any) publishers there are. This decoupling of publishers and subscribers can allow for greater scalability and a more dynamic network topology.</p>
<p>订阅，取消订阅和发布实施发布&#x2F;订阅消息范式，其中（引用Wikipedia）发件人（发布者）未编程以将其消息发送给特定的接收器（订阅者）。 相反，已发布的消息被描述为渠道，而不知道可能有什么（如果有）。 订阅者在一个或多个渠道中表达了兴趣，并且仅接收感兴趣的消息，而没有知道有什么（如果有）出版商的消息。 发布者和订户的这种解耦可以使更大的可扩展性和更动态的网络拓扑结构。</p>
<br>

<blockquote>
<p>redis 可以实现消息中间件 MQ 的功能，通过发布&#x2F;订阅 实现消息的引导和分流。但是不推荐使用该功能，专业的事情交给专业的中间件处理，redis 就做 分布式缓存功能</p>
</blockquote>
<h4 id="能干嘛-4"><a href="#能干嘛-4" class="headerlink" title="能干嘛"></a>能干嘛</h4><p>redis 客户端可以订阅任意数量的频道，类似于我们的微信可以关注很多的公众号</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311151937817.png"
                      alt="image-20230311151937817" style="zoom:50%;" 
                >

<p>当有消息 通过 PUBLISH 命令 发送给频道 channel 1  时</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311152021596.png"
                      alt="image-20230311152021596" style="zoom:33%;" 
                >



<h5 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h5><p>发布&#x2F;订阅 其实是一个轻量的队列，只不过数据不会被持久化，一般用来处理  <strong>实时性较高的异步消息</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311153829678.png"
                      alt="image-20230311153829678" style="zoom:33%;" 
                >

<h4 id="常用命令-3"><a href="#常用命令-3" class="headerlink" title="常用命令"></a>常用命令</h4><ul>
<li><code>subscribe channel [channel ...]</code><ul>
<li>订阅给定的一个或多个频道的信息</li>
<li><strong>推荐先 执行订阅后再发布，订阅成功之前发布的消息是收不到的</strong></li>
<li>订阅的客户端每次可以收到一个 3 个参数的消息<ul>
<li>消息的种类</li>
<li>始发频道的名称</li>
<li>实际消息内容</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311154315851.png"
                      alt="image-20230311154315851" style="zoom:33%;" 
                ></li>
</ul>
</li>
</ul>
</li>
<li><code>publish channel message</code><ul>
<li>发布信息到指定频道</li>
</ul>
</li>
<li><code>psubscribe pattern [pattern ...]</code><ul>
<li>按照模式 批量订阅，订阅一个或多个符合给定模式（支持 * 号 ？ 号 之类的） 的频道</li>
</ul>
</li>
<li><code>pubsub subcommand [argument[argument...]]</code><ul>
<li>查看订阅与发布系统状态</li>
<li><code>pubsub channels </code><ul>
<li>由活跃频道组成的列表</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311154604730.png"
                      alt="image-20230311154604730" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li><code>pubsub numsub [channel [channel...]]</code><ul>
<li>某个频道有几个订阅者</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311154654125.png"
                      alt="image-20230311154654125" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li><code>pubsub numpat</code><ul>
<li>只统计使用 psubscribe 命令执行的，返回客户端订阅的唯一 <strong>模式的数量</strong></li>
</ul>
</li>
</ul>
</li>
<li><code>unsubscribe [channel [channel ...]]</code><ul>
<li>取消订阅</li>
</ul>
</li>
<li><code>punsubscribe [pattern [pattern ...]]</code><ul>
<li>退订所有给定模式的频道</li>
</ul>
</li>
</ul>
<h4 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h4><h5 id="Pub-sub-的-缺点"><a href="#Pub-sub-的-缺点" class="headerlink" title="Pub&#x2F;sub 的 缺点"></a>Pub&#x2F;sub 的 缺点</h5><ul>
<li>发布的信息在redis 系统不能持久化，因此必须 先执行订阅，再等待消息发布。如果先发布了 消息，那么该消息由于没有订阅者，消息将直接被丢弃</li>
<li>消息只管发送对应发布者而言 消息是即发即失的，不管接收，也没有 ack 机制，无法保证消息的消费成功</li>
<li>以上的缺点导致 redis 的 pub&#x2F;sub 就是像是个 小玩具，在生产环境中几乎无任何用武之地，为此 redis 5.0 版本新增了 stream 数据结构，不但支持多播，还支持数据持久化，相比 pub&#x2F;sub 更加强大</li>
</ul>
<h3 id="Redis-复制（replication）"><a href="#Redis-复制（replication）" class="headerlink" title="Redis 复制（replication）"></a>Redis 复制（replication）</h3><hr>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311155500746.png"
                      alt="image-20230311155500746" style="zoom:33%;" 
                >

<p>At the base of Redis replication (excluding the high availability features provided as an additional layer by Redis Cluster or Redis Sentinel) there is a <em>leader follower</em> (master-replica) replication that is simple to use and configure. It allows replica Redis instances to be exact copies of master instances. The replica will automatically reconnect to the master every time the link breaks, and will attempt to be an exact copy of it <em>regardless</em> of what happens to the master.</p>
<p>在Redis复制的基础上（不包括Redis Cluster或Redis Sentinel提供的额外层的高可用性功能），有一个易于使用和配置的领导者追随者（Master-Replica）复制。 它允许REPIS REDIS实例是主实例的确切副本。 每次链接断开时，复制品都会自动重新连接到主人，并尝试成为其确切的副本，无论主人发生了什么。</p>
<br>

<blockquote>
<p>就是 <strong>主从复制</strong>， master 以写为主，slave 以读为主</p>
<p>当 master 数据变化时，自动将新的数据异步同步到其他的 slave 数据库</p>
</blockquote>
<h4 id="能干嘛-5"><a href="#能干嘛-5" class="headerlink" title="能干嘛"></a>能干嘛</h4><ul>
<li>读写分离</li>
<li>容灾恢复</li>
<li>数据备份</li>
<li>水平扩容支撑高并发</li>
</ul>
<h4 id="怎么用"><a href="#怎么用" class="headerlink" title="怎么用"></a>怎么用</h4><h6 id="配从（库）不配主（库）"><a href="#配从（库）不配主（库）" class="headerlink" title="配从（库）不配主（库）"></a>配从（库）不配主（库）</h6><h6 id="权限细节，重要"><a href="#权限细节，重要" class="headerlink" title="权限细节，重要"></a>权限细节，重要</h6><ul>
<li>master 如果配置了 requirepass 参数，需要密码登陆</li>
<li>那么 slave 就要配置 masterauth 来设置 校验密码，否则的话 master 会拒绝 slave 的访问请求<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311163412295.png"
                      alt="image-20230311163412295" style="zoom:33%;" 
                ></li>
</ul>
</li>
</ul>
<h6 id="基本操作命令"><a href="#基本操作命令" class="headerlink" title="基本操作命令"></a>基本操作命令</h6><ul>
<li><p><code>info replication</code></p>
<p>可以查看 复制节点的主从关系 和 配置信息</p>
</li>
<li><p><code>replicaof 主库ip 主库端口</code></p>
<ul>
<li>一般 写入进 redis.conf 的配置文件内</li>
</ul>
</li>
<li><p><code>slaveof 主库ip 主库端口 </code></p>
<ul>
<li>每次与  master 断开之后，都需要重新连接，除非你配置进 redis.conf 中</li>
<li>在运行期间 修改 slave节点的信息，如果该数据库已经是某一个主数据库的从数据库，那么会停止和源主数据库的同步关系 <strong><font color='red'>转而和新的主数据库同步</font></strong></li>
</ul>
</li>
<li><p><code>slaveof no one</code></p>
<ul>
<li>使当前数据库停止与其他数据库的同步， <strong><font color='red'>转为主数据库</font></strong></li>
</ul>
</li>
</ul>
<h4 id="案例演示-2"><a href="#案例演示-2" class="headerlink" title="案例演示"></a>案例演示</h4><h5 id="架构说明"><a href="#架构说明" class="headerlink" title="架构说明"></a>架构说明</h5><ul>
<li>一个 Master 两个 Slave<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311165425992.png"
                      alt="image-20230311165425992" style="zoom:33%;" 
                ></li>
<li>三台虚拟机都安装 redis</li>
</ul>
</li>
<li>拷贝多个 redis.conf 文件<ul>
<li>redis6379.conf</li>
<li>redis6380.conf</li>
<li>redis6381.conf</li>
</ul>
</li>
</ul>
<h5 id="口诀"><a href="#口诀" class="headerlink" title="口诀"></a>口诀</h5><ul>
<li>三边网络相互 ping 通，且注意 防火墙配置</li>
<li>三大命令<ul>
<li>主从复制<ul>
<li><code>replicaof 主库ip 主库端口</code></li>
<li>配从（库）不配主（库）</li>
</ul>
</li>
<li>改换门庭<ul>
<li><code>slaveof 新主库ip 新主库端口</code></li>
</ul>
</li>
<li>自立为王<ul>
<li><code>slaveof no one</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="修改配置文件细节操作"><a href="#修改配置文件细节操作" class="headerlink" title="修改配置文件细节操作"></a>修改配置文件细节操作</h5><p>redis6379.conf 为例</p>
<ol>
<li><p>开启  <code>daemonize yes</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311170108402.png"
                      alt="image-20230311170108402" style="zoom:50%;" 
                >
</li>
<li><p>注释掉 <code>bind 127.0.0.1</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311170247155.png"
                      alt="image-20230311170247155" style="zoom:50%;" 
                >
</li>
<li><p><code>protected-mode no</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311170510847.png"
                      alt="image-20230311170510847" style="zoom:50%;" 
                >
</li>
<li><p>指定端口</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311170549390.png"
                      alt="image-20230311170549390" style="zoom: 67%;" 
                >
</li>
<li><p>指定当前工作目录  dir</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311170747641.png"
                      alt="image-20230311170747641"
                ></p>
</li>
<li><p>pid 文件名字， logfile</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311171115913.png"
                      alt="image-20230311171115631"
                ></p>
</li>
<li><p>log 文件名字，logfile</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311171331006.png"
                      alt="image-20230311171331006"
                ></p>
</li>
<li><p>requirepass </p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311171922852.png"
                      alt="image-20230311171922852"
                ></p>
</li>
<li><p>dump.rdb 名字</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311172032044.png"
                      alt="image-20230311172032044"
                ></p>
</li>
<li><p>aof 文件，appendfilename</p>
</li>
</ol>
<pre><code>&lt;img src=&quot;https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311172108222.png&quot; alt=&quot;image-20230311172108222&quot; style=&quot;zoom:33%;&quot; /&gt;
</code></pre>
<ol start="11">
<li><p><strong>从机 访问 主机 的通行密码 <code>masterauth</code> 必须</strong></p>
<ul>
<li>从机需要配置，主机不需要</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311172422569.png"
                      alt="image-20230311172422569"
                ></li>
</ul>
</li>
</ol>
<h5 id="常用-6"><a href="#常用-6" class="headerlink" title="常用"></a>常用</h5><h6 id="一主二仆"><a href="#一主二仆" class="headerlink" title="一主二仆"></a>一主二仆</h6><ul>
<li><p>方案 1 ： 配置文件固定写死</p>
<ul>
<li><p>配置执行</p>
<ul>
<li><code>replicaof 主机ip 主库端口</code></li>
</ul>
</li>
<li><p>配从（库）不配主（库）</p>
<ul>
<li><p>配置从机 6380</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202003826.png"
                      alt="image-20230311202003826" style="zoom:50%;" 
                >
</li>
<li><p>配置从机 6381</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202020172.png"
                      alt="image-20230311202020172" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>先 master 后 两台 slave 依次启动</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202442137.png"
                      alt="image-20230311202442137" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>主从关系查看</p>
<ul>
<li><p>日志</p>
<ul>
<li><p>主机日志</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202708291.png"
                      alt="image-20230311202708291"
                ></p>
</li>
<li><p>备机日志</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202743095.png"
                      alt="image-20230311202743095"
                ></p>
</li>
</ul>
</li>
<li><p>命令</p>
<ul>
<li><p><code>info replication </code> 命令查看</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202843615.png"
                      alt="image-20230311202843615" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202901684.png"
                      alt="image-20230311202901684" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311202915330.png"
                      alt="image-20230311202915330" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<br>

<p><strong>主从问题演示</strong></p>
<ul>
<li><p>从机可以执行写命令</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311203234915.png"
                      alt="image-20230311203234915" style="zoom:33%;" 
                >
</li>
<li><p>从机切入点问题</p>
<p>slave 是从头开始复制还是从 切入点开始复制</p>
<p>master 启动，写到 k3</p>
<p>slave1 跟着 master 同时启动，跟着写到 k3</p>
<p>slave2 写到 k3 后才启动，那之前的是否也可以复制</p>
<br>

<p>Y ，首次一锅端，后续跟随，master 写 ，slave 跟</p>
</li>
<li><p>主机 shutdown 后，从机 会上位吗？</p>
<p>主机 shutdown 后情况如何？从机是上位还是原地待命</p>
<br>

<p>从机不动，原地待命，从机数据可以正常使用；等待主机重启动归来</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311203934135.png"
                      alt="image-20230311203934135" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311203948622.png"
                      alt="image-20230311203948622" style="zoom:33%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311204002528.png"
                      alt="image-20230311204002528" style="zoom:33%;" 
                >
</li>
<li><p>主机shutdown 后，重启后主从关系还在吗？从机还能顺利复制吗</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311204120619.png"
                      alt="image-20230311204120619" style="zoom:50%;" 
                >、、</p>
</li>
<li><p>某台 从机 down后，master继续，从机重启后他还能跟上大部队吗</p>
</li>
</ul>
<br>

<ul>
<li><p>方案二 ： 命令操作手动指定</p>
<ul>
<li><p>从机停机去掉配置文件中的配置项。3台目前都是主机状态，各不从属</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311204846212.png"
                      alt="image-20230311204846212" style="zoom:33%;" 
                >
</li>
<li><p>3 台 master</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311204952099.png"
                      alt="image-20230311204952099" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311205009219.png"
                      alt="image-20230311205009219" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311205021859.png"
                      alt="image-20230311205021859" style="zoom:50%;" 
                >
</li>
<li><p>预设的从机上执行命令</p>
<ul>
<li><p><code>slaveof 主库ip 主库端口</code></p>
</li>
<li><p>效果</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311205353995.png"
                      alt="image-20230311205353995" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311205403777.png"
                      alt="image-20230311205403777" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>用命令使用的话，2台从机重启后，关系还在吗</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311205729395.png"
                      alt="image-20230311205729395" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
<br>

<p><strong>配置和命令的区别</strong></p>
<ul>
<li>配置，持久稳定</li>
<li>命令，当次生效</li>
</ul>
<h6 id="薪火相传"><a href="#薪火相传" class="headerlink" title="薪火相传"></a>薪火相传</h6><ul>
<li>上一个 slave 可以是下一个 slave 的 master，slave 同样可以接收其他 slave 的连接和 同步请求，那么 该 slave 作为了 链条中下一个的 master，可以有效减轻主 master 的写压力</li>
<li>中途变更转向 ： 会清除的之前的数据，重新建立拷贝最新的</li>
<li>slaveof 新主库ip  新主库端口</li>
</ul>
<h6 id="反客为主"><a href="#反客为主" class="headerlink" title="反客为主"></a>反客为主</h6><p><code>slaveof no one</code> : 使当前数据库停止与其他数据库的同步，转成主数据库</p>
<h4 id="复制原理和工作原理"><a href="#复制原理和工作原理" class="headerlink" title="复制原理和工作原理"></a>复制原理和工作原理</h4><ul>
<li>slave 启动，同步初请<ul>
<li>slave 启动成功连接到 master 后会发送一个 sync 命令</li>
<li>slave 首次全新连接 master，一次完全同步（全量复制）将被自动执行，slave 自身原有数据会被 master 数据覆盖清除</li>
</ul>
</li>
<li>首次连接，全量复制<ul>
<li>master 节点收到 sync 命令会开始在后台保存快照（即 RDB 持久化，主从复制时会触发 RDB），同时收集所有接收到的用于修改数据集命令缓存起来，master 节点执行 rdb 持久化完后，master 将 rdb 快照文件 和 所有缓存的命令发送到 所有 slave，以完成 一次完全同步</li>
<li>而 slave 服务在接收到数据库文件数据后，将其存盘 并加载到内存中，从而完成复制初始化</li>
</ul>
</li>
<li>心跳持续，保持通信</li>
<li><code>repl-ping-replica-period 10</code><ul>
<li>master 发送 ping 包的周期，默认是10 秒</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311213413392.png"
                      alt="image-20230311213413392" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li>进入平稳，增量复制<ul>
<li>Master 继续将新的所有收集到的 修改命令自动依次传给 slave，完成同步</li>
</ul>
</li>
<li>从机下线，重连续传<ul>
<li>master 会检查 backlog 里面的 offset，master 和 slave 都会保存一个复制的 offset 还有一个 masterId，offset 是保存在 backlog 里面的，<strong>master 只会把已经复制的 offset 后面的数据复制给 slave</strong>，类似于断点续传</li>
</ul>
</li>
</ul>
<h5 id="复制的缺点"><a href="#复制的缺点" class="headerlink" title="复制的缺点"></a>复制的缺点</h5><h6 id="复制延时，信号衰减"><a href="#复制延时，信号衰减" class="headerlink" title="复制延时，信号衰减"></a>复制延时，信号衰减</h6><p>由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311214334251.png"
                      alt="image-20230311214334251" style="zoom:50%;" 
                >



<h6 id="master-挂了怎么办"><a href="#master-挂了怎么办" class="headerlink" title="master 挂了怎么办"></a>master 挂了怎么办</h6><ul>
<li>默认情况下，不会在 slave 节点自动重选一个 master</li>
<li>那每次都要人工干预？<ul>
<li><strong><font color='red'>无人值守安装变成刚需</font></strong></li>
</ul>
</li>
</ul>
<h3 id="Redis-哨兵（sentinel）"><a href="#Redis-哨兵（sentinel）" class="headerlink" title="Redis 哨兵（sentinel）"></a>Redis 哨兵（sentinel）</h3><hr>
<p>High availability for non-clustered Redis  - <strong>非集群的高可用性</strong></p>
<p>Redis Sentinel provides high availability for Redis when not using <a class="link"   target="_blank" rel="noopener" href="https://redis.io/docs/manual/scaling" >Redis Cluster<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>.</p>
<p>Redis Sentinel also provides other collateral tasks such as monitoring, notifications and acts as a configuration provider for clients.</p>
<br>

<p>吹哨人巡查监控后台 master 主机是否故障，如果故障了，根据**<font color='red'>投票数</font>**自动 将某一个从库转换为新主库，继续对外服务</p>
<br>

<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ul>
<li>监控 redis 的运行状态，包括 master 和 slave</li>
<li>**当 master down机，能自动将 slave 切换成新 master **</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311221745138.png"
                      alt="image-20230311221745138" style="zoom:33%;" 
                >

<br>

<blockquote>
<p><strong><font color='red'>无人值守运维</font></strong></p>
</blockquote>
<br>

<h4 id="能干嘛-6"><a href="#能干嘛-6" class="headerlink" title="能干嘛"></a>能干嘛</h4><p>This is the full list of Sentinel capabilities at a macroscopic level (i.e. the <em>big picture</em>):</p>
<ul>
<li><strong>Monitoring</strong>. Sentinel constantly checks if your master and replica instances are working as expected.</li>
<li><strong>Notification</strong>. Sentinel can notify the system administrator, or other computer programs, via an API, that something is wrong with one of the monitored Redis instances.</li>
<li><strong>Automatic failover</strong>. If a master is not working as expected, Sentinel can start a failover process where a replica is promoted to master, the other additional replicas are reconfigured to use the new master, and the applications using the Redis server are informed about the new address to use when connecting.</li>
<li><strong>Configuration provider</strong>. Sentinel acts as a source of authority for clients service discovery: clients connect to Sentinels in order to ask for the address of the current Redis master responsible for a given service. If a failover occurs, Sentinels will report the new address.</li>
</ul>
<p>这是宏观级别的前哨功能的完整列表</p>
<ul>
<li><strong>监视</strong>： Sentinel<strong>不断</strong>检查您的主人和复制实例是否按预期工作。</li>
<li><strong>通知</strong>： Sentinel可以通过API通知系统管理员或其他计算机程序，其中一个被监视的REDIS实例出现了问题。</li>
<li><strong>自动故障转移</strong>： 如果主人无法按预期工作，Sentinel可以启动故障转移过程，将复制品促进给主人，则重新配置了其他额外的副本以使用新的主机，并且使用REDIS服务器的应用程序已通知有关新地址的信息 连接时。</li>
<li><strong>配置提供商</strong>。：Sentinel充当客户服务发现的授权来源：客户连接到哨兵，以要求当前的Redis Master的地址负责给定服务。 如果发生故障转移，前哨将报告新地址。</li>
</ul>
<br>

<h5 id="主从监控"><a href="#主从监控" class="headerlink" title="主从监控"></a>主从监控</h5><p>监控主从 redis 库运行是否正常</p>
<h5 id="消息通知"><a href="#消息通知" class="headerlink" title="消息通知"></a>消息通知</h5><p>哨兵可以将故障转移的结果发送给客户端</p>
<h5 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h5><p>如果 master异常，则会进行主从切换，将其中一个 slave 作为新的 master</p>
<h5 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h5><p>客户端通过连接哨兵来获得当前 redis 服务的主节点地址</p>
<h4 id="案例演示-3"><a href="#案例演示-3" class="headerlink" title="案例演示"></a>案例演示</h4><h5 id="redis-sentinel-架构"><a href="#redis-sentinel-架构" class="headerlink" title="redis sentinel 架构"></a>redis sentinel 架构</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311215355661.png"
                      alt="image-20230311215355661" style="zoom: 50%;" 
                >

<br>

<ul>
<li>3 个哨兵<ul>
<li>自动监控和维护集群，不存放数据，只是吹哨人</li>
</ul>
</li>
<li>1 主 2 从<ul>
<li>用于数据读取和存放</li>
</ul>
</li>
</ul>
<h5 id="案例步骤"><a href="#案例步骤" class="headerlink" title="案例步骤"></a>案例步骤</h5><ul>
<li><p>&#x2F;myredis 目录下 新建或者拷贝 sentinel.conf 文件，名字绝不能错</p>
</li>
<li><p>先看看 &#x2F;opt 目录下默认的 sentinel.conf 文件的内容</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230311223435317.png"
                      alt="image-20230311223435317" style="zoom:33%;" 
                >
</li>
<li><p>重点参数项说明</p>
<ul>
<li><p>bind </p>
<p>服务器监听地址，用于客户端连接，默认本机地址</p>
</li>
<li><p><code>daemonize</code> </p>
<p>是否以后台 daemonize 方式运行</p>
</li>
<li><p><code>protected-mode</code> </p>
<p>安全保护模式</p>
</li>
<li><p><code>port</code></p>
<p>端口</p>
</li>
<li><p><code>logfile</code></p>
<p>日志文件路径</p>
</li>
<li><p><code>pidfile</code></p>
<p>pid 文件路径</p>
</li>
<li><p><code>dir</code></p>
<p>工作目录</p>
</li>
<li><p><code>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quoru&gt;</code></p>
<ul>
<li><p>设置要监控的 master 服务器</p>
</li>
<li><p>quorum 表示最少有多少个哨兵认可客观下线，同意故障迁移的法定票数</p>
<ul>
<li><p>quorum 表示确认客观下线的最少的哨兵数量</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312092107982.png"
                      alt="image-20230312092107982" style="zoom:33%;" 
                >

<br>

<p>网络是不可靠的，有时候一个sentinel会因为网络堵塞而  <strong><font color='red'>误以为</font></strong>  一个master redis已经死掉了，在sentinel集群环境下需要多个sentinel互相沟通来确认某个master  <font color='red'><strong>是否真的死了</strong></font>  ，quorum这个参数是进行客观下线的一个依据，意思是<strong>至少有quorum个sentinel认为这个master有故障，才会对这个master进行下线以及故障转移</strong>。因为有的时候，某个sentinel节点可能因为自身网络原因，导致无法连接master，而此时master并没有出现故障，所以，这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证了公平性和高可用。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</code></p>
<ul>
<li>master 设置了密码，连接 master 服务的密码</li>
</ul>
</li>
<li><p><code>sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</code></p>
<p>指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线</p>
</li>
<li><p><code>sentinel parallel-syncs &lt;master-name&gt; &lt;nums&gt;</code> </p>
<p>表示允许并行同步的slave个数，当Master挂了后，哨兵会选出新的Master，此时，剩余的slave会向新的master发起同步数据</p>
</li>
<li><p><code>sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</code></p>
<p>故障转移的超时时间，进行故障转移时，如果超过设置的毫秒，表示故障转移失败</p>
</li>
<li><p><code>sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</code></p>
<p>配置当某一事件发生时所需要执行的脚本</p>
</li>
<li><p><code>sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</code></p>
<p>客户端重新配置主节点参数脚本</p>
</li>
</ul>
</li>
<li><p>哨兵 sentinel 文件通用配置 </p>
<ul>
<li><p>sentinel26379.conf</p>
<div class="code-container" data-rel="Text"><figure class="iseeu highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 26381</span><br><span class="line">logfile &quot;/opt/myredis/sentinel26381.log&quot;</span><br><span class="line">pidfile /var/run/redis-sentinel26381.pid</span><br><span class="line">dir &quot;/opt/myredis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.21.169 6379 2</span><br><span class="line">sentinel auth-pass mymaster C020611.</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>sentinel26380.conf</p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 26381</span><br><span class="line">logfile &quot;/opt/myredis/sentinel26381.log&quot;</span><br><span class="line">pidfile /var/run/redis-sentinel26381.pid</span><br><span class="line">dir &quot;/opt/myredis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.21.169 6379 2</span><br><span class="line">sentinel auth-pass mymaster C020611.</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>sentinel26381.conf</p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 26381</span><br><span class="line">logfile &quot;/opt/myredis/sentinel26381.log&quot;</span><br><span class="line">pidfile /var/run/redis-sentinel26381.pid</span><br><span class="line">dir &quot;/opt/myredis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.21.169 6379 2</span><br><span class="line">sentinel auth-pass mymaster C020611.</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>sentinel26379、26380、26381.conf</p>
 <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312093408239.png"
                      alt="image-20230312093408239" style="zoom:33%;" 
                >
</li>
<li><p>master 主机配置文件说明</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312093440394.png"
                      alt="image-20230312093440394" style="zoom:33%;" 
                ></li>
</ul>
</li>
<li><p>先启动 一主二从 3个 redis 示例实例，测试正常的主从复制</p>
<ul>
<li><p>架构说明</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312093624411.png"
                      alt="image-20230312093624411" style="zoom:33%;" 
                >

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312093637099.png"
                      alt="image-20230312093637099"
                ></p>
</li>
<li><p>redis6379&#x2F;80&#x2F;81.conf 内容，填写主从配置</p>
<ul>
<li><p>主机 6379</p>
<p>6379 后续可能会变成从机，需要设置访问密码，请设置 <code>masterauth C020611.</code></p>
<p>不然后续可能报错 <code>master_link_status:down</code></p>
</li>
<li><p>6380&#x2F;81 </p>
<p>参考上面配置</p>
</li>
</ul>
</li>
<li><p>三台不同的虚拟机实例，启动三部真实机器示例并连接</p>
<ul>
<li><code>redis-cli -a C020611. -p 6379/80/81</code></li>
</ul>
</li>
</ul>
</li>
<li><p>————————————————-哨兵部分—————————————————-</p>
</li>
<li><p>再启动三个哨兵，完成监控</p>
<ul>
<li><code>redis-sentinel sentinel26379.conf --sentinel</code></li>
<li><code>redis-sentinel sentinel26380.conf --sentinel</code></li>
<li><code>redis-sentinel sentinel26381.conf --sentinel</code></li>
</ul>
</li>
<li><p>再启动 3 个哨兵监控后，再测试一次主从复制</p>
</li>
<li><p>原有的 master down机了</p>
<ul>
<li><p>手动模拟关闭 6379 服务器，模拟down 机</p>
</li>
<li><p>问题</p>
<ul>
<li>两台从机数据是否正常</li>
<li>是否会从剩下的两台机器上选出新的 master</li>
<li>之前 down 机的master 机器重启归来，谁会是老大，会不会双 master 冲突</li>
</ul>
</li>
<li><p>数据 OK</p>
<ul>
<li><p>两个小问题</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312094511038.png"
                      alt="image-20230312094511038" style="zoom:50%;" 
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312094520137.png"
                      alt="image-20230312094520137" style="zoom:50%;" 
                >
</li>
<li><p>6380&#x2F;6381</p>
<p>Broken pipe</p>
</li>
<li><p>Broken pipe</p>
<ul>
<li><p>pipe</p>
<p>pipe 是管道的意思，管道里面是数据流，通常是 从 文件或者 套接字读取的数据。当该管道从另一端突然崩溃关闭时，会发生数据突然中断，即是 broken，对于 socket 来说，可能是网络被拔出或另一端的进程崩溃</p>
</li>
<li><p>解决问题</p>
<p>其实当该异常产生的时候，对于服务端来说，并没有多少影响。因为可能是某个客户端突然中止了进程导致崩溃导致了该错误</p>
</li>
<li><p>总结</p>
<p>这个异常时客户端读取超时关闭了连接，这时候服务器端再向客户端已经断开的连接写数据时就发生了 broken pipe 异常</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312095222544.png"
                      alt="image-20230312095222544" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
</li>
<li><p>投票新选</p>
<ul>
<li><p>sentinel26379.log</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312095903020.png"
                      alt="image-20230312095903020"
                ></p>
</li>
<li><p>sentinel26380.log</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312095922085.png"
                      alt="image-20230312095922085"
                ></p>
</li>
<li><p>sentinel26381.log</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312095937279.png"
                      alt="image-20230312095937279"
                ></p>
</li>
</ul>
</li>
<li><p>谁是 master （此案例）</p>
</li>
<li><p>6381 被选为 新的 master，上位成功</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312100046138.png"
                      alt="image-20230312100046138" style="zoom:50%;" 
                >
</li>
<li><p>以前的 6379 从 master  降级 成为 slave</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312100130475.png"
                      alt="image-20230312100130475" style="zoom:50%;" 
                >
</li>
<li><p>6380 还是 从机，只不过换了个 新老大 6381（79变81），6380 还是 slave</p>
</li>
</ul>
</li>
<li><p>对比配置文件</p>
<ul>
<li>文件的内容，在运行期间会被 sentinel 动态改变</li>
<li>Master - slave 切换后，master_redis.conf、sentinel.conf 的内容都会发生改变，即 master_redis.conf  中会多一行 slaveof 的配置，sentinel.conf  的监控目标会随之调换</li>
</ul>
</li>
</ul>
<br>

<blockquote>
<p>生产都是不同机房，不同服务器，很少出现三个 哨兵全挂掉的情况</p>
<p>可以同时监控多个master，一行一个</p>
</blockquote>
<h4 id="哨兵运行流程和选举原理"><a href="#哨兵运行流程和选举原理" class="headerlink" title="哨兵运行流程和选举原理"></a>哨兵运行流程和选举原理</h4><p>当一个主从配置中的 master失效之后，sentinel 可以选举一个新的 master 用于自动接替 原来的 master 工作，主从配置中的其他的 redis 服务器自动指向新的 master 同步数据，一般建议 sentinel 采用奇数台，防止某一台sentinel 无法连接到 master 导致误切换</p>
<h5 id="运行流程，故障切换"><a href="#运行流程，故障切换" class="headerlink" title="运行流程，故障切换"></a>运行流程，故障切换</h5><h6 id="SDown-主观下线（Subjectively-Down）"><a href="#SDown-主观下线（Subjectively-Down）" class="headerlink" title="SDown 主观下线（Subjectively Down）"></a>SDown 主观下线（Subjectively Down）</h6><p>SDown (主观不可用) 是 <strong>单个 sentinel 自动主观上</strong>  检测到的关于 master的状态，从 sentinel 的角度来看，如果发送了 ping 心跳后，在一定的时间内没有收到合法的回复，就达到了 SDown 的条件</p>
<p>sentinel 配置文件中的 <code>down-after-milliseconds</code> 设置了 判断主观下线的时间长度</p>
<p><strong>说明</strong></p>
<p>所谓主观下线（Subjectively Down， 简称 SDOWN）指的是<strong>单个Sentinel实例</strong>对服务器做出的下线判断，即单个sentinel认为某个服务下线（有可能是接收不到订阅，之间的网络不通等等原因）。主观下线就是说如果服务器在[sentinel down-after-milliseconds]给定的毫秒数之内没有回应PING命令或者返回一个错误消息， 那么这个Sentinel会主观的(<strong>单方面的</strong>)认为这个master不可以用了</p>
<p><code>sentinel down-after-milliseconds &lt;masterName&gt; &lt;timeout&gt;</code></p>
<p>表示master被当前sentinel实例认定为失效的间隔时间，这个配置其实就是进行主观下线的一个依据</p>
<p>master在多长时间内一直没有给Sentine返回有效信息，则认定该master主观下线。也就是说如果多久没联系上redis-servevr，认为这个redis-server进入到失效（SDOWN）状态。</p>
<h6 id="ODwown-客观下线（Objectively-Down"><a href="#ODwown-客观下线（Objectively-Down" class="headerlink" title="ODwown 客观下线（Objectively Down)"></a>ODwown 客观下线（Objectively Down)</h6><p>ODown 需要达到一定数量的 sentinel，<strong>多个哨兵达成一致意见</strong> 才能认为 一个 master 客观上已经 down掉了</p>
<p><code>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redsi-port&gt; &lt;quorum&gt;</code></p>
<p>masterName  是对某个  master+slave  组合的一个<strong>区分标识</strong>(一套sentinel可以监听多组master+slave这样的组合)</p>
<p><code>quorum</code> <strong><font color='red'>这个参数 是进行客观下线的一个依据</font></strong>，法定人数 &#x2F; 法定票数</p>
<p>意思是 ： </p>
<p>至少有quorum个sentinel认为这个master有故障才会对这个master进行下线以及故障转移。因为有的时候，某个sentinel节点可能因为自身网络原因导致无法连接master，而此时master并没有出现故障，所以这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证了公平性和高可用</p>
<h6 id="选举出-leader（领导者）-哨兵"><a href="#选举出-leader（领导者）-哨兵" class="headerlink" title="选举出 leader（领导者） 哨兵"></a>选举出 leader（领导者） 哨兵</h6><p>当主节点被判断客观下线之后，各个哨兵节点会进行协商，先选举出一个 <strong>领导者哨兵节点</strong>  并由该领导者节点，也即被选举出的 leader 进行  failover （故障迁移）</p>
<p><strong>三哨兵 log 文件解读</strong></p>
<p>sentinel26379.log</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312102841293.png"
                      alt="image-20230312102841293"
                ></p>
<p><strong><font color='red'>sentinel26380.log</font></strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312102929005.png"
                      alt="image-20230312102929005"
                ></p>
<p>sentinel26381.log</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312102957390.png"
                      alt="image-20230312102957390"
                ></p>
<h6 id="选举算法（Raft-算法）"><a href="#选举算法（Raft-算法）" class="headerlink" title="选举算法（Raft 算法）"></a>选举算法（Raft 算法）</h6><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312103108846.png"
                      alt="image-20230312103108846" style="zoom:50%;" 
                >

<br>

<p>监视该主节点的所有哨兵都有可能被选为 领导者，选举使用的算法是 raft 算法，</p>
<p>raft 算法的 基本思路是 <strong><font color='red'>先到先得</font></strong></p>
<p>即在一轮选举中，哨兵 a 向 b 发送成为领导者的 申请，如果 b 没有同意过 别的 哨兵，，则会同意 a 成为 领导者</p>
<h6 id="由-领导者-开始推动故障切换流程并选出新的-master"><a href="#由-领导者-开始推动故障切换流程并选出新的-master" class="headerlink" title="由 领导者 开始推动故障切换流程并选出新的 master"></a>由 领导者 开始推动故障切换流程并选出新的 master</h6><ul>
<li><p>新主登基</p>
<ul>
<li><p><strong><font color='red'>某个 slave 被选为 新 master</font></strong></p>
</li>
<li><p>选出新 master 的规则，剩余 slave 节点健康前提下</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312104131914.png"
                      alt="image-20230312104131914" style="zoom:33%;" 
                >

<ul>
<li><p>redis.conf 文件中，优先级 slave-priority 或者 replica-priority 最高的从节点（数字越小优先级越高）</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312104251234.png"
                      alt="image-20230312104251234" style="zoom:50%;" 
                >
</li>
<li><p>复制偏移位置 offset 最大的从节点</p>
</li>
<li><p>最小 Run ID 的从节点</p>
<ul>
<li>字典顺序，ASCII 码</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>群臣拜服</p>
<ul>
<li><strong><font color='red'>其他 slave 重新 选择 master</font></strong></li>
<li>执行 <code>slaveof no one</code> 命令让选出来的从节点成为新的主节点，并通过 slaveof 命令让其他节点成为其从节点</li>
<li>sentinel leader 会对选举出的 新 master 执行 <code>slaveof no one</code> 操作，将其提升为 master 节点</li>
<li>sentinel leader 向其他 slave 发送 命令，让剩余的 slave 成为 新的 master 的slave</li>
</ul>
</li>
<li><p>旧主拜服</p>
<ul>
<li><strong><font color='red'>之前的master回来后，成为 slave，选择 现在的master成为其 slave</font></strong></li>
<li>将之前下线的 老 master 设置为 新选出的 新 maser 的从节点，当老 master 重新上线后，他会成为 新 master 的 从节点</li>
<li>sentinel leader 会让原来的 master 降级成为 slave 并恢复正常工作</li>
</ul>
</li>
</ul>
<p><strong>总结</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312105204360.png"
                      alt="image-20230312105204360" style="zoom: 50%;" 
                >

<p><strong><font color='red'>上述的 failover 操作均由  sentinel 自己独立完成，完全不需要 人工干预</font></strong></p>
<h4 id="哨兵使用-建议"><a href="#哨兵使用-建议" class="headerlink" title="哨兵使用 建议"></a>哨兵使用 建议</h4><ul>
<li>哨兵节点的数量应为多个，哨兵本身应该集群，保证高可用</li>
<li>哨兵节点的数量应该是 奇数</li>
<li>各个哨兵节点的配置应一致</li>
<li>如果哨兵节点部署在 Docker 等容器里面，尤其要注意端口的正确映射</li>
<li>哨兵集群 +  主从复制，并不能保证数据的零丢失<ul>
<li>引出集群</li>
</ul>
</li>
</ul>
<h3 id="Redis-集群（cluster）"><a href="#Redis-集群（cluster）" class="headerlink" title="Redis 集群（cluster）"></a>Redis 集群（cluster）</h3><hr>
<p><strong><font color='red'>由于数据量过大，单个 master 复制集</font></strong>  难以承担，因此需要对多个复制集进行集群，形成水平扩展。每个复制集只负责整个数据集的一部分，这就是 redis 集群，其作用就是在 多个 redis节点间  共享数据的程序集</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312110549308.png"
                      alt="image-20230312110549308" style="zoom:50%;" 
                >

<br>

<p>redis 集群是一个提供在 多个 redis 节点间的共享数据的程序集</p>
<p>redis 集群可以支持多个 master</p>
<h4 id="能干嘛-7"><a href="#能干嘛-7" class="headerlink" title="能干嘛"></a>能干嘛</h4><ul>
<li>redis 集群支持多个 master，每个master 又可以挂载多个 slave <ul>
<li>读写分离</li>
<li>支持数据的高可用</li>
<li>支持海量数据的读写存储操作</li>
</ul>
</li>
<li>由于 cluster 自带的 sentinel 的故障转移机制，内置了 高可用的机制，<strong><font color='red'>无需再去使用 哨兵功能</font></strong></li>
<li>客户端与 redis 的节点连接，不再需要连接集群中的所有节点，只需要任意连接集群中的一个可用节点即可</li>
<li><strong>槽位 slot 负责分配到各个物理服务节点，由对应的集群来负责维护节点、插槽和数据之间 的关系</strong></li>
</ul>
<h4 id="集群算法-分片-槽位-slot"><a href="#集群算法-分片-槽位-slot" class="headerlink" title="集群算法-分片-槽位 slot"></a>集群算法-分片-槽位 slot</h4><p>The cluster’s key space is split into 16384 slots, effectively setting an upper limit for the cluster size of 16384 master nodes (however, the suggested max size of nodes is on the order of ~ 1000 nodes).</p>
<p>Each master node in a cluster handles a subset of the 16384 hash slots. The cluster is <strong>stable</strong> when there is no cluster reconfiguration in progress (i.e. where hash slots are being moved from one node to another). When the cluster is stable, a single hash slot will be served by a single node (however the serving node can have one or more replicas that will replace it in the case of net splits or failures, and that can be used in order to scale read operations where reading stale data is acceptable).</p>
<p>The base algorithm used to map keys to hash slots is the following (read the next paragraph for the hash tag exception to this rule):</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HASH_SLOT = CRC16(key) mod 16384</span><br></pre></td></tr></table></figure></div>

<p>The CRC16 is specified as follows:</p>
<ul>
<li>Name: XMODEM (also known as ZMODEM or CRC-16&#x2F;ACORN)</li>
<li>Width: 16 bit</li>
<li>Poly: 1021 (That is actually x^16 + x^12 + x^5 + 1)</li>
<li>Initialization: 0000</li>
<li>Reflect Input byte: False</li>
<li>Reflect Output CRC: False</li>
<li>Xor constant to output CRC: 0000</li>
<li>Output for “123456789”: 31C3</li>
</ul>
<p>14 out of 16 CRC16 output bits are used (this is why there is a modulo 16384 operation in the formula above).</p>
<p>In our tests CRC16 behaved remarkably well in distributing different kinds of keys evenly across the 16384 slots.</p>
<p><strong>Note</strong>: A reference implementation of the CRC16 algorithm used is available in the Appendix A of this document.</p>
<p>集群的密钥空间被分成16384个插槽，有效地设置了16384个主节点的集群大小上限(但是，建议的最大节点大小大约为1000个节点)。</p>
<p>集群中的每个主节点处理16384个哈希槽的子集。当没有正在进行的群集重新配置时，集群是<strong>稳定的</strong> (即散列片段从一个节点移动到另一个节点)。当集群稳定时，单个哈希槽将由单个节点提供服务(但是，服务节点可以有一个或多个副本，在网络拆分或故障的情况下替换它，并且可以用于在读取陈旧数据是可接受的情况下扩展读取操作)。</p>
<h5 id="redis集群的数据分片"><a href="#redis集群的数据分片" class="headerlink" title="redis集群的数据分片"></a>redis集群的数据分片</h5><p>redis 集群没有使用 一致性哈希，而是 引入了 <font color='red'><strong>哈希槽</strong></font> 的概念</p>
<p>redis  集群有 16384 个 哈希槽，每个 key 通过 <strong>CRC16</strong>  校验后对 16384 进行取模 来决定 放置哪个槽。集群的每个节点负责一小部分的 hash 槽，举个例子，如果当前集群有三个节点，那么 ： </p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312112116663.png"
                      alt="image-20230312112116663" style="zoom:50%;" 
                >



<h5 id="redis-集群的分片"><a href="#redis-集群的分片" class="headerlink" title="redis 集群的分片"></a>redis 集群的分片</h5><h6 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h6><p>使用 redis 集群时 我们会将存储的数据分散到多台redis 机器上，这称为 分片。简言之，集群中的每个 redis 实例 都被认为是整个数据的一个分片</p>
<h6 id="如何找到给定key-的分片"><a href="#如何找到给定key-的分片" class="headerlink" title="如何找到给定key  的分片"></a>如何找到给定key  的分片</h6><p>为了找到给定 key  的 分片，我们 对key 进行 CRC16(key)  算法处理并通过对总分片数量取模。然后，<strong><font color='red'>使用 确定性哈希函数</font></strong>，这意味着 给定的 key <strong><font color='red'>将多次始终映射到同一个分片</font></strong>，我们可以推断将来读取特定 key 的位置</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312112603743.png"
                      alt="image-20230312112603743" style="zoom:33%;" 
                >



<h5 id="槽位-和-分片的优势"><a href="#槽位-和-分片的优势" class="headerlink" title="槽位 和 分片的优势"></a>槽位 和 分片的优势</h5><p><strong><font color='cornflowerblue'>最大优势 方便扩容缩容个数据分派查找</font></strong></p>
<p>这种结构很容易添加或者删除节点，比如如果我想新添加一个 节点 D，我需要从 节点 A，B，C 中得部分槽到 D 上。如果 我想移除节点 A，需要 将 A 中的 槽移到 B和C 上，然后将没有任何槽的 A 节点从集群从 移除即可。由于 从一个节点将哈希槽移动到另一个节点 并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成 集群 不可以 的状态</p>
<h4 id="slot-槽位映射"><a href="#slot-槽位映射" class="headerlink" title="slot 槽位映射"></a>slot 槽位映射</h4><h5 id="哈希取余分区"><a href="#哈希取余分区" class="headerlink" title="哈希取余分区"></a>哈希取余分区</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312113334736.png"
                      alt="image-20230312113334736" style="zoom:50%;" 
                >

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312113356671.png"
                      alt="image-20230312113356671"
                ></p>
<h5 id="一致性哈希算法分区"><a href="#一致性哈希算法分区" class="headerlink" title="一致性哈希算法分区"></a>一致性哈希算法分区</h5><h6 id="算法背景"><a href="#算法背景" class="headerlink" title="算法背景"></a>算法背景</h6><p>设计目标是为了解决 <strong>分布式缓存数据 <font color='cornflowerblue'>变动和映射</font>问题，某个机器 宕机了，分母数量变了，自然取余数不 OK 了</strong></p>
<h6 id="能干嘛-8"><a href="#能干嘛-8" class="headerlink" title="能干嘛"></a>能干嘛</h6><p>提出 一致性 hash 解决方案。目的是当服务器个数发生改变的时候，尽量减少影响客户端到服务器的映射关系 </p>
<h6 id="三大步骤"><a href="#三大步骤" class="headerlink" title="三大步骤"></a>三大步骤</h6><ul>
<li><p>算法构建一致性哈希环</p>
<p>一致性哈希算法必然有个 hash 函数并按照算法产生 hash 值，这个 算法的所有可能 hash值  构成一个全量集，这个集合可以成为一个 hash空间 [0,2^32 - 1]，这个是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首尾相连 （0 &#x3D; 2 ^ 32），这样让它逻辑上形成了一个环形空间</p>
<br>

<p>他也是按照使用取模的方法， <strong><font color='red'>前面笔记介绍的节点取模法是对节点（服务器）的数量进行取模。而一致性 Hash 算法是对 2 ^ 32 取模</font></strong>，简单来说，<strong><font color='red'>一致性 Hash 算法将整个哈希值空间组织成一个虚拟的圆环</font></strong>，如 假设某哈希函数 H 的值空间 为 0 - 2 ^ 32 - 1(即哈希值是一个 32 位 无符号整形)，整个 哈希环 如下图 ： 整个空间 <strong><font color='red'>按顺序针方向组织</font></strong>，圆环的正上方的点代表 0 ，0 点右侧的第一个点代表 1，以此类推，2，3，4 … … 直到 2 ^ 32 - 1 ，也就是说 0 点左侧的第一个点 代表 2 ^ 32 - 1， 0 和 2 ^ 32 - 1 在 零点中方向重合，我们把这个由 2 ^ 32 个点组成的圆环成为 hash 环</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312122518309.png"
                      alt="image-20230312122518309" style="zoom:50%;" 
                >
</li>
<li><p>redis 服务器 IP 节点映射</p>
<p>将集群中各个 IP 节点映射到 环上的某一个位置</p>
<br>

<p>将各个服务器使用 hash 进行一个 hash，具体可以选择服务器的 IP 或 主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假设 4 个节点 Node A、B、C、D，经过 IP 地址的 <strong><font color='red'>哈希函数</font></strong> 计算（hash(ip)）,使用 IP 地址 哈希后在环空间的位置如下</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312123059222.png"
                      alt="image-20230312123059222" style="zoom:50%;" 
                >
</li>
<li><p>key 落到服务器的落键规则</p>
<p>当我们需要存储一个 kv 键值对时，首先计算 key 的hash 值，hash(key), 将这个key 使用相同的函数 Hash 计算出 哈希值 并确定在此数据环上的位置，<strong><font color='red'>从此位置沿环顺时针 “行走”</font></strong>，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上</p>
<br>

<p>如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性Hash算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312123607085.png"
                      alt="image-20230312123607085" style="zoom:50%;" 
                ></li>
</ul>
<h6 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h6><ul>
<li><p>一致性 哈希算法的 <strong><font color='red'>容错性</font></strong></p>
<p>假设 Node C 宕机，可以看到此时 A、B、D 不会受到影响。一般的，在 一致性 Hash 算法中，如果一台服务器不可用，则 <strong><font color='red'>受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿逆时针方向行走遇到的第一台服务器） 之间数据</font></strong>，其他不会受到影响。简单说，C 挂了，受到影响的 只是 B、C 之间 的数据 <strong><font color='red'>且这些数据会转移到 D 进行存储</font></strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312124123568.png"
                      alt="image-20230312124123568" style="zoom:50%;" 
                >
</li>
<li><p>一致性 哈希算法的 <strong><font color='cornflowerblue'>扩展性</font></strong></p>
<p>数据量增加了，需要增加一台 Node x,X  的位置在 A 和 B 之间，那受到影响的只有 A 到 X 之间的 数据，重新把从 A 到 X 的 数据录入到 X 上即可，不会导致 hash 取余全部数据重新洗牌</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312124457726.png"
                      alt="image-20230312124457726" style="zoom:50%;" 
                ></li>
</ul>
<h6 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h6><p>Hash 环的数据倾斜问题</p>
<p>一致性 Hash 算法在服务 <strong><font color='red'>节点太少时</font></strong>，容易因为 节点分布不均而造成 <strong><font color='red'>数据倾斜</font></strong>（被缓存的对象大部分集中缓存在某一台服务器上） 问题，例如只有两台服务器时</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312124647270.png"
                      alt="image-20230312124647270" style="zoom:50%;" 
                >



<h6 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h6><p>为了在节点数目发生改变时尽可能少的迁移数据</p>
 <br>

<p>将所有的存储节点排列在收尾相接的Hash环上，每个key在计算Hash后会顺时针找到临近的存储节点存放。</p>
<p>而当有节点加入或退出时仅影响该节点在Hash环上顺时针相邻的后续节点。 </p>
 <br>

<p><strong>优点</strong></p>
<p>加入和删除节点只影响哈希环中顺时针方向的相邻的节点，对其他节点无影响。</p>
 <br>

<p><strong>缺点</strong> </p>
<p>数据的分布和节点的位置有关，因为这些节点不是均匀的分布在哈希环上的，所以数据在进行存储时达不到均匀分布的效果。</p>
<h5 id="哈希槽分区"><a href="#哈希槽分区" class="headerlink" title="哈希槽分区"></a>哈希槽分区</h5><h6 id="是什么-6"><a href="#是什么-6" class="headerlink" title="是什么"></a>是什么</h6><p>哈希槽 实质就是一个数组，数组 [0,2 ^ 14 - 1] 形成 Hash slot 空间</p>
<h6 id="能干什么"><a href="#能干什么" class="headerlink" title="能干什么"></a>能干什么</h6><p>为了 解决 <strong>一致性哈希算法 数据倾斜</strong> 问题而出现。<strong><font color='red'>在数据和节点之间又加入了一层，把这层成为 哈希槽（slot），用于管理数据与节点之间的关系</font></strong>，现在就相当于节点上放的是 槽，槽里放的是数据</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312125104245.png"
                      alt="image-20230312125104245" style="zoom:50%;" 
                >

<br>

<p>槽 解决的是 粒度问题，相当于把粒度变大了，这样便于数据移动。哈希解决的是映射问题，使用 key 的哈希值来计算所在的槽，便于数据分配</p>
<h6 id="多少个-hash-slot"><a href="#多少个-hash-slot" class="headerlink" title="多少个 hash slot"></a>多少个 hash slot</h6><p>一个集群只能有 16384 个槽，编号 0 - 16383 （0，2^14 -1 ）。这些槽会分配给集群中的所有节点，分配策略没有要求。</p>
<p>槽 会记录节点和槽的对应关系，解决了节点和槽的关系之后，接下来就需要对 key 求 hash值，然后 对 16384 取模，余数是几，key 就落入相对应的槽里</p>
<p><code>HASH_SLOT = CRC16(key) mod 16384</code></p>
<p>以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了</p>
<h6 id="hash-slot-计算"><a href="#hash-slot-计算" class="headerlink" title="hash slot 计算"></a>hash slot 计算</h6><p>Redis 集群中内置了 16384 个哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 Redis 集群中放置一个 key-value时，redis先对key使用crc16算法算出一个结果然后用结果对16384求余数[ CRC16(key) % 16384]，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上。如下代码，key之A 、B在Node2， key之C落在Node3上</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312125708103.png"
                      alt="image-20230312125708103" style="zoom:50%;" 
                >



<h4 id="redis-集群-最大槽数为什么是-16384-个"><a href="#redis-集群-最大槽数为什么是-16384-个" class="headerlink" title="redis 集群 最大槽数为什么是 16384  个"></a>redis 集群 最大槽数为什么是 16384  个</h4><p>redis 集群并没有用 一致性 hash 而是引入了 哈希槽的 概念。 <strong><font color='red'>redis 集群有 16384 个哈希槽</font></strong>，每个 key 通过 CRC16 校验后 对 16384 进行取模来决定防止哪个槽，集群的每一个节点负责一部分槽。但是 为什么是 16384 个呢</p>
<br>

<blockquote>
<p>CRC16算法产生的hash值有16bit，该算法可以产生2^16&#x3D;65536个值。</p>
<p>换句话说值是分布在0~65535之间，有更大的65536不用为什么只用16384就够？</p>
<p>作者在做mod运算的时候，为什么不mod65536，而选择mod16384？ HASH_SLOT &#x3D; CRC16(key) mod 65536为什么没启用</p>
<p><strong><a class="link"   target="_blank" rel="noopener" href="https://github.com/redis/redis/issues/2576" >https://github.com/redis/redis/issues/2576<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></strong></p>
</blockquote>
<h5 id="说明一"><a href="#说明一" class="headerlink" title="说明一"></a>说明一</h5><p>The reason is:</p>
<ol>
<li>Normal heartbeat packets carry the full configuration of a node, that can be replaced in an idempotent way with the old in order to update an old config. This means they contain the slots configuration for a node, in raw form, that uses 2k of space with16k slots, but would use a prohibitive 8k of space using 65k slots.</li>
<li>At the same time it is unlikely that Redis Cluster would scale to more than 1000 mater nodes because of other design tradeoffs.</li>
</ol>
<p>So 16k was in the right range to ensure enough slots per master with a max of 1000 maters, but a small enough number to propagate the slot configuration as a raw bitmap easily. Note that in small clusters the bitmap would be hard to compress because when N is small the bitmap would have slots&#x2F;N bits set that is a large percentage of bits set.</p>
<br>

<p>正常心跳包携带节点的完整配置，可以用旧配置以幂等的方式替换，以便更新旧配置。这意味着它们包含原始形式的节点插槽配置，该配置使用2k空间和16k插槽，但使用65k插槽时会使用禁止性的8k空间。<br>同时，由于其他设计上的权衡，Redis集群不太可能扩展到超过1000个主节点。<br>因此，16k是在正确的范围内，以确保每个主机有足够的插槽，最多1000个maters，但这个数字足够小，可以轻松地将插槽配置作为原始位图进行传播。注意，在小集群中，位图将很难压缩，因为当N较小时，位图将具有 slot &#x2F; N 位集 占设置为的很大百分比</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312194505703.png"
                      alt="image-20230312194505703" style="zoom:50%;" 
                >

<br>

<h6 id="1-如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大"><a href="#1-如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大" class="headerlink" title="(1 )如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大"></a>(1 )如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大</h6><p>在消息头中最占空间的是myslots[CLUSTER_SLOTS&#x2F;8]。 当槽位为65536时，这块的大小是: 65536÷8÷1024&#x3D;8kb </p>
<p>在消息头中最占空间的是myslots[CLUSTER_SLOTS&#x2F;8]。 当槽位为16384时，这块的大小是: 16384÷8÷1024&#x3D;2kb </p>
<p>因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。</p>
 <br>

<h6 id="2-redis的集群主节点数量基本不可能超过1000个"><a href="#2-redis的集群主节点数量基本不可能超过1000个" class="headerlink" title="(2) redis的集群主节点数量基本不可能超过1000个"></a>(2) redis的集群主节点数量基本不可能超过1000个</h6><p>集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。因此redis作者不建议redis cluster节点数量超过1000个。 那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。</p>
<br>

<h6 id="3-槽位越小，节点少的情况下，压缩比高，容易传输"><a href="#3-槽位越小，节点少的情况下，压缩比高，容易传输" class="headerlink" title="(3) 槽位越小，节点少的情况下，压缩比高，容易传输"></a>(3) 槽位越小，节点少的情况下，压缩比高，容易传输</h6><p>Redis主节点的配置信息中它所负责的哈希槽是通过一张bitmap的形式来保存的，在传输过程中会对bitmap进行压缩，但是如果bitmap的填充率slots &#x2F; N很高的话(N表示节点数)，bitmap的压缩率就很低。 如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。 </p>
<h5 id="计算结论"><a href="#计算结论" class="headerlink" title="计算结论"></a>计算结论</h5><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312194650243.png"
                      alt="image-20230312194650243" style="zoom:67%;" 
                >



<h4 id="write-safety"><a href="#write-safety" class="headerlink" title="write safety"></a>write safety</h4><p>Redis Cluster uses asynchronous replication between nodes, and <strong>last failover wins</strong> implicit merge function. This means that the last elected master dataset eventually replaces all the other replicas. There is always a window of time when it is possible to lose writes during partitions. However these windows are very different in the case of a client that is connected to the majority of masters, and a client that is connected to the minority of masters.</p>
<p>Redis集群使用节点间异步复制，最后一次故障转移赢得隐式合并功能。这意味着最后选择的主数据集最终会替换所有其他副本。在分区期间，总有一个时间窗口可能会丢失写入。然而，在一个客户端连接到大多数主机，一个客户端连接到少数主机的情况下，这些窗口是非常不同的。</p>
<br>

<blockquote>
<p>redis 集群**<font color='red'>不保证强一致性</font>**，这意味着在特定的条件下，redis 集群可能会丢掉一些被系统收到的写入请求命令</p>
</blockquote>
<h4 id="集群环境案例步骤"><a href="#集群环境案例步骤" class="headerlink" title="集群环境案例步骤"></a>集群环境案例步骤</h4><h5 id="三主三从-redis-集群配置"><a href="#三主三从-redis-集群配置" class="headerlink" title="三主三从 redis 集群配置"></a>三主三从 redis 集群配置</h5><ul>
<li><p>找三台真是虚拟机，各自新建</p>
<ul>
<li><code>mkdir -p /opt/myredis/cluster</code></li>
</ul>
</li>
<li><p>新建 6 个独立的redis 实例服务</p>
<ul>
<li><p>IP ： 192.168.21.129 + 端口6381 &#x2F; 6382</p>
<ul>
<li><p><code>vim /opt/myredis/cluster/redisCluster6381.conf</code></p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 6381</span><br><span class="line">logfile &quot;/myredis/cluster/cluster6381.log&quot;</span><br><span class="line">pidfile /myredis/cluster6381.pid</span><br><span class="line">dir /myredis/cluster</span><br><span class="line">dbfilename dump6381.rdb</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly6381.aof&quot;</span><br><span class="line">requirepass 111111</span><br><span class="line">masterauth 111111</span><br><span class="line"> </span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6381.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure></div>


</li>
<li><p><code>vim /opt/myredis/cluster/redisCluster6382.conf</code></p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 6382</span><br><span class="line">logfile &quot;/myredis/cluster/cluster6382.log&quot;</span><br><span class="line">pidfile /myredis/cluster6382.pid</span><br><span class="line">dir /myredis/cluster</span><br><span class="line">dbfilename dump6382.rdb</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly6382.aof&quot;</span><br><span class="line">requirepass 111111</span><br><span class="line">masterauth 111111</span><br><span class="line"> </span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6382.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
<li><p>IP ： 192.168.21.xx + 端口6383 &#x2F; 6384</p>
<ul>
<li><p><code>vim /opt/myredis/cluster/redisCluster6383.conf</code></p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 6383</span><br><span class="line">logfile &quot;/myredis/cluster/cluster6383.log&quot;</span><br><span class="line">pidfile /myredis/cluster6383.pid</span><br><span class="line">dir /myredis/cluster</span><br><span class="line">dbfilename dump6383.rdb</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly6383.aof&quot;</span><br><span class="line">requirepass 111111</span><br><span class="line">masterauth 111111</span><br><span class="line"></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6383.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure></div>


</li>
<li><p><code>vim /opt/myredis/cluster/redisCluster6384.conf</code></p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 6384</span><br><span class="line">logfile &quot;/myredis/cluster/cluster6384.log&quot;</span><br><span class="line">pidfile /myredis/cluster6384.pid</span><br><span class="line">dir /myredis/cluster</span><br><span class="line">dbfilename dump6384.rdb</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly6384.aof&quot;</span><br><span class="line">requirepass 111111</span><br><span class="line">masterauth 111111</span><br><span class="line"> </span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6384.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
<li><p>IP ： 192.168.21.xx + 端口6385 &#x2F; 6386</p>
<ul>
<li><p><code>vim /opt/myredis/cluster/redisCluster6385.conf</code></p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 6385</span><br><span class="line">logfile &quot;/myredis/cluster/cluster6385.log&quot;</span><br><span class="line">pidfile /myredis/cluster6385.pid</span><br><span class="line">dir /myredis/cluster</span><br><span class="line">dbfilename dump6385.rdb</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly6385.aof&quot;</span><br><span class="line">requirepass 111111</span><br><span class="line">masterauth 111111</span><br><span class="line"> </span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6385.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure></div>


</li>
<li><p><code>vim /opt/myredis/cluster/redisCluster6386.conf</code></p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">daemonize yes</span><br><span class="line">protected-mode no</span><br><span class="line">port 6386</span><br><span class="line">logfile &quot;/myredis/cluster/cluster6386.log&quot;</span><br><span class="line">pidfile /myredis/cluster6386.pid</span><br><span class="line">dir /myredis/cluster</span><br><span class="line">dbfilename dump6386.rdb</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly6386.aof&quot;</span><br><span class="line">requirepass 111111</span><br><span class="line">masterauth 111111</span><br><span class="line"> </span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6386.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
<li><p>启动 6 台 redis 实例</p>
<ul>
<li><code>redis-server /opt/myredis/cluster/redisCluster6381.conf</code></li>
</ul>
</li>
</ul>
</li>
<li><p>通过 redis-cli 命令为 6台机器构建集群关系</p>
<ul>
<li><p>构建主从关系</p>
<ul>
<li><p><code>redis-cli -a 111111 --cluster create --cluster-replicas 1 192.168.111.175:6381 192.168.111.175:6382 192.168.111.172:6383 192.168.111.172:6384 192.168.111.174:6385 192.168.111.174:6386</code></p>
<p><strong><font color='red'>注意主机 IP</font></strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312200234000.png"
                      alt="image-20230312200234000" style="zoom:80%;" 
                >
</li>
<li><p>一切 OK </p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312200305092.png"
                      alt="image-20230312200305092" style="zoom:33%;" 
                ></li>
</ul>
</li>
</ul>
</li>
<li><p>连接进入 6381 作为切入点， <strong><font color='red'>查看并检验集群状态</font></strong></p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312200411648.png"
                      alt="image-20230312200411648" style="zoom:50%;" 
                >
</li>
<li><p><code>info replication</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312200522988.png"
                      alt="image-20230312200522988" style="zoom:50%;" 
                >
</li>
<li><p><code>cluster info</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312200451847.png"
                      alt="image-20230312200451847" style="zoom:50%;" 
                >
</li>
<li><p><code>cluster nodes</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312200509463.png"
                      alt="image-20230312200509463"
                ></p>
</li>
</ul>
</li>
</ul>
<h5 id="主从容错切换迁移案例"><a href="#主从容错切换迁移案例" class="headerlink" title="主从容错切换迁移案例"></a>主从容错切换迁移案例</h5><ul>
<li><p>容错切换转移</p>
<ul>
<li><p>主 6381 和 从机切换，先停止主机 6381</p>
<ul>
<li>6381 停了，对应的真实主机上位</li>
<li>6381 作为 1 号主机分配的从机以实际情况为准，具体是几号机器就是几号机器</li>
</ul>
</li>
<li><p>在此查看集群信息，本次 6381 主 和 6384从</p>
<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312201901933.png"
                      alt="image-20230312201901933"
                ></li>
</ul>
</li>
<li><p>停止主机 6381，再次查看集群信息</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312202010598.png"
                      alt="image-20230312202010598"
                ></p>
<ul>
<li><p>6384 成功上位并正常使用</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312202046706.png"
                      alt="image-20230312202046706" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>随后，原来的主机 6381 回来了，是否会上位</p>
<ul>
<li><p>恢复前</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312202215337.png"
                      alt="image-20230312202215337" style="zoom:50%;" 
                >
</li>
<li><p>恢复后</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312202232708.png"
                      alt="image-20230312202232708"
                ></p>
</li>
<li><p>6381  不会上位，并以节点形式回归</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>集群不保证数据一致性 100 %OK，一定会有数据丢失情况</p>
<ul>
<li>redis 集群不保证强一致性，这意味着在特定的条件下，redis 集群可能会丢掉一些被系统收到的写入请求命令</li>
</ul>
</li>
<li><p>手动故障转移 or 节点从属调整该如何处理 </p>
<ul>
<li>上面 一换后 6381 和 6384 主从对调了，和原始不一样了，该怎么办</li>
<li>重新登陆 6381 机器</li>
<li>常用命令 <ul>
<li><strong><code>cluster failover</code></strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="主从扩容案例"><a href="#主从扩容案例" class="headerlink" title="主从扩容案例"></a>主从扩容案例</h5><ul>
<li><p>新增 6387 、6388 两个服务实例配置文件 + 新建后启动</p>
<ul>
<li>IP ： 192.168.21.129 + 端口 6387&#x2F;6388<ul>
<li><code>vim /opt/myredis/cluster/redisCluster6387.conf</code></li>
</ul>
</li>
</ul>
</li>
<li><p>启动 87&#x2F;88  两个实例，此时他们自己都是 master</p>
<ul>
<li><code>redis-server /opt/myredis/cluster/redisCluster6387.conf</code></li>
</ul>
</li>
<li><p>将新增的 6387 节点（空槽号） 作为 master 节点加入 原集群</p>
<ul>
<li><p>将新增的6387作为master节点加入原有集群</p>
<p>redis-cli -a 密码 –cluster add-node 自己实际IP地址:6387 自己实际IP地址:6381</p>
<p>6387 就是将要作为master新增节点</p>
<p>6381 就是原来集群节点里面的领路人，相当于6387拜拜6381的码头从而找到组织加入集群</p>
<div class="code-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a 密码 --cluster add-node 自己实际IP地址:6387 自己实际IP地址:6381</span><br><span class="line"></span><br><span class="line">redis-cli -a 111111  --cluster add-node 192.168.111.174:6387 192.168.111.175:6381</span><br></pre></td></tr></table></figure></div>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312215333163.png"
                      alt="image-20230312215333163" style="zoom:50%;" 
                >
</li>
<li><p>检查集群情况第一次</p>
<ul>
<li><p><code>redis-cli -a 密码 --cluster check 真实ip地址</code></p>
</li>
<li><p><code>redis-cli -a C020611. --cluster check 192.168.21.129:6381</code></p>
</li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312215514762.png"
                      alt="image-20230312215514762" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>重新分派槽号（<strong><font color='red'>reshard</font></strong>）</p>
<ul>
<li>命令 ： redis-cli -a 密码 –cluster reshard ip地址：port</li>
<li><code>redis-cli -a C020611. --cluster reshard 192.168.21.128:6381</code></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312215804154.png"
                      alt="image-20230312215804154" style="zoom: 50%;" 
                ></li>
</ul>
</li>
<li><p>检查集群第二次</p>
<ul>
<li><p><code>redis-cli -a C020611. --cluster check 192.168.21.129:6381</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312215915482.png"
                      alt="image-20230312215915482" style="zoom:50%;" 
                >
</li>
<li><p>槽号分派说明</p>
<p>为什么 6387 是3 个新的区间，以前的还是连续？</p>
<p>重新分配成本太高，所以前3家各自匀出来一部分。从6381&#x2F;6383&#x2F;6385三个旧节点分别匀出1364个坑位给新节点6387</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312220107441.png"
                      alt="image-20230312220107441" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>为主节点 6387 分配从节点 6388</p>
<ul>
<li><p>命令 ： redis-cli -a 密码 –cluster add-node ip:新 slave 端口 ip:新master 端口 –cluster-slave –cluster-master-id 新主机id</p>
<p><code>redis-cli -a C020611. --cluster add-node 192.168.21.129:6388 192.168.21.129:6387 --cluster-slave --cluster-master-id 4feb6a7ee0ed2b39ff86474cf4189ab2a554a40f  --------这个是6387的编号，按照自己实际情况 </code></p>
</li>
<li><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312220539864.png"
                      alt="image-20230312220539864"
                ></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>检查集群第三次</p>
<ul>
<li><p><code>redis-cli -a C020611. --cluster check 192.168.21.129:6381</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312220733255.png"
                      alt="image-20230312220733255" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
<h5 id="主从缩容案例"><a href="#主从缩容案例" class="headerlink" title="主从缩容案例"></a>主从缩容案例</h5><ul>
<li><p>目的：6387 和 88 下线</p>
</li>
<li><p>检查集群情况第一次，鲜活的从节点 6388 的节点 ID</p>
</li>
<li><p>从集群中将 4 号从节点 6388 删除</p>
<ul>
<li><p>命令：redis-cli -a 密码 –cluster del-node ip:从机端口 从机6388节点ID</p>
</li>
<li><p><code>redis-cli -a C020611. --cluster del-node 192.168.21.129:6387 218e7b8b4f81be54ff173e4776b4f4faaf7c13da </code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312221434481.png"
                      alt="image-20230312221434481"
                ></p>
</li>
<li><p><code>redis-cli -a C020611. --cluster check 192.168.21.129:6385</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312221521484.png"
                      alt="image-20230312221521484"
                ></p>
<p>剩 7 台</p>
</li>
</ul>
</li>
<li><p>将 6387 的槽号清空，重新分配，本例子将清出来的槽号都给 6381</p>
<ul>
<li><p><code>redis-cli -a C020611. --cluster reshard 192.168.21.129:6381</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312221615730.png"
                      alt="image-20230312221615730" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>检查集群第二次</p>
<ul>
<li><p><code>redis-cli -a C020611. --cluster check 192.168.21.129:6381</code></p>
<p>4096个槽位都指给6381，它变成了8192个槽位，相当于全部都给6381了，不然要输入3次，一锅端</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312221705690.png"
                      alt="image-20230312221705690" style="zoom:50%;" 
                ></li>
</ul>
</li>
<li><p>将 6387 删除</p>
<ul>
<li><p>命令 ： redis-cli -a 密码 –cluster del-node ip:端口 6387节点ID</p>
</li>
<li><p><code>redis-cli -a C020611. --cluster del-node 192.168.21.129:6387 4feb6a7ee0ed2b39ff86474cf4189ab2a554a40f  </code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312221824955.png"
                      alt="image-20230312221824955"
                ></p>
</li>
</ul>
</li>
<li><p>检查集群情况第三次，6387&#x2F;88 被彻底去除</p>
<ul>
<li><p><code>redis-cli -a C020611. --cluster check 192.168.21.129:6381</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312221928580.png"
                      alt="image-20230312221928580" style="zoom:50%;" 
                ></li>
</ul>
</li>
</ul>
<h4 id="集群常用命令和CRC16-算法分析"><a href="#集群常用命令和CRC16-算法分析" class="headerlink" title="集群常用命令和CRC16 算法分析"></a>集群常用命令和CRC16 算法分析</h4><h5 id="通识占位符"><a href="#通识占位符" class="headerlink" title="通识占位符"></a>通识占位符</h5><p>不在同一个 slot 槽位下的多键操作支持不好，通识占位符登场</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312222100122.png"
                      alt="image-20230312222100122" style="zoom:50%;" 
                >

<table>
<thead>
<tr>
<th>不在同一个slot槽位下的键值无法使用mset、mget等多键操作</th>
</tr>
</thead>
<tbody><tr>
<td>可以通过{}来定义同一个组的概念，使key中{}内相同内容的键值对放到一个slot槽位去，对照下图类似k1k2k3都映射为x，自然槽位一样</td>
</tr>
</tbody></table>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312222121424.png"
                      alt="image-20230312222121424" style="zoom:50%;" 
                >

<br>

<h5 id="CRC16-浅谈"><a href="#CRC16-浅谈" class="headerlink" title="CRC16 浅谈"></a>CRC16 浅谈</h5><p>redis 集群有 16384 个哈希槽，每个key 通过 CRC16 校验后对 16384 进行取模，来决定放置那个槽，集群的每个节点负责一部分 hash槽</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312222318281.png"
                      alt="image-20230312222318281" style="zoom:50%;" 
                >



<h5 id="常用命令-4"><a href="#常用命令-4" class="headerlink" title="常用命令"></a>常用命令</h5><ul>
<li><p>集群是否完整才能对外提供服务</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230312222410954.png"
                      alt="image-20230312222410954" style="zoom:50%;" 
                >

<br>

<table>
<thead>
<tr>
<th>默认YES，现在集群架构是3主3从的redis cluster由3个master平分16384个slot，每个master的小集群负责1&#x2F;3的slot，对应一部分数据。cluster-require-full-coverage： 默认值 yes , 即需要集群完整性，方可对外提供服务 通常情况，如果这3个小集群中，任何一个（1主1从）挂了，你这个集群对外可提供的数据只有2&#x2F;3了， 整个集群是不完整的， redis 默认在这种情况下，是不会对外提供服务的。</th>
</tr>
</thead>
<tbody><tr>
<td>如果你的诉求是，集群不完整的话也需要对外提供服务，需要将该参数设置为no ，这样的话你挂了的那个小集群是不行了，但是其他的小集群仍然可以对外提供服务。</td>
</tr>
</tbody></table>
<ul>
<li><code>cluster-require-full-coverage</code></li>
</ul>
</li>
<li><p><code>CLUSTER CONUTKEYSINSLOT 槽位数字编号</code></p>
<ul>
<li>1 ： 表示 该槽位被占用</li>
<li>0 ： 表示 该槽位没有被占用</li>
</ul>
</li>
<li><p><code>CLUSTER KEYSLOT 键名称</code></p>
<p>该键应该存在那个槽位上</p>
</li>
</ul>
<h3 id="Springboot-集成-redis"><a href="#Springboot-集成-redis" class="headerlink" title="Springboot 集成 redis"></a>Springboot 集成 redis</h3><hr>
<h4 id="总体概述"><a href="#总体概述" class="headerlink" title="总体概述"></a>总体概述</h4><p>jedis-lettuce-RedisTemplate 三者的联系</p>
<h4 id="本地-Java-连接-Redis-常见问题"><a href="#本地-Java-连接-Redis-常见问题" class="headerlink" title="本地 Java 连接 Redis 常见问题"></a>本地 Java 连接 Redis 常见问题</h4><ul>
<li>bind 配置请注释掉</li>
<li>保护模式设置为 no</li>
<li>Linux 系统的防火墙设置</li>
<li>redis 服务器的 IP 地址 和 密码是否正确</li>
<li>写访问的 redis 的服务器 和 auth 密码</li>
</ul>
<h4 id="集成-Jedis"><a href="#集成-Jedis" class="headerlink" title="集成 Jedis"></a>集成 Jedis</h4><h5 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h5><p>Jedis Client 是 Redis 官网推荐的一个面向 Java 客户端，库文件实现了对各类 API 进行 封装调用 </p>
<h5 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h5><h6 id="建-Module"><a href="#建-Module" class="headerlink" title="建 Module"></a>建 Module</h6><p>redis_study </p>
<h6 id="改-POM"><a href="#改-POM" class="headerlink" title="改 POM"></a>改 POM</h6><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.redis7<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redis7_study<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringBoot通用依赖模块--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jedis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--通用基础配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h6 id="写-YML"><a href="#写-YML" class="headerlink" title="写 YML"></a>写 YML</h6><div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=7777</span></span><br><span class="line"></span><br><span class="line"><span class="string">spring.application.name=redis7_study</span></span><br></pre></td></tr></table></figure></div>



<h6 id="业务类"><a href="#业务类" class="headerlink" title="业务类"></a>业务类</h6><p>入门案例</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cs7eric.jedis.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestJedis</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.21.129&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;C020611.&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;redis conn status:&#123;&#125;&quot;</span>,<span class="string">&quot;连接成功&quot;</span>);</span><br><span class="line">        log.info(jedis.ping());</span><br><span class="line">        jedis.set(<span class="string">&quot;k1222&quot;</span>,<span class="string">&quot;2222&quot;</span>);</span><br><span class="line">        log.info(jedis.get(<span class="string">&quot;k1222&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="集成-Lettuce"><a href="#集成-Lettuce" class="headerlink" title="集成 Lettuce"></a>集成 Lettuce</h4><h5 id="lettuce"><a href="#lettuce" class="headerlink" title="lettuce"></a>lettuce</h5><p>Lettuce是一个Redis的Java驱动包，Lettuce翻译为生菜，没错，就是吃的那种生菜，所以它的Logo长这样</p>
<h5 id="lettuce-和-jedis-的区别"><a href="#lettuce-和-jedis-的区别" class="headerlink" title="lettuce 和 jedis 的区别"></a>lettuce 和 jedis 的区别</h5><p>jedis和Lettuce都是Redis的客户端，它们都可以连接Redis服务器，<strong>但是在SpringBoot2.0之后默认都是使用的Lettuce这个客户端连接Redis服务器</strong>。因为当使用Jedis客户端连接Redis服务器的时候，每个线程都要拿自己创建的Jedis实例去连接Redis客户端，当有很多个线程的时候，不仅开销大需要反复的创建关闭一个Jedis连接，而且也是线程不安全的，一个线程通过Jedis实例更改Redis服务器中的数据之后会影响另一个线程；但是如果使用Lettuce这个客户端连接Redis服务器的时候，就不会出现上面的情况，<strong>Lettuce底层使用的是Netty</strong>,当有多个线程都需要连接Redis服务器的时候，可以保证只创建一个Lettuce连接，使所有的线程共享这一个Lettuce连接，这样可以减少创建关闭一个Lettuce连接时候的开销；而且这种方式也是线程安全的，不会出现一个线程通过Lettuce更改Redis服务器中的数据之后而影响另一个线程的情况；</p>
<h5 id="案例-6"><a href="#案例-6" class="headerlink" title="案例"></a>案例</h5><h6 id="pom"><a href="#pom" class="headerlink" title="pom"></a>pom</h6><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.redis7<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redis7_study<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringBoot通用依赖模块--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jedis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lettuce--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--通用基础配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h6 id="业务类-1"><a href="#业务类-1" class="headerlink" title="业务类"></a>业务类</h6><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.redis7.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.RedisClient;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.RedisFuture;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.RedisURI;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.SortArgs;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.api.StatefulRedisConnection;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.api.async.RedisAsyncCommands;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.api.sync.RedisCommands;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2022-11-17 17:05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LettuceDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//使用构建器 RedisURI.builder</span></span><br><span class="line">        <span class="type">RedisURI</span> <span class="variable">uri</span> <span class="operator">=</span> RedisURI.builder()</span><br><span class="line">                .redis(<span class="string">&quot;192.168.111.181&quot;</span>)</span><br><span class="line">                .withPort(<span class="number">6379</span>)</span><br><span class="line">                .withAuthentication(<span class="string">&quot;default&quot;</span>,<span class="string">&quot;111111&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//创建连接客户端</span></span><br><span class="line">        <span class="type">RedisClient</span> <span class="variable">client</span> <span class="operator">=</span> RedisClient.create(uri);</span><br><span class="line">        <span class="type">StatefulRedisConnection</span> <span class="variable">conn</span> <span class="operator">=</span> client.connect();</span><br><span class="line">        <span class="comment">//操作命令api</span></span><br><span class="line">        RedisCommands&lt;String,String&gt; commands = conn.sync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//keys</span></span><br><span class="line">        List&lt;String&gt; list = commands.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(String s : list) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;key:&#123;&#125;&quot;</span>,s);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//String</span></span><br><span class="line">    commands.set(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;1111&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> commands.get(<span class="string">&quot;k1&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;String s ===&quot;</span>+s1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//list</span></span><br><span class="line">    commands.lpush(<span class="string">&quot;myList2&quot;</span>, <span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v2&quot;</span>,<span class="string">&quot;v3&quot;</span>);</span><br><span class="line">    List&lt;String&gt; list2 = commands.lrange(<span class="string">&quot;myList2&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(String s : list2) &#123;</span><br><span class="line">     System.out.println(<span class="string">&quot;list ssss===&quot;</span>+s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//set</span></span><br><span class="line">    commands.sadd(<span class="string">&quot;mySet2&quot;</span>, <span class="string">&quot;v1&quot;</span>,<span class="string">&quot;v2&quot;</span>,<span class="string">&quot;v3&quot;</span>);</span><br><span class="line">    Set&lt;String&gt; set = commands.smembers(<span class="string">&quot;mySet2&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(String s : set) &#123;</span><br><span class="line">     System.out.println(<span class="string">&quot;set ssss===&quot;</span>+s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//hash</span></span><br><span class="line">    Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;138xxxxxxxx&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;k2&quot;</span>,<span class="string">&quot;atguigu&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;k3&quot;</span>,<span class="string">&quot;zzyybs@126.com&quot;</span>);<span class="comment">//课后有问题请给我发邮件</span></span><br><span class="line"></span><br><span class="line">    commands.hmset(<span class="string">&quot;myHash2&quot;</span>, map);</span><br><span class="line">    Map&lt;String,String&gt; retMap = commands.hgetall(<span class="string">&quot;myHash2&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(String k : retMap.keySet()) &#123;</span><br><span class="line">     System.out.println(<span class="string">&quot;hash  k=&quot;</span>+k+<span class="string">&quot; , v==&quot;</span>+retMap.get(k));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//zset</span></span><br><span class="line">    commands.zadd(<span class="string">&quot;myZset2&quot;</span>, <span class="number">100.0</span>,<span class="string">&quot;s1&quot;</span>,<span class="number">110.0</span>,<span class="string">&quot;s2&quot;</span>,<span class="number">90.0</span>,<span class="string">&quot;s3&quot;</span>);</span><br><span class="line">    List&lt;String&gt; list3 = commands.zrange(<span class="string">&quot;myZset2&quot;</span>,<span class="number">0</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">for</span>(String s : list3) &#123;</span><br><span class="line">     System.out.println(<span class="string">&quot;zset ssss===&quot;</span>+s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sort</span></span><br><span class="line">    <span class="type">SortArgs</span> <span class="variable">sortArgs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SortArgs</span>();</span><br><span class="line">    sortArgs.alpha();</span><br><span class="line">    sortArgs.desc();</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; list4 = commands.sort(<span class="string">&quot;myList2&quot;</span>,sortArgs);</span><br><span class="line">    <span class="keyword">for</span>(String s : list4) &#123;</span><br><span class="line">     System.out.println(<span class="string">&quot;sort ssss===&quot;</span>+s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭</span></span><br><span class="line">        conn.close();</span><br><span class="line">        client.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="集成-RedisTemplate-（推荐）"><a href="#集成-RedisTemplate-（推荐）" class="headerlink" title="集成 RedisTemplate （推荐）"></a>集成 RedisTemplate （推荐）</h4><h5 id="连接单机"><a href="#连接单机" class="headerlink" title="连接单机"></a>连接单机</h5><h6 id="module"><a href="#module" class="headerlink" title="module"></a>module</h6><p>redisTemplate</p>
<h6 id="pom-1"><a href="#pom-1" class="headerlink" title="pom"></a>pom</h6><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.redis7<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redis7_study<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringBoot通用依赖模块--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--jedis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lettuce--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringBoot与Redis整合依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--swagger2--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--通用基础配置junit/devtools/test/log4j/lombok/hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h6 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h6><div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=7777</span></span><br><span class="line"></span><br><span class="line"><span class="string">spring.application.name=redis7_study</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================logging=====================</span></span><br><span class="line"><span class="string">logging.level.root=info</span></span><br><span class="line"><span class="string">logging.level.com.atguigu.redis7=info</span></span><br><span class="line"><span class="string">logging.pattern.console=%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125;</span> [<span class="string">%thread</span>] <span class="string">%-5level</span> <span class="string">%logger-</span> <span class="string">%msg%n</span> </span><br><span class="line"></span><br><span class="line"><span class="string">logging.file.name=D:/mylogs2023/redis7_study.log</span></span><br><span class="line"><span class="string">logging.pattern.file=%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125;</span> [<span class="string">%thread</span>] <span class="string">%-5level</span> <span class="string">%logger-</span> <span class="string">%msg%n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================swagger=====================</span></span><br><span class="line"><span class="string">spring.swagger2.enabled=true</span></span><br><span class="line"><span class="comment">#在springboot2.6.X结合swagger2.9.X会提示documentationPluginsBootstrapper空指针异常，</span></span><br><span class="line"><span class="comment">#原因是在springboot2.6.X中将SpringMVC默认路径匹配策略从AntPathMatcher更改为PathPatternParser，</span></span><br><span class="line"><span class="comment"># 导致出错，解决办法是matching-strategy切换回之前ant_path_matcher</span></span><br><span class="line"><span class="string">spring.mvc.pathmatch.matching-strategy=ant_path_matcher</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================redis单机=====================</span></span><br><span class="line"><span class="string">spring.redis.database=0</span></span><br><span class="line"><span class="comment"># 修改为自己真实IP</span></span><br><span class="line"><span class="string">spring.redis.host=192.168.111.185</span></span><br><span class="line"><span class="string">spring.redis.port=6379</span></span><br><span class="line"><span class="string">spring.redis.password=111111</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-active=8</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-wait=-1ms</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-idle=8</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.min-idle=0</span></span><br></pre></td></tr></table></figure></div>



<h6 id="业务类-2"><a href="#业务类-2" class="headerlink" title="业务类"></a>业务类</h6><ul>
<li><p>配置类</p>
<ul>
<li><p>RedisConfig</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.redis7.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2022-11-17 17:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis序列化的工具配置类，下面这个请一定开启配置</span></span><br><span class="line"><span class="comment">     * 127.0.0.1:6379&gt; keys *</span></span><br><span class="line"><span class="comment">     * 1) &quot;ord:102&quot;  序列化过</span></span><br><span class="line"><span class="comment">     * 2) &quot;\xac\xed\x00\x05t\x00\aord:102&quot;   野生，没有序列化过</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForValue(); //提供了操作string类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForList(); // 提供了操作list类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForSet(); //提供了操作set的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForHash(); //提供了操作hash表的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForZSet(); //提供了操作zset的所有方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lettuceConnectionFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span></span><br><span class="line">    &#123;</span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        <span class="comment">//设置key序列化方式string</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value的序列化方式json，使用GenericJackson2JsonRedisSerializer替换默认序列化</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


</li>
<li><p>SwaggerConfig</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.redis7.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2022-11-17 17:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.swagger2.enabled&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean enabled;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .enable(enabled)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.atguigu.redis7&quot;</span>)) <span class="comment">//你自己的package</span></span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;springboot利用swagger2构建api接口文档 &quot;</span>+<span class="string">&quot;\t&quot;</span>+ DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>).format(LocalDateTime.now()))</span><br><span class="line">                .description(<span class="string">&quot;springboot+redis整合,有问题给管理员阳哥邮件:zzyybs@126.com&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .termsOfServiceUrl(<span class="string">&quot;https://www.atguigu.com/&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
<li><p>service</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.redis7.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2022-07-14 15:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ORDER_KEY</span> <span class="operator">=</span> <span class="string">&quot;order:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">keyId</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(<span class="number">1000</span>)+<span class="number">1</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        redisTemplate.opsForValue().set(ORDER_KEY+keyId,<span class="string">&quot;京东订单&quot;</span>+ orderNo);</span><br><span class="line">        log.info(<span class="string">&quot;=====&gt;编号&quot;</span>+keyId+<span class="string">&quot;的订单流水生成:&#123;&#125;&quot;</span>,orderNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrderById</span><span class="params">(Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (String)redisTemplate.opsForValue().get(ORDER_KEY + id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


</li>
<li><p>controller</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.redis7.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.redis7.service.OrderService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2022-07-14 15:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;订单接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;新增订单&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/order/add&quot;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        orderService.addOrder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;按orderId查订单信息&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/order/&#123;id&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> orderService.getOrderById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h6 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h6><ul>
<li>swagger<ul>
<li><a class="link"   target="_blank" rel="noopener" href="http://localhost:7777/swagger-ui.html#/" >http://localhost:7777/swagger-ui.html#/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
</li>
<li>序列化问题<ul>
<li>jdk 序列化方式（默认）惹的祸<ul>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230313232626661.png"
                      alt="image-20230313232626661" style="zoom:67%;" 
                ></li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="连接集群"><a href="#连接集群" class="headerlink" title="连接集群"></a>连接集群</h5><h6 id="启动-6-台redis-实例"><a href="#启动-6-台redis-实例" class="headerlink" title="启动 6 台redis 实例"></a>启动 6 台redis 实例</h6><h6 id="第一次-改写-yaml"><a href="#第一次-改写-yaml" class="headerlink" title="第一次 改写 yaml"></a>第一次 改写 yaml</h6><div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=7777</span></span><br><span class="line"></span><br><span class="line"><span class="string">spring.application.name=redis7_study</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================logging=====================</span></span><br><span class="line"><span class="string">logging.level.root=info</span></span><br><span class="line"><span class="string">logging.level.com.atguigu.redis7=info</span></span><br><span class="line"><span class="string">logging.pattern.console=%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125;</span> [<span class="string">%thread</span>] <span class="string">%-5level</span> <span class="string">%logger-</span> <span class="string">%msg%n</span> </span><br><span class="line"></span><br><span class="line"><span class="string">logging.file.name=D:/mylogs2023/redis7_study.log</span></span><br><span class="line"><span class="string">logging.pattern.file=%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125;</span> [<span class="string">%thread</span>] <span class="string">%-5level</span> <span class="string">%logger-</span> <span class="string">%msg%n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================swagger=====================</span></span><br><span class="line"><span class="string">spring.swagger2.enabled=true</span></span><br><span class="line"><span class="comment">#在springboot2.6.X结合swagger2.9.X会提示documentationPluginsBootstrapper空指针异常，</span></span><br><span class="line"><span class="comment">#原因是在springboot2.6.X中将SpringMVC默认路径匹配策略从AntPathMatcher更改为PathPatternParser，</span></span><br><span class="line"><span class="comment"># 导致出错，解决办法是matching-strategy切换回之前ant_path_matcher</span></span><br><span class="line"><span class="string">spring.mvc.pathmatch.matching-strategy=ant_path_matcher</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================redis集群=====================</span></span><br><span class="line"><span class="string">spring.redis.password=111111</span></span><br><span class="line"><span class="comment"># 获取失败 最大重定向次数</span></span><br><span class="line"><span class="string">spring.redis.cluster.max-redirects=3</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-active=8</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-wait=-1ms</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-idle=8</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.min-idle=0</span></span><br><span class="line"><span class="string">spring.redis.cluster.nodes=192.168.111.175:6381,192.168.111.175:6382,192.168.111.172:6383,192.168.111.172:6384,192.168.111.174:6385,192.168.111.174:6386</span></span><br></pre></td></tr></table></figure></div>



<h6 id="直接通过-微服务访问-redis-集群"><a href="#直接通过-微服务访问-redis-集群" class="headerlink" title="直接通过 微服务访问 redis 集群"></a>直接通过 微服务访问 redis 集群</h6><ul>
<li>一切 OK</li>
<li><a class="link"   target="_blank" rel="noopener" href="http://localhost:7777/swagger-ui.html#/" >http://localhost:7777/swagger-ui.html#/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<h6 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h6><ul>
<li><p>人为模拟，master-6381 机器意外宕机，手动 shutdown</p>
</li>
<li><p>先对 redis集群命令方式，手动验证各种读写命令，看看 6384 是否上位</p>
</li>
<li><p>redis cluster 集群能够自动感应并自动完成主备切换，对应的 slave 6384 会被选举为新的 master 节点</p>
</li>
<li><p><strong>微服务客户端再次读写访问</strong></p>
<ul>
<li><p>故障现象</p>
<ul>
<li><p>经典故障</p>
<p>【故障演练】 Redis Cluster集群部署采用了3主3从拓扑结构，数据读写访问master节点， slave节点负责备份。当master宕机主从切换成功，redis手动OK，but 2个经典故障</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230313233758364.png"
                      alt="image-20230313233758364"
                ></p>
</li>
<li><p><strong>Springboot 客户端没有动态感应到 redis cluster 的最新集群消息</strong></p>
</li>
</ul>
</li>
<li><p>导致原因</p>
<ul>
<li>springboot 2.x 版本，redis 默认的连接池采用 lettuce，当 redis 集群节点发生变化后，lettuce 默认是不会刷新节点拓扑的</li>
</ul>
</li>
<li><p>解决方案</p>
<ul>
<li><p>排除 lettuce 采用 jedis</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230313234108359.png"
                      alt="image-20230313234108359" style="zoom:50%;" 
                >
</li>
<li><p>重写 连接工厂实例（不采用）</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//仅做参考，不写，不写，不写。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DefaultClientResources <span class="title function_">lettuceClientResources</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> DefaultClientResources.create();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> LettuceConnectionFactory <span class="title function_">lettuceConnectionFactory</span><span class="params">(RedisProperties redisProperties, ClientResources clientResources)</span> &#123;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="type">ClusterTopologyRefreshOptions</span> <span class="variable">topologyRefreshOptions</span> <span class="operator">=</span> ClusterTopologyRefreshOptions.builder()</span><br><span class="line"></span><br><span class="line">            .enablePeriodicRefresh(Duration.ofSeconds(<span class="number">30</span>)) <span class="comment">//按照周期刷新拓扑</span></span><br><span class="line"></span><br><span class="line">            .enableAllAdaptiveRefreshTriggers() <span class="comment">//根据事件刷新拓扑</span></span><br><span class="line"></span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="type">ClusterClientOptions</span> <span class="variable">clusterClientOptions</span> <span class="operator">=</span> ClusterClientOptions.builder()</span><br><span class="line"></span><br><span class="line">            <span class="comment">//redis命令超时时间,超时后才会使用新的拓扑信息重新建立连接</span></span><br><span class="line"></span><br><span class="line">            .timeoutOptions(TimeoutOptions.enabled(Duration.ofSeconds(<span class="number">10</span>)))</span><br><span class="line"></span><br><span class="line">            .topologyRefreshOptions(topologyRefreshOptions)</span><br><span class="line"></span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="type">LettuceClientConfiguration</span> <span class="variable">clientConfiguration</span> <span class="operator">=</span> LettuceClientConfiguration.builder()</span><br><span class="line"></span><br><span class="line">            .clientResources(clientResources)</span><br><span class="line"></span><br><span class="line">            .clientOptions(clusterClientOptions)</span><br><span class="line"></span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="type">RedisClusterConfiguration</span> <span class="variable">clusterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisClusterConfiguration</span>(redisProperties.getCluster().getNodes());</span><br><span class="line"></span><br><span class="line">    clusterConfig.setMaxRedirects(redisProperties.getCluster().getMaxRedirects());</span><br><span class="line"></span><br><span class="line">    clusterConfig.setPassword(RedisPassword.of(redisProperties.getPassword()));</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="type">LettuceConnectionFactory</span> <span class="variable">lettuceConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LettuceConnectionFactory</span>(clusterConfig, clientConfiguration);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lettuceConnectionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


</li>
<li><p>刷新节点集群拓扑动态感应</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://github.com/lettuce-io/lettuce-core/wiki/Redis-Cluster#user-content-refreshing-the-cluster-topology-view" >https://github.com/lettuce-io/lettuce-core/wiki/Redis-Cluster#user-content-refreshing-the-cluster-topology-view<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://cs7eric-image.oss-cn-hangzhou.aliyuncs.com/images/image-20230313234154012.png"
                      alt="image-20230313234154012" style="zoom:67%;" 
                ></li>
</ul>
</li>
</ul>
</li>
<li><p>第二次改写 yml</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=7777</span></span><br><span class="line"></span><br><span class="line"><span class="string">spring.application.name=redis7_study</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================logging=====================</span></span><br><span class="line"><span class="string">logging.level.root=info</span></span><br><span class="line"><span class="string">logging.level.com.atguigu.redis7=info</span></span><br><span class="line"><span class="string">logging.pattern.console=%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125;</span> [<span class="string">%thread</span>] <span class="string">%-5level</span> <span class="string">%logger-</span> <span class="string">%msg%n</span> </span><br><span class="line"></span><br><span class="line"><span class="string">logging.file.name=D:/mylogs2023/redis7_study.log</span></span><br><span class="line"><span class="string">logging.pattern.file=%d&#123;yyyy-MM-dd</span> <span class="string">HH:mm:ss.SSS&#125;</span> [<span class="string">%thread</span>] <span class="string">%-5level</span> <span class="string">%logger-</span> <span class="string">%msg%n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================swagger=====================</span></span><br><span class="line"><span class="string">spring.swagger2.enabled=true</span></span><br><span class="line"><span class="comment">#在springboot2.6.X结合swagger2.9.X会提示documentationPluginsBootstrapper空指针异常，</span></span><br><span class="line"><span class="comment">#原因是在springboot2.6.X中将SpringMVC默认路径匹配策略从AntPathMatcher更改为PathPatternParser，</span></span><br><span class="line"><span class="comment"># 导致出错，解决办法是matching-strategy切换回之前ant_path_matcher</span></span><br><span class="line"><span class="string">spring.mvc.pathmatch.matching-strategy=ant_path_matcher</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================redis集群=====================</span></span><br><span class="line"><span class="string">spring.redis.password=111111</span></span><br><span class="line"><span class="comment"># 获取失败 最大重定向次数</span></span><br><span class="line"><span class="string">spring.redis.cluster.max-redirects=3</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-active=8</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-wait=-1ms</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.max-idle=8</span></span><br><span class="line"><span class="string">spring.redis.lettuce.pool.min-idle=0</span></span><br><span class="line"><span class="comment">#支持集群拓扑动态感应刷新,自适应拓扑刷新是否使用所有可用的更新，默认false关闭</span></span><br><span class="line"><span class="string">spring.redis.lettuce.cluster.refresh.adaptive=true</span></span><br><span class="line"><span class="comment">#定时刷新</span></span><br><span class="line"><span class="string">spring.redis.lettuce.cluster.refresh.period=2000</span></span><br><span class="line"><span class="string">spring.redis.cluster.nodes=192.168.111.175:6381,192.168.111.175:6382,192.168.111.172:6383,192.168.111.172:6384,192.168.111.174:6385,192.168.111.174:6386</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
</ul>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Redis</li>
        <li><strong>Author:</strong> cccs7</li>
        <li><strong>Created at
                :</strong> 2023-02-12 17:30:22</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-09-13 11:07:59
            </li>
        
        <li>
            <strong>Link:</strong> https://cs7eric.github.io/2023/02/12/Redis/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/Java/">#Java</a>&nbsp;
			</li>
			
			<li class="tag-item mx-0.5">
				<a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">#中间件</a>&nbsp;
			</li>
			
			<li class="tag-item mx-0.5">
				<a href="/tags/Redis/">#Redis</a>&nbsp;
			</li>
			
			<li class="tag-item mx-0.5">
				<a href="/tags/NoSQL/">#NoSQL</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2023/02/27/Linux/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">Linux</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2023/01/10/SpringSecurity/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">SpringSecurity</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          reaction: false,
          requiredMeta: ['nick', 'mail'],
          emoji: [],
          
          
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Redis</div>
		<ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E4%BB%8B%E7%BB%8D"><span class="nav-text">Redis 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%B5%81%E5%8A%9F%E8%83%BD%E4%B8%8E%E5%BA%94%E7%94%A8"><span class="nav-text">主流功能与应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0"><span class="nav-text">总体功能概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8A%BF"><span class="nav-text">优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%96%99"><span class="nav-text">资料</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-%E4%BD%BF%E7%94%A8"><span class="nav-text">Redis 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E7%9A%84-10-%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">Redis 的 10 大数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%94%AE%EF%BC%88key%EF%BC%89"><span class="nav-text">Redis 键（key）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%91%BD%E4%BB%A4%E5%8F%8A%E8%90%BD%E5%9C%B0%E8%BF%90%E7%94%A8"><span class="nav-text">数据类型命令及落地运用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lset-key-index-value"><span class="nav-text">lset key index value</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%88RDB-AOF%EF%BC%89"><span class="nav-text">Redis 持久化（RDB + AOF）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E4%BA%8B%E5%8A%A1%EF%BC%88transactional%EF%BC%89"><span class="nav-text">Redis 事务（transactional）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E7%AE%A1%E9%81%93%EF%BC%88pipelining%EF%BC%89"><span class="nav-text">Redis 管道（pipelining）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%EF%BC%88pub-sub%EF%BC%89"><span class="nav-text">Redis 发布&#x2F;订阅（pub&#x2F;sub）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E5%A4%8D%E5%88%B6%EF%BC%88replication%EF%BC%89"><span class="nav-text">Redis 复制（replication）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E5%93%A8%E5%85%B5%EF%BC%88sentinel%EF%BC%89"><span class="nav-text">Redis 哨兵（sentinel）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%EF%BC%88cluster%EF%BC%89"><span class="nav-text">Redis 集群（cluster）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Springboot-%E9%9B%86%E6%88%90-redis"><span class="nav-text">Springboot 集成 redis</span></a></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">cccs7</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        71 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>








    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





	
</body>

</html>